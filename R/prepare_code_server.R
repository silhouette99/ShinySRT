#' server code prepared for shinyspatial
#'
#'
#' @param shiny.dir specify directory to create the shiny app in. Default is
#'   to create a new directory named "shinyspatial_app"
#'
#' lib_server : load package in ui scirpts
#'
#'
#'
#'
#' @return data files required for shiny app
#'
#'
#'
#' @export
## load package in server script
lib_server <- function() {
  lib <- glue::glue(
    'library(shiny)\n',
    'library(shinyhelper)\n',
    'library(data.table)\n',
    'library(Matrix)\n',
    'library(DT)\n',
    'library(magrittr)\n',
    'library(ggplot2)\n',
    'library(ggrepel)\n',
    'library(hdf5r)\n',
    'library(ggdendro)\n',
    'library(gridExtra)\n',
    'library(dplyr)\n',
    'library(scales)\n',
    'library(patchwork)\n',
    'library(RColorBrewer)\n',
    'library(Seurat)\n',
    'library(shinydashboard)\n',
    'library(maps)\n',
    'library(Cairo)\n',
    'library(dplyr)\n',
    'library(grid)\n',
    'library(ggtree)\n',
    'library(aplot)\n\n'
  )
  return(lib)
}
## plot color in server script
col_server <- function() {
  col <- glue::glue(
    'heat_col <- c(\"#0000FF\", \"#0013FF\", \"#0028FF\", \"#003CFF\", \"#0050FF\", \"#0065FF\", \"#0078FF\", \"#008DFF\", \"#00A1FF\", \"#00B5FF\",\n',
    '              \"#00CAFF\", \"#00DEFF\", \"#00F2FF\", \"#27FFD7\", \"#8CFF71\", \"#F1FF0D\", \"#FFEE00\", \"#FFDB00\", \"#FFC900\", \"#FFB700\",\n',
    '              \"#FFA500\", \"#FF9200\", \"#FF8000\", \"#FF6D00\", \"#FF5B00\", \"#FF4800\", \"#FF3600\", \"#FF2400\", \"#FF1200\", \"#FF0000\")\n',
    'col_box <-\n',
    '  c(\n',
    '    \'#ff3030\',\'#1e90ff\',\'#ffd700\',\'#ff6eb4\',\'#bf3eff\',\n',
    '    \'#c1ffc1\',\'#00ffff\',\'#ff1493\',\'#7fff00\',\'#ff0000\',\n',
    '    \'#0000ff\',\'#00ff00\',\'#ffc125\',\'#ffb5c5\',\'#9b30ff\',\n',
    '    \'#54ff9f\',\'#87ceff\',\'#ffaeb9\',\'#c0ff3e\',\'#ff4040\',\n',
    '    \'#836fff\',\'#00ff7f\',\'#ffff00\',\'#ff3e96\',\'#ff83fa\',\n',
    '    \'#9aff9a\',\'#4876ff\',\'#ff3e96\',\'#00f5ff\',\'#8b1a1a\',\n',
    '    \'#104e8b\',\'#008b00\',\'#8b7500\',\'#8b3a62\',\'#68228b\',\n',
    '    \'#698b69\',\'#008b8b\',\'#8b0a50\',\'#458b00\',\'#eedfcc\',\n',
    '    \'#76eec6\',\'#eec591\',\'#dbe9e9\',\'#8ee5ee\',\'#ee6a50\',\n',
    '    \'#eee8cd\',\'#eead0e\',\'#bcee68\',\'#ee7600\',\'#8deeee\',\n',
    '    \'#00b2ee\',\'#ee6363\',\'#eeeee0\',\'#eee685\',\'#b2dfee\',\n',
    '    \'#eedc82\',\'#ee00ee\',\'#ee30a7\',\'#006400\')\n\n'
  )
  return(col)
}
## load data in server script
data_server <- function() {
  dat <- glue::glue(
    'meta <- readRDS(\'meta.Rds\')\n',
    'meta_group <- readRDS(\'meta_group.Rds\')\n',
    'genesets <- readRDS(\'genesets.Rds\')\n',
    'df_select <- readRDS(\'df_select.Rds\')\n',
    'image <- readRDS(\'image.Rds\')\n',
    'data = \"data.h5\"\n',
    'meta$group <- NA\n\n\n'
  )
  return(dat)
}
## function in server script
fun_server <- function() {
  afun <-
    glue::glue(
      'br_add <- function(height, break_add = NULL) {{\n',
      '  if (base::is.null(break_add)) {{\n',
      '    x <- base::ceiling((height - 400) / 100)\n',
      '    out <- x * 5\n',
      '  }} else {{\n',
      '    out <- break_add\n',
      '  }}\n',
      '  return(out)\n',
      '}}\n',
      'checkShortcut <- function(shortcut, valid, cursor_pos = NA) {{\n',
      '  shortcut <- shortcut[1]\n',
      '  if (!base::is.null(shortcut)) {{\n',
      '    if (!base::is.null(shortcut) && !shortcut %in% valid) {{\n',
      '      shiny::req(FALSE)\n',
      '    }}\n',
      '    if (shortcut == \"d\" && base::is.null(cursor_pos)) {{\n',
      '      confuns::give_feedback(\n',
      '        msg = \"The cursor must be inside the reactive image to use shortcut \'d\'.\",\n',
      '        fdb.fn = \"stop\",\n',
      '        in.shiny = TRUE,\n',
      '        with.time = FALSE\n',
      '      )\n',
      '    }}\n',
      '  }}}}\n',
      '### circle plot\n',
      'polygon_select <- function(meta, polygon) {{\n',
      '  res <-\n',
      '    sp::point.in.polygon(\n',
      '      point.x = meta[,imagecol],\n',
      '      point.y = meta[,imagerow],\n',
      '      pol.x = polygon[,imagecol],\n',
      '      pol.y = polygon[,imagerow]\n',
      '    )\n',
      '  meta_df_sub <- meta[res %in% 1, ]\n',
      '  out <- meta_df_sub$sampleID\n',
      '  return(out)}}\n',
      '### spatial plot\n',
      'spatial_dimplot <- function(input_image,\n',
      '                            meta_slice,\n',
      '                            meta_group,\n',
      '                            col.by = NULL,\n',
      '                            pt.alpha = 0.7,\n',
      '                            pt_size = 1,\n',
      '                            stage_col = NULL,\n',
      '                            highlight = meta_slice$sampleID) {{\n',

      'if(!is.null(input_image)){{\n',
      '  xrange <- c(0, dim(input_image)[2])\n',
      '  yrange <- c(0, dim(input_image)[1])\n',
      '}}else{{\n',
      '  xrange <- c(0,max(meta_slice$imagecol) - min(meta_slice$imagecol))\n',
      '  yrange <- c(0,max(meta_slice$imagerow) - min(meta_slice$imagerow))\n',
      '}}\n',
      '  if (!is.null(col.by)) {{\n',
      '    if (!col.by %in% meta_group$group) {{\n',
      '      stop(\"Don\'t have the feature\")\n',
      '    }}\n',
      '  }} else{{\n',
      '    if (length(which(meta_group$group == \'seurat_clusters\')) == 1) {{\n',
      '      col.by = \'seurat_clusters\'\n',
      '    }} else{{\n',
      '      stop(\"Don\'t have the meta\")\n',
      '    }}\n',
      '  }}\n',
      '  if (col.by %in% meta_group[meta_group$info == T, group]) {{\n',
      '    lev <-\n',
      '      strsplit(meta_group[group == col.by, unit], split = \'\\\\|\')[[1]]\n',
      '    cols_level <-\n',
      '      strsplit(meta_group[group == col.by, color], split = \'\\\\|\')[[1]]\n',
      '    if (length(intersect(lev, unique(meta_slice[[col.by]]))) != length(lev)) {{\n',
      '      meta_slice[[col.by]] <- as.factor(meta_slice[[col.by]])\n',
      '    }} else{{\n',
      '      meta_slice[[col.by]] <- factor(meta_slice[[col.by]], levels = lev)\n',
      '    }}\n',
      '    if (length(cols_level) != length(levels(meta_slice[[col.by]]))) {{\n',
      '      cols_level <- col_box[1:length(levels(meta_slice[[col.by]]))]\n',
      '    }}\n',
      '    cols <- meta_slice[[col.by]]\n',
      '    levels(cols) <- cols_level\n',
      '    legend_cols <- levels(cols)\n',
      '  }} else{{\n',
      '    if (!is.null(stage_col)) {{\n',
      '      colors <- colorRampPalette(stage_col)(100)\n',
      '      legend_cols <- colorRampPalette(stage_col)(5)\n',
      '      cols <- colors[cut(meta_slice[[col.by]], breaks = 100)]\n',
      '    }} else{{\n',
      '      colors <- colorRampPalette(heat_col)(100)\n',
      '      legend_cols <- colorRampPalette(heat_col)(5)\n',
      '      cols <- colors[cut(meta_slice[[col.by]], breaks = 100)]\n',
      '    }}\n',
      '  }}\n',
      '  graphics::plot.new()\n',
      '  graphics::par(pty = \'s\',\n',
      '                mar = c(0, 0, 1, 0),\n',
      '                oma = c(0, 0, 1, 0))\n',
      '  graphics::plot(\n',
      '    x = meta_slice$imagecol,\n',
      '    y = meta_slice$imagerow,\n',
      '    col = ggplot2::alpha(\"white\",\n',
      '                         0),\n',
      '    xlab = NA_character_,\n',
      '    ylab = NA_character_,\n',
      '    axes = F,\n',
      '    xlim = unit(xrange, \'npc\'),\n',
      '    ylim = unit(yrange, \'npc\')\n',
      '  )\n',
      '  \n',
      'if(!is.null(input_image)){{\n',
      '  img <-\n',
      '    input_image %>% grDevices::as.raster() %>% magick::image_read()\n',
      '  graphics::rasterImage(\n',
      '    image = img,\n',
      '    xleft = xrange[1],\n',
      '    xright = xrange[2],\n',
      '    ybottom = yrange[1],\n',
      '    ytop = yrange[2]\n',
      '  )\n',
      '  whole_surface <- dim(input_image)[1] * dim(input_image)[2]\n',
      '}}else{{\n',
      '  whole_surface <- xrange[2] * yrange[2]\n',
      '}}\n',
      '  cropped_surface <- xrange[2] * yrange[2]\n',
      '  fct <- sqrt(whole_surface / cropped_surface)\n',
      '  pt_size <- pt_size * fct\n',
      '  \n',
      '  if (is.null(cols) |\n',
      '      length(which(!is.na(unique(meta_slice[[col.by]])))) < 1) {{\n',
      '    cols <- NA\n',
      '  }}\n',
      '  if (is.null(highlight) |\n',
      '      length(highlight) == 0 |\n',
      '      length(which(meta_slice$sampleID %in% highlight)) == 0) {{\n',
      '    cols <- NA\n',
      '  }} else if (length(which(highlight %in% meta_slice$sampleID)) >= nrow(meta_slice)) {{\n',
      '    cols <- cols\n',
      '  }} else{{\n',
      '    cols[-which(meta_slice$sampleID %in% highlight)] <- NA\n',
      '  }}\n',
      '  \n',
      'if(!is.null(input_image)){{\n',
      '  graphics::points(\n',
      '    x = meta_slice$imagecol,\n',
      '    y = meta_slice$imagerow,\n',
      '    pch = 19,\n',
      '    # cex = pt_size + pt_size * 0.1,\n',
      '    cex = unit(pt_size, \"npc\") * 0.7,\n',
      '    col = \'grey91\',\n',
      '    asp = 1\n',
      '  )\n',
      '}}\n',
      '  graphics::points(\n',
      '    x = meta_slice$imagecol,\n',
      '    y = meta_slice$imagerow,\n',
      '    pch = 19,\n',
      '    # cex = pt_size + pt_size * 0.1,\n',
      '    cex = unit(pt_size, \"npc\") * 0.7,\n',
      '    col = ggplot2::alpha(colour = cols,\n',
      '                         alpha = pt.alpha),\n',
      '    asp = 1\n',
      '  )\n',
      '  \n',
      '  if (is.factor(meta_slice[[col.by]])) {{\n',
      '    columns <- sqrt(length(levels(meta_slice[[col.by]]))) %>% ceiling()\n',
      '    rows <-\n',
      '      length(levels(meta_slice[[col.by]])) / columns %>% floor()\n',
      '    lgd <-\n',
      '      ComplexHeatmap::Legend(\n',
      '        labels = levels(meta_slice[[col.by]]),\n',
      '        title = col.by,\n',
      '        title_position = \'topcenter\',\n',
      '        direction = \'horizontal\',\n',
      '        legend_gp = gpar(fill = legend_cols),\n',
      '        legend_width = 0.5,\n',
      '        ncol = columns +  ceiling(columns / rows),\n',
      '        title_gp = gpar(fontsize = 15)\n',
      '      )\n',
      '    ComplexHeatmap::draw(lgd,\n',
      '                         y = unit(0.8, \"npc\"),\n',
      '                         just = c(\"center\", \"bottom\"))\n',
      '  }} else  {{\n',
      '    staps <-\n',
      '      seq(min(meta_slice[[col.by]]), max(meta_slice[[col.by]]), (max(meta_slice[[col.by]]) - min(meta_slice[[col.by]])) /\n',
      '            4)\n',
      '    # a <- cut(meta_slice[[col.by]], breaks = 5)\n',
      '    \n',
      '    # staps <- lapply(levels(staps), function(x){{\n',
      '    #   staps_ <- sapply(strsplit(x,split = \',\'), \'[[\',2)\n',
      '    #   staps_ <- gsub(a_,pattern = \']\',replacement = \'\')%>%as.numeric()\n',
      '    # }}) %>% unlist()\n',
      '    \n',
      '    col_fun <- circlize::colorRamp2(staps, colors = legend_cols)\n',
      '    \n',
      '    lgd <- ComplexHeatmap::Legend(\n',
      '      at = staps,\n',
      '      col_fun = col_fun,\n',
      '      title_position = \'topcenter\',\n',
      '      direction = \'horizontal\',\n',
      '      title = col.by,\n',
      '      title_gp = gpar(fontsize = 15)\n',
      '    )\n',
      '    \n',
      '    ComplexHeatmap::draw(lgd,\n',
      '                         y = unit(0.85, \"npc\"),\n',
      '                         just = c(\"center\", \"bottom\"))\n',
      '  }}\n',
      '}}\n',
      '# spatial feature\n',
      'spatial_feature <- function(input_image,\n',
      '                            meta_slice,\n',
      '                            genesets,\n',
      '                            meta_all,\n',
      '                            gene = NULL,\n',
      '                            cols = NULL,\n',
      '                            pt.alpha = 1,\n',
      '                            data,\n',
      '                            highlight = \'ALL\',\n',
      '                            pt_size = 1) {{\n',
      'if(!is.null(input_image)){{\n',
      '  xrange <- c(0, dim(input_image)[2])\n',
      '  yrange <- c(0, dim(input_image)[1])\n',
      '}}else{{\n',
      '  xrange <- c(0,max(meta_slice$imagecol) - min(meta_slice$imagecol))\n',
      '  yrange <- c(0,max(meta_slice$imagerow) - min(meta_slice$imagerow))\n',
      '}}\n',
      '  if(is.null(genesets) | is.null(names(genesets)) | !is.numeric(genesets)){{\n',
      '    stop(\'useless gene set\')\n',
      '  }}\n',
      '  if (is.null(gene)|length(which(names(genesets) == gene)) == 0) {{\n',
      '    stop(\"Don\'t have the gene\")\n',
      '  }}\n',
      '  \n',
      '  h5file <- H5File$new(data, mode = \"r\")\n',
      '  h5data <- h5file[[\'grp\']][[\'data\']]\n',
      '  meta_all$val <- h5data$read(args = list(genesets[gene], quote(expr=)))\n',
      '  meta_slice <- meta_all[meta_all$sampleID %in% meta_slice$sampleID]\n',
      '  h5file$close_all()\n',
      '  \n',
      '  if (!is.null(cols)) {{\n',
      '    colors <- colorRampPalette(cols)(100)\n',
      '    legend_cols <- colorRampPalette(cols)(5)\n',
      '    cols <- colors[cut(meta_slice$val, breaks = 100)]\n',
      '  }} else{{\n',
      '    colors <- colorRampPalette(heat_col)(100)\n',
      '    legend_cols <- colorRampPalette(heat_col)(5)\n',
      '    cols <- colors[cut(meta_slice$val, breaks = 100)]\n',
      '  }}\n',
      '  \n',
      '  if (length(intersect(highlight, meta_all$sampleID)) == 0) {{\n',
      '    highlight = \'All\'\n',
      '  }}\n',
      '  if (length(which(highlight == \'All\')) >= 1 |\n',
      '      length(which(meta_slice$sampleID %in% highlight)) == length(meta_slice$sampleID)) {{\n',
      '    cols = cols\n',
      '  }} else if (length(intersect(highlight, meta_slice$sampleID)) == 0) {{\n',
      '    cols <- NA\n',
      '  }} else{{\n',
      '    cols[-which(meta_slice$sampleID %in% highlight)] <- NA\n',
      '  }}\n',
      '  \n',
      '  graphics::plot.new()\n',
      '  graphics::par(pty = \'s\',\n',
      '                mar = c(0, 0, 1, 0),\n',
      '                oma = c(0, 0, 1, 0))\n',
      '  graphics::plot(\n',
      '    x = meta_slice$imagecol,\n',
      '    y = meta_slice$imagerow,\n',
      '    col = ggplot2::alpha(\"white\",\n',
      '                         0),\n',
      '    xlab = NA_character_,\n',
      '    ylab = NA_character_,\n',
      '    axes = F,\n',
      '    xlim = unit(xrange, \'npc\'),\n',
      '    ylim = unit(yrange, \'npc\')\n',
      '  )\n',
      '  \n',
      'if(!is.null(input_image)){{\n',
      '  img <-\n',
      '    input_image %>% grDevices::as.raster() %>% magick::image_read()\n',
      '  graphics::rasterImage(\n',
      '    image = img,\n',
      '    xleft = xrange[1],\n',
      '    xright = xrange[2],\n',
      '    ybottom = yrange[1],\n',
      '    ytop = yrange[2]\n',
      '  )\n',
      '  whole_surface <- dim(input_image)[1] * dim(input_image)[2]\n',
      '}}else{{\n',
      '  whole_surface <- xrange[2] * yrange[2]\n',
      '}}\n',
      '  cropped_surface <- xrange[2] * yrange[2]\n',
      '  fct <- sqrt(whole_surface / cropped_surface)\n',
      '  pt_size <- pt_size * fct\n',
      '  \n',
      'if(!is.null(input_image)){{\n',
      '  graphics::points(\n',
      '    x = meta_slice$imagecol,\n',
      '    y = meta_slice$imagerow,\n',
      '    pch = 19,\n',
      '    # cex = pt_size + pt_size * 0.1,\n',
      '    cex = unit(pt_size, \"npc\") * 0.7,\n',
      '    col = \'grey91\',\n',
      '    asp = 1\n',
      '  )\n',
      '}}\n',
      '  graphics::points(\n',
      '    x = meta_slice$imagecol,\n',
      '    y = meta_slice$imagerow,\n',
      '    pch = 19,\n',
      '    # cex = pt_size + pt_size * 0.1,\n',
      '    cex = unit(pt_size, \"npc\") * 0.7,\n',
      '    col = ggplot2::alpha(cols,\n',
      '                         alpha = pt.alpha),\n',
      '    asp = 1\n',
      '  )\n',
      '  \n',
      '  staps <-\n',
      '    seq(min(meta_all$val), max(meta_all$val), (max(meta_all$val) - min(meta_all$val)) /\n',
      '          4) %>% round(2)\n',
      '  \n',
      '  \n',
      '  if(length(unique(staps)) == 1){{\n',
      '    lgd <- ComplexHeatmap::Legend(\n',
      '      at = unique(meta_all$val), title = paste(gene,\'=\',unique(meta_all$val)), \n',
      '      legend_gp = gpar(fill = unique(cols)),grid_width = unit(8, \"mm\")\n',
      '    )\n',
      '  }}else{{\n',
      '    col_fun <- circlize::colorRamp2(staps, colors = legend_cols)\n',
      '    lgd <- ComplexHeatmap::Legend(\n',
      '      at = staps,\n',
      '      col_fun = col_fun,\n',
      '      title_position = \'topcenter\',\n',
      '      direction = \'horizontal\',\n',
      '      title = gene\n',
      '    )\n',
      '  }}\n',
      '  \n',
      '  \n',
      '  ComplexHeatmap::draw(lgd,\n',
      '                       y = unit(0.85, \"npc\"),\n',
      '                       just = c(\"center\", \"bottom\"))\n',
      '}}\n\n',
      '# spatial highlight\n',
      'spatial_high_select<- function(input_image,\n',
      '                               meta_slice,\n',
      '                               pt.alpha = 1,\n',
      '                               pt_size = 1) {{\n',
      'if(!is.null(input_image)){{\n',
      '  xrange <- c(0, dim(input_image)[2])\n',
      '  yrange <- c(0, dim(input_image)[1])\n',
      '}}else{{\n',
      '  xrange <- c(0,max(meta_slice$imagecol) - min(meta_slice$imagecol))\n',
      '  yrange <- c(0,max(meta_slice$imagerow) - min(meta_slice$imagerow))\n',
      '}}\n',
      '  if (length(intersect(\'group\', colnames(meta_slice))) < 1) {{\n',
      '    stop(\'Do not have highlight column!\')\n',
      '  }}\n',
      '  if (length(which(!is.na(unique(meta_slice$group)))) < 1) {{\n',
      '    cols <- NA\n',
      '    if (length(levels(meta_slice$group)) > 0) {{\n',
      '      col_legend <- col_box[1:length(levels(meta_slice$group))]\n',
      '    }} else{{\n',
      '      col_legend <- NULL\n',
      '    }}\n',
      '  }} else{{\n',
      '    cols <- meta_slice$group\n',
      '    levels(cols) <- col_box[1:length(levels(cols))]\n',
      '    \n',
      '    col_legend <- levels(cols)\n',
      '  }}\n',
      '  graphics::plot.new()\n',
      '  graphics::par(pty = \'s\',\n',
      '                mar = c(0, 0, 1, 0),\n',
      '                oma = c(0, 0, 1, 0))\n',
      '  graphics::plot(\n',
      '    x = meta_slice$imagecol,\n',
      '    y = meta_slice$imagerow,\n',
      '    col = ggplot2::alpha(\"white\",\n',
      '                         0),\n',
      '    xlab = NA_character_,\n',
      '    ylab = NA_character_,\n',
      '    axes = F,\n',
      '    xlim = unit(xrange, \'npc\'),\n',
      '    ylim = unit(yrange, \'npc\')\n',
      '  )\n',
      '  \n',
      'if(!is.null(input_image)){{\n',
      '  img <-\n',
      '    input_image %>% grDevices::as.raster() %>% magick::image_read()\n',
      '  graphics::rasterImage(\n',
      '    image = img,\n',
      '    xleft = xrange[1],\n',
      '    xright = xrange[2],\n',
      '    ybottom = yrange[1],\n',
      '    ytop = yrange[2]\n',
      '  )\n',
      '  whole_surface <- dim(input_image)[1] * dim(input_image)[2]\n',
      '}}else{{\n',
      '  whole_surface <- xrange[2] * yrange[2]\n',
      '}}\n',
      '  cropped_surface <- xrange[2] * yrange[2]\n',
      '  fct <- sqrt(whole_surface / cropped_surface)\n',
      '  pt_size <- pt_size * fct\n',
      '  \n',
      'if(!is.null(input_image)){{\n',
      '  graphics::points(\n',
      '    x = meta_slice$imagecol,\n',
      '    y = meta_slice$imagerow,\n',
      '    pch = 19,\n',
      '    # cex = pt_size + pt_size * 0.1,\n',
      '    cex = unit(pt_size, \"npc\") * 0.7,\n',
      '    col = ggplot2::alpha(colour = \'grey91\',\n',
      '                         alpha = 0.5),\n',
      '    asp = 1\n',
      '  )\n',
      '}}\n',
      '  graphics::points(\n',
      '    x = meta_slice$imagecol,\n',
      '    y = meta_slice$imagerow,\n',
      '    pch = 19,\n',
      '    # cex = pt_size + pt_size * 0.1,\n',
      '    cex = unit(pt_size, \"npc\") * 0.7,\n',
      '    col = ggplot2::alpha(colour = cols,\n',
      '                         alpha = pt.alpha),\n',
      '    asp = 1\n',
      '  )\n',
      '  \n',
      '  if (!is.null(col_legend)) {{\n',
      '    columns <- sqrt(length(levels(meta_slice[[\'group\']]))) %>% ceiling()\n',
      '    rows <-\n',
      '      length(levels(meta_slice[[\'group\']])) / columns %>% floor()\n',
      '    \n',
      '    lgd <-\n',
      '      ComplexHeatmap::Legend(\n',
      '        labels = levels(meta_slice[[\'group\']]),\n',
      '        title = \'new group\',\n',
      '        title_position = \'topcenter\',\n',
      '        direction = \'horizontal\',\n',
      '        legend_gp = gpar(fill = col_legend),\n',
      '        legend_width = 0.5,\n',
      '        ncol = columns +  ceiling(columns / rows),\n',
      '        title_gp = gpar(fontsize = 15)\n',
      '      )\n',
      '    ComplexHeatmap::draw(lgd,\n',
      '                         y = unit(0.8, \"npc\"),\n',
      '                         just = c(\"center\", \"bottom\"))\n',
      '  }}\n',
      '}}\n',
      '### vio/box\n',
      'outvbplot <- function(\n',
      '    x,\n',
      '    y,\n',
      '    meta_group,\n',
      '    meta,\n',
      '    data,\n',
      '    genesets,\n',
      '    groupby = \'No\',\n',
      '    plot_type = \'violin\',\n',
      '    hgroup = NULL,\n',
      '    hcluster = NULL,\n',
      '    pt_p = FALSE) {{\n',
      '  if (groupby == \'No\') {{\n',
      '    groups = NULL\n',
      '    cols <-\n',
      '      strsplit(meta_group[which(meta_group$group == x), color], split = \"\\\\|\") %>% unlist()\n',
      '    clu <-\n',
      '      strsplit(meta_group[which(meta_group$group == x), unit], split = \"\\\\|\") %>% unlist()\n',
      '    \n',
      '    names(cols) <- clu\n',
      '  }} else{{\n',
      '    cols <-\n',
      '      strsplit(meta_group[which(meta_group$group == groupby), color], split = \"\\\\|\") %>% unlist()\n',
      '    clu <-\n',
      '      strsplit(meta_group[which(meta_group$group == groupby), unit], split = \"\\\\|\") %>% unlist()\n',
      '    groups = groupby\n',
      '  }}\n',
      '  \n',
      '  if (length(which(names(genesets) == y)) >= 1) {{\n',
      '    h5file <- H5File$new(data, mode = \"r\")\n',
      '    h5data <- h5file[[\'grp\']][[\'data\']]\n',
      '    val <- h5data$read(args = list(genesets[y], quote(expr=)))\n',
      '    meta[, y] <- val\n',
      '    h5file$close_all()\n',
      '  }}\n',
      '  if (!is.null(hgroup) |\n',
      '      length(intersect(meta_group$group, hgroup)) == 1) {{\n',
      '    if (!is.null(hcluster) &\n',
      '        length(intersect(unique(hcluster), unique(meta[[hgroup]]))) > 0) {{\n',
      '      meta <- meta[meta[[hgroup]]%in%unique(hcluster)]\n',
      '    }}\n',
      '  }}\n',
      '  tab_vb_plot(\n',
      '    tab_meta = meta,\n',
      '    x = x,\n',
      '    y = y,\n',
      '    group = groups,\n',
      '    plot = plot_type,\n',
      '    pt = pt_p\n',
      '  )\n',
      '}}\n',


      'tab_vb_plot <- function(tab_meta,\n',
      '                        x,\n',
      '                        y,\n',
      '                        group = NULL,\n',
      '                        plot = \'violin\',\n',
      '                        cols = NULL,\n',
      '                        pt = FALSE) {{\n',
      '  if (is.null(group) | length(which(x == group)) >= 1) {{\n',
      '    if (!is.factor(tab_meta[[x]])) {{\n',
      '      tab_meta[[x]] <- as.factor(tab_meta[[x]])\n',
      '    }}\n',
      '    \n',
      '    if (is.null(cols)) {{\n',
      '      cols <- col_box[1:length(levels(tab_meta[[x]]))]\n',
      '      names(cols) <- levels(tab_meta[[x]])\n',
      '    }}\n',
      '    \n',
      '    tab_meta <- tab_meta[,c(colnames(tab_meta) %in% c(x,y)),with = F]\n',
      '    colnames(tab_meta)[which(colnames(tab_meta) %in% c(x, y))] <-\n',
      '      c(\'X\', \'Y\')\n',
      '    if (plot == \'violin\') {{\n',
      '      p <-\n',
      '        ggplot(tab_meta, aes(x = X, y = Y, fill = X)) +\n',
      '        geom_violin(scale = \"width\") +\n',
      '        theme(\n',
      '          axis.text = element_text(size = 24),\n',
      '          panel.background = element_rect(fill = \"white\", colour = NA),\n',
      '          axis.title = element_text(size = 24, face = \'bold\'),title = element_text(size = 24, face = \'bold\'),\n',
      '          axis.text.x = element_text(\n',
      '            angle = 45,\n',
      '            hjust = 1,\n',
      '            vjust = 1\n',
      '          ),\n',
      '          legend.position = \'top\'\n',
      '        ) +\n',
      '        scale_fill_manual(values = cols) + NoLegend()\n',
      '    }} else{{\n',
      '      p <-\n',
      '        ggplot(tab_meta, aes(x = X, y = Y, fill = X)) +\n',
      '        geom_boxplot() +\n',
      '        theme(\n',
      '          axis.text = element_text(size = 24),\n',
      '          panel.background = element_rect(fill = \"white\", colour = NA),\n',
      '          axis.title = element_text(size = 24, face = \'bold\'),title = element_text(size = 24, face = \'bold\'),\n',
      '          axis.text.x = element_text(\n',
      '            angle = 45,\n',
      '            hjust = 1,\n',
      '            vjust = 1\n',
      '          ),\n',
      '          legend.position = \'top\'\n',
      '        ) +\n',
      '        scale_fill_manual(values = cols) + NoLegend()\n',
      '    }}\n',
      '    \n',
      '  }} else if (length(which(colnames(tab_meta) == group)) == 0) {{\n',
      '    stop(\'with out {{group}}\')\n',
      '  }} else{{\n',
      '    if (!is.factor(tab_meta[[group]])) {{\n',
      '      tab_meta[[group]] <- as.factor(tab_meta[[group]])\n',
      '    }}\n',
      '    \n',
      '    if (is.null(cols)) {{\n',
      '      cols <- col_box[1:length(levels(tab_meta[[group]]))]\n',
      '      names(cols) <- levels(tab_meta[[group]])\n',
      '    }}\n',
      '    \n',
      '    tab_meta <- tab_meta[,c(x, y, group),with = F]\n',
      '    colnames(tab_meta)[which(colnames(tab_meta) %in% c(x, y, group))] <-\n',
      '      c(\'X\', \'Y\', \'group\')\n',
      '    \n',
      '    if (plot == \'violin\') {{\n',
      '      p <-\n',
      '        ggplot(tab_meta, aes(X, Y, fill = group)) + geom_violin(scale = \"width\") +\n',
      '        theme(\n',
      '          axis.text = element_text(size = 24),\n',
      '          panel.background = element_rect(fill = \"white\", colour = NA),\n',
      '          axis.title = element_text(size = 24, face = \'bold\'),title = element_text(size = 24, face = \'bold\'),\n',
      '          axis.text.x = element_text(\n',
      '            angle = 45,\n',
      '            hjust = 1,\n',
      '            vjust = 1\n',
      '          ),\n',
      '          legend.position = \'top\'\n',
      '        ) + scale_fill_manual(values = cols) + guides(fill = guide_legend(title = group))\n',
      '    }} else{{\n',
      '      p <-\n',
      '        ggplot(tab_meta, aes(X, Y, fill = group)) + geom_boxplot() +\n',
      '        theme(\n',
      '          panel.background = element_rect(fill = \"white\", colour = NA),\n',
      '          axis.text = element_text(size = 24),\n',
      '          axis.title = element_text(size = 24, face = \'bold\'),title = element_text(size = 24, face = \'bold\'),\n',
      '          axis.text.x = element_text(\n',
      '            angle = 45,\n',
      '            hjust = 1,\n',
      '            vjust = 1\n',
      '          ),\n',
      '          legend.position = \'top\'\n',
      '        ) + scale_fill_manual(values = cols) + guides(fill = guide_legend(title = group))\n',
      '    }}\n',
      '  }}\n',
      '  \n',
      '  if (pt) {{\n',
      '    if (is.null(group) | length(which(x == group)) >= 1) {{\n',
      '      p <-\n',
      '        p + geom_point(\n',
      '          shape = 16,\n',
      '          mapping = aes(x = X, y = Y),\n',
      '          position = position_jitter()\n',
      '        )\n',
      '    }} else{{\n',
      '      p <- p + geom_point(\n',
      '        shape = 16,\n',
      '        mapping = aes(x = X, y = Y),\n',
      '        position = position_jitterdodge()\n',
      '      )\n',
      '    }}\n',
      '  }}\n',
      '  p + xlab(x) + ylab(\'gene expression\') + labs(title = y)\n',
      '}}\n',
      '### barplot\n',
      'tab_bar_plot <- function(tab_meta,\n',
      '                         x,\n',
      '                         col_by,\n',
      '                         xyflip = FALSE,\n',
      '                         value = \'percentage\',\n',
      '                         cols = NULL) {{\n',
      '  tab_meta <- tab_meta[,c(x,col_by),with = F]\n',
      '  \n',
      '  colnames(tab_meta) <- c(\'x\',\'col_by\')\n',
      '  if (!is.factor(tab_meta$col_by)) {{\n',
      '    tab_meta$col_by <- as.factor(tab_meta$col_by)\n',
      '  }}\n',
      '  if (is.null(cols)) {{\n',
      '    cols <- col_box[1:length(levels(tab_meta$col_by))]\n',
      '    names(cols) <- levels(tab_meta$col_by)\n',
      '  }}\n',
      '  \n',
      '  df <- tab_meta %>% group_by(x, col_by) %>%\n',
      '    mutate(num = n()) %>% ungroup() %>% select(x, col_by, num) %>% unique() %>%\n',
      '    group_by(x) %>% mutate(pct = 100 * num / sum(num))\n',
      '  \n',
      '  if (value == \'percentage\') {{\n',
      '    p <- ggplot(df, mapping = aes(x = x, y = pct)) +\n',
      '      geom_col(mapping = aes(fill = col_by), width = 0.8) +\n',
      '      theme(\n',
      '        panel.background = element_rect(fill = \"white\", colour = NA),\n',
      '        axis.text = element_text(size = 24),\n',
      '        axis.title = element_text(size = 24, face = \'bold\'),\n',
      '        axis.text.x = element_text(\n',
      '          angle = 45,\n',
      '          hjust = 1,\n',
      '          vjust = 1\n',
      '        ),\n',
      '        axis.line =   element_line(colour = \"black\")\n',
      '      ) + xlab(\'orig.ident\') + ylab(\'percentage(%)\') + scale_fill_manual(values = cols)\n',
      '  }} else if (value == \'number\') {{\n',
      '    p <- ggplot(df, mapping = aes(x = x, y = num)) +\n',
      '      geom_col(mapping = aes(fill = col_by), width = 0.8) +\n',
      '      theme(\n',
      '        panel.background = element_rect(fill = \"white\", colour = NA),\n',
      '        axis.text = element_text(size = 24),\n',
      '        axis.title = element_text(size = 24, face = \'bold\'),\n',
      '        axis.text.x = element_text(\n',
      '          angle = 45,\n',
      '          hjust = 1,\n',
      '          vjust = 1\n',
      '        ),\n',
      '        axis.line =   element_line(colour = \"black\")\n',
      '      ) + xlab(\'orig.ident\') + ylab(\'number of cells\') + scale_fill_manual(values = cols)\n',
      '  }} else{{\n',
      '    stop(\'can not find the type\')\n',
      '  }}\n',
      '  \n',
      '  if (xyflip) {{\n',
      '    p + coord_flip()\n',
      '  }} else{{\n',
      '    p\n',
      '  }}\n',
      '}}\n',

      'outbarplot <- function(meta_group,\n',
      '                       meta,\n',
      '                       groupby,\n',
      '                       x,\n',
      '                       hgroup = NULL,\n',
      '                       hcluster = NULL,\n',
      '                       value = \'percentage\',\n',
      '                       xyflip = FALSE) {{\n',
      '  cols <-\n',
      '    strsplit(meta_group[which(meta_group$group == groupby), color], split = \"\\\\|\") %>% unlist()\n',
      '  clu <-\n',
      '    strsplit(meta_group[which(meta_group$group == groupby), unit], split = \"\\\\|\") %>% unlist()\n',
      '  names(cols) <- clu\n',
      '  \n',
      '  if (!is.null(hgroup) |\n',
      '      length(intersect(meta_group$group, hgroup)) == 1) {{\n',
      '    if (!is.null(hcluster) &\n',
      '        length(intersect(unique(hcluster), unique(meta[[hgroup]]))) > 0) {{\n',
      '      meta <- meta[meta[[hgroup]]%in%unique(hcluster)]\n',
      '    }}\n',
      '  }}\n',
      '  tab_bar_plot(\n',
      '    tab_meta = meta,\n',
      '    x = x,\n',
      '    col_by = groupby,\n',
      '    xyflip = xyflip,\n',
      '    cols = cols,\n',
      '    value = value\n',
      '  )\n',
      '}}\n',
      '### heatmap dotplot\n',
      'dot_heat_plot <-\n',
      '  function(genelists,\n',
      '           genesets,\n',
      '           groupby,\n',
      '           tab_meta,\n',
      '           plot_type = \'dotplot\',\n',
      '           meta_group,\n',
      '           data,\n',
      '           hgroup = NULL,\n',
      '           hcluster = NULL,\n',
      '           inpRow = TRUE,\n',
      '           inpCol = FALSE,\n',
      '           scale_build = TRUE) {{\n',
      '    gene <- unique(trimws(strsplit(genelists, \",|;|\n',
      '\")[[1]]))\n',
      '    gene <- intersect(gene, names(genesets))\n',
      '    shiny::validate(need(\n',
      '      length(gene) <= 50,\n',
      '      \"More than 50 genes to plot! Please reduce the gene list!\"\n',
      '    ))\n',
      '    shiny::validate(need(length(gene) > 1, \"Please input at least 2 genes to plot!\"))\n',
      '    \n',
      '    h5file <- H5File$new(data, mode = \"r\") \n',
      '    h5data <- h5file[[\"grp\"]][[\"data\"]] \n',
      '    genelist <- data.table()\n',
      '    for (i in gene) {{\n',
      '      tmp <- tab_meta[, c(\"sampleID\", meta_group[group == groupby]$group), with = FALSE] \n',
      '      colnames(tmp) = c(\"sampleID\", \"sub\") \n',
      '      # \n',
      '      tmp$geneName = i \n',
      '      tmp$exp = h5data$read(args = list(genesets[i], quote(expr=)))\n',
      '      if (!is.null(hgroup) |\n',
      '          length(intersect(meta_group$group, hgroup)) == 1){{\n',
      '        tmp$hi_group <- tab_meta[[meta_group[group == hgroup]$group]]\n',
      '      }}\n',
      '      genelist <- rbindlist(list(genelist, tmp))\n',
      '    }}\n',
      '    h5file$close_all()\n',
      '    if(\'hi_group\' %in% colnames(genelist)){{\n',
      '      if (!is.null(hcluster) &\n',
      '          length(intersect(unique(hcluster), unique(tab_meta[[hgroup]]))) > 0) {{\n',
      '        genelist <- genelist[genelist[[\'hi_group\']]%in%unique(hcluster)]\n',
      '      }}\n',
      '    }}\n',
      '    shiny::validate(need(\n',
      '      uniqueN(genelist$sub) > 1,\n',
      '      \"Only 1 group present, unable to plot!\"\n',
      '    ))\n',
      '    \n',
      '    # Aggregate\n',
      '    genelist$exp = expm1(genelist$exp)\n',
      '    genelist = genelist[, .(exp = mean(exp),\n',
      '                            prop = sum(exp > 0) / length(sampleID)),\n',
      '                        by = c(\"geneName\", \"sub\")]\n',
      '    genelist$exp = log1p(genelist$exp)\n',
      '    \n',
      '    # Scale if required\n',
      '    colRange = range(genelist$exp)\n',
      '    if (scale_build) {{\n',
      '      genelist[, exp := scale(exp), keyby = \"geneName\"]\n',
      '      colRange = c(-max(abs(range(genelist$exp))), max(abs(range(genelist$exp))))\n',
      '    }}\n',
      '    \n',
      '    # hclust row/col if necessary\n',
      '    Mat = dcast.data.table(genelist, geneName ~ sub, value.var = \"exp\")\n',
      '    tmp = Mat$geneName\n',
      '    Mat = as.matrix(Mat[,-1])\n',
      '    rownames(Mat) = tmp\n',
      '    if (inpRow) {{\n',
      '      hcRow = dendro_data(as.dendrogram(hclust(dist(Mat)))) \n',
      '      ggRow = ggtree(hclust(dist(Mat)))\n',
      '      genelist$geneName = factor(genelist$geneName, levels = hcRow$labels$label)\n',
      '    }} else {{\n',
      '      genelist$geneName = factor(genelist$geneName, levels = rev(unique(gene)))\n',
      '    }}\n',
      '    if (inpCol) {{\n',
      '      hcCol = dendro_data(as.dendrogram(hclust(dist(t(Mat))))) \n',
      '      ggCol = ggtree(hclust(dist(t(Mat)))) + layout_dendrogram()\n',
      '      genelist$sub = factor(genelist$sub, levels = hcCol$labels$label)\n',
      '    }}else{{\n',
      '      genelist$sub = factor(genelist$sub, levels = rev(unique(genelist$sub)))\n',
      '    }}\n',
      '    if (plot_type == \'dotplot\') {{\n',
      '      p <- ggplot(genelist, aes(sub, geneName, color = exp, size = prop)) +\n',
      '        geom_point() +\n',
      '        theme_bw() + \n',
      '        scale_size_continuous(\n',
      '          \"proportion\",\n',
      '          range = c(0, 8),\n',
      '          limits = c(0, 1),\n',
      '          breaks = c(0.00, 0.25, 0.50, 0.75, 1.00)\n',
      '        ) + \n',
      '        theme(\n',
      '          legend.box.background = element_rect(fill = \'white\', colour = \'white\'),\n',
      '          legend.key = element_blank(),panel.grid = element_blank(),\n',
      '          axis.title = element_blank(),\n',
      '          legend.box = \"vertical\",\n',
      '          axis.line = element_line(colour = \"black\"),\n',
      '          panel.background = element_rect(fill = \'white\', colour = NA),\n',
      '          axis.text = element_text(size = 25),\n',
      '          axis.text.x = element_text(\n',
      '            angle = 45,\n',
      '            hjust = 1,\n',
      '            vjust = 1\n',
      '          )\n',
      '        ) +\n',
      '        scale_color_gradientn(colors = c(\"#60bde6\",\'white\',\"#e99ea4\"), \"expression\", limits = colRange) +\n',
      '        labs(x = NULL, y = NULL) +\n',
      '        guides(size = guide_legend(order = 3))\n',
      '    }} else if (plot_type == \'heatmap\') {{\n',
      '      p <- ggplot(genelist, aes(sub, geneName, fill = exp)) +\n',
      '        geom_tile() +\n',
      '        theme_bw() + \n',
      '        theme(\n',
      '          legend.box.background = element_rect(fill = \'white\', colour = \'white\'),\n',
      '          legend.key = element_blank(),panel.grid = element_blank(),\n',
      '          axis.title = element_blank(),\n',
      '          legend.box = \"vertical\",\n',
      '          axis.line = element_line(colour = \"black\"),\n',
      '          panel.background = element_rect(fill = \'white\', colour = NA),\n',
      '          axis.text = element_text(size = 25),\n',
      '          axis.text.x = element_text(\n',
      '            angle = 45,\n',
      '            hjust = 1,\n',
      '            vjust = 1\n',
      '          )\n',
      '        ) +\n',
      '        scale_fill_gradientn(colors = c(\"#60bde6\",\'white\',\"#e99ea4\"), \"expression\", limits = colRange) +\n',
      '        labs(x = NULL, y = NULL) +\n',
      '        guides(size = guide_legend(order = 3))\n',
      '    }}\n',
      '    \n',
      '    if (inpRow & inpCol) {{\n',
      '      ggOut <- p%>%insert_top(ggCol,height = 0.2) %>% insert_left(ggRow,width = 0.2)\n',
      '    }} else if (inpRow) {{\n',
      '      ggOut <- p %>% insert_left(ggRow,width = 0.2)\n',
      '    }} else if (inpCol) {{\n',
      '      ggOut <- p%>%insert_top(ggCol,height = 0.2)\n',
      '    }}else{{\n',
      '      ggOut <- p\n',
      '    }}\n',
      '    return(ggOut)\n',
      '  }}\n',
      '# extract legend\n',
      'g_legend <- function(a.gplot){{  \n',
      '  tmp <- ggplot_gtable(ggplot_build(a.gplot))  \n',
      '  leg <- which(sapply(tmp$grobs, function(x) x$name) == \"guide-box\")  \n',
      '  legend <- tmp$grobs[[leg]]  \n',
      '  legend \n',
      '}}\n',
      '# linear color\n',
      'bilinear <- function(x, y, xy, Q11, Q21, Q12, Q22) {{\n',
      '  oup = (xy - x) * (xy - y) * Q11 + x * (xy - y) * Q21 + (xy - x) * y * Q12 + x *\n',
      '    y * Q22\n',
      '  oup = oup / (xy * xy)\n',
      '  return(oup)\n',
      '}}\n',
      '# coexpression spatial feature\n',
      'coexp_feature <-\n',
      '  function(meta_slice,\n',
      '           meta_all,\n',
      '           data,\n',
      '           meta_group,\n',
      '           gene1,\n',
      '           gene2,\n',
      '           input_image,\n',
      '           genesets,\n',
      '           inpcol = \'Red (Gene1); Blue (Gene2)\',\n',
      '           pt.alpha = 1,\n',
      '           pt_size = 1,\n',
      '           highlight = \'All\',\n',
      '           threshold1 = 0,\n',
      '           threshold2 = 0) {{\n',
      'if(!is.null(input_image)){{\n',
      '  xrange <- c(0, dim(input_image)[2])\n',
      '  yrange <- c(0, dim(input_image)[1])\n',
      '}}else{{\n',
      '  xrange <- c(0,max(meta_slice$imagecol) - min(meta_slice$imagecol))\n',
      '  yrange <- c(0,max(meta_slice$imagerow) - min(meta_slice$imagerow))\n',
      '}}\n',
      '    \n',
      '    if (length(intersect(names(genesets), c(gene1, gene2))) < 2) {{\n',
      '      stop(\'Do not find these genes\')}}\n',
      '    \n',
      '    h5file <- H5File$new(data, mode = \"r\")\n',
      '    h5data <- h5file[[\'grp\']][[\'data\']]\n',
      '    meta_all$val1 <-\n',
      '      h5data$read(args = list(genesets[gene1], quote(expr = )))\n',
      '    meta_all$val2 <-\n',
      '      h5data$read(args = list(genesets[gene2], quote(expr = )))\n',
      '    h5file$close_all()\n',
      '    meta_slice <-\n',
      '      meta_all[meta_all$sampleID %in% meta_slice$sampleID]\n',
      '    \n',
      '    meta_slice[which(meta_slice$val1 <= max(meta_slice$val1) * threshold1), \'val1\'] <-\n',
      '      0\n',
      '    meta_slice[which(meta_slice$val2 <= max(meta_slice$val2) * threshold2), \'val2\'] <-\n',
      '      0\n',
      '    \n',
      '    rat = (max(meta_slice$imagecol) - min(meta_slice$imagecol)) / (max(meta_slice$imagerow) - min(meta_slice$imagerow))\n',
      '    cInp = strsplit(inpcol, \"; \")[[1]]\n',
      '    if (cInp[1] == \"Red (Gene1)\") {{\n',
      '      c10 = c(255, 0, 0)\n',
      '    }} else if (cInp[1] == \"Orange (Gene1)\") {{\n',
      '      c10 = c(255, 140, 0)\n',
      '    }} else {{\n',
      '      c10 = c(0, 255, 0)\n',
      '    }}\n',
      '    if (cInp[2] == \"Green (Gene2)\") {{\n',
      '      c01 = c(0, 255, 0)\n',
      '    }} else {{\n',
      '      c01 = c(0, 0, 255)\n',
      '    }}\n',
      '    c00 = c(217, 217, 217)\n',
      '    c11 = c10 + c01\n',
      '    nGrid = 16\n',
      '    nPad = 2\n',
      '    nTot = nGrid + nPad * 2\n',
      '    gg = data.table::data.table(v1 = rep(0:nTot, nTot + 1), v2 = sort(rep(0:nTot, nTot +\n',
      '                                                                            1)))\n',
      '    gg$vv1 = gg$v1 - nPad\n',
      '    gg[vv1 < 0]$vv1 = 0\n',
      '    gg[vv1 > nGrid]$vv1 = nGrid\n',
      '    gg$vv2 = gg$v2 - nPad\n',
      '    gg[vv2 < 0]$vv2 = 0\n',
      '    gg[vv2 > nGrid]$vv2 = nGrid\n',
      '    gg$cR = bilinear(gg$vv1, gg$vv2, nGrid, c00[1], c10[1], c01[1], c11[1])\n',
      '    gg$cG = bilinear(gg$vv1, gg$vv2, nGrid, c00[2], c10[2], c01[2], c11[2])\n',
      '    gg$cB = bilinear(gg$vv1, gg$vv2, nGrid, c00[3], c10[3], c01[3], c11[3])\n',
      '    gg$cMix = rgb(gg$cR, gg$cG, gg$cB, maxColorValue = 255)\n',
      '    gg = gg[, c(\"v1\", \"v2\", \"cMix\")]\n',
      '    \n',
      '    meta_slice$v1 = round(nTot * meta_slice$val1 / max(meta_slice$val1))\n',
      '    meta_slice$v2 = round(nTot * meta_slice$val2 / max(meta_slice$val2))\n',
      '    meta_slice$v0 = meta_slice$v1 + meta_slice$v2\n',
      '    meta_slice = gg[meta_slice, on = c(\"v1\", \"v2\")]\n',
      '    \n',
      '    \n',
      '    graphics::plot.new()\n',
      '    graphics::par(pty = \'s\',\n',
      '                  mar = c(0, 0, 1, 0),\n',
      '                  oma = c(0, 0, 1, 0))\n',
      '    graphics::plot(\n',
      '      x = meta_slice$imagecol,\n',
      '      y = meta_slice$imagerow,\n',
      '      col = ggplot2::alpha(\"white\",\n',
      '                           0),\n',
      '      xlab = NA_character_,\n',
      '      ylab = NA_character_,\n',
      '      axes = F,\n',
      '      xlim = grid::unit(xrange, \'npc\'),\n',
      '      ylim = grid::unit(yrange, \'npc\')\n',
      '    )\n',
      '    \n',
      'if(!is.null(input_image)){{\n',
      '  img <-\n',
      '    input_image %>% grDevices::as.raster() %>% magick::image_read()\n',
      '  graphics::rasterImage(\n',
      '    image = img,\n',
      '    xleft = xrange[1],\n',
      '    xright = xrange[2],\n',
      '    ybottom = yrange[1],\n',
      '    ytop = yrange[2]\n',
      '  )\n',
      '  whole_surface <- dim(input_image)[1] * dim(input_image)[2]\n',
      '}}else{{\n',
      '  whole_surface <- xrange[2] * yrange[2]\n',
      '}}\n',
      '    cropped_surface <- xrange[2] * yrange[2]\n',
      '    fct <- sqrt(whole_surface / cropped_surface)\n',
      '    pt_size <- pt_size * fct\n',
      '    \n',
      '    if (length(intersect(highlight, meta_all$sampleID)) == 0) {{\n',
      '      highlight = \'All\'\n',
      '    }}\n',
      '    \n',
      '    \n',
      '    if (length(which(highlight == \'All\')) >= 1 |\n',
      '        length(which(meta_slice$sampleID %in% highlight)) == length(meta_slice$sampleID)) {{\n',
      '      meta_slice$cMix <- meta_slice$cMix\n',
      '    }} else if (length(intersect(highlight, meta_slice$sampleID)) == 0) {{\n',
      '      meta_slice$cMix <- NA\n',
      '    }} else{{\n',
      '      meta_slice$cMix[-which(meta_slice$sampleID %in% highlight)] <- NA\n',
      '    }}\n',
      '    \n',
      'if(!is.null(input_image)){{\n',
      '  graphics::points(\n',
      '    x = meta_slice$imagecol,\n',
      '    y = meta_slice$imagerow,\n',
      '    pch = 19,\n',
      '    # cex = pt_size + pt_size * 0.1,\n',
      '    cex = unit(pt_size, \"npc\") * 0.7,\n',
      '    col = \'grey91\',\n',
      '    asp = 1\n',
      '  )\n',
      '}}\n',
      '    graphics::points(\n',
      '      x = meta_slice$imagecol,\n',
      '      y = meta_slice$imagerow,\n',
      '      pch = 19,\n',
      '      # cex = pt_size + pt_size * 0.1,\n',
      '      cex = grid::unit(pt_size, \"npc\") * 0.7,\n',
      '      col = ggplot2::alpha(colour = meta_slice$cMix,\n',
      '                           alpha = pt.alpha),\n',
      '      asp = 1\n',
      '    )\n',
      '    \n',
      '  }}\n',
      '### coexpression legend\n',
      'coexleg <- function(gene1, gene2, inpcol = \'Red (Gene1); Blue (Gene2)\'){{ \n',
      '  # Generate coex color palette \n',
      '  cInp = strsplit(inpcol, \"; \")[[1]] \n',
      '  if(cInp[1] == \"Red (Gene1)\"){{ \n',
      '    c10 = c(255,0,0) \n',
      '  }} else if(cInp[1] == \"Orange (Gene1)\"){{ \n',
      '    c10 = c(255,140,0) \n',
      '  }} else {{ \n',
      '    c10 = c(0,255,0) \n',
      '  }} \n',
      '  if(cInp[2] == \"Green (Gene2)\"){{ \n',
      '    c01 = c(0,255,0) \n',
      '  }} else {{ \n',
      '    c01 = c(0,0,255) \n',
      '  }} \n',
      '  c00 = c(217,217,217) ; c11 = c10 + c01 \n',
      '  nGrid = 16; nPad = 2; nTot = nGrid + nPad * 2 \n',
      '  gg = data.table(v1 = rep(0:nTot,nTot+1), v2 = sort(rep(0:nTot,nTot+1))) \n',
      '  gg$vv1 = gg$v1 - nPad ; gg[vv1 < 0]$vv1 = 0; gg[vv1 > nGrid]$vv1 = nGrid \n',
      '  gg$vv2 = gg$v2 - nPad ; gg[vv2 < 0]$vv2 = 0; gg[vv2 > nGrid]$vv2 = nGrid \n',
      '  gg$cR = bilinear(gg$vv1, gg$vv2, nGrid, c00[1], c10[1], c01[1], c11[1]) \n',
      '  gg$cG = bilinear(gg$vv1, gg$vv2, nGrid, c00[2], c10[2], c01[2], c11[2]) \n',
      '  gg$cB = bilinear(gg$vv1, gg$vv2, nGrid, c00[3], c10[3], c01[3], c11[3]) \n',
      '  gg$cMix = rgb(gg$cR, gg$cG, gg$cB, maxColorValue = 255) \n',
      '  gg = gg[, c(\"v1\", \"v2\", \"cMix\")] \n',
      '  \n',
      '  # Actual ggplot \n',
      '  ggOut = ggplot(gg, aes(v1, v2)) + \n',
      '    geom_tile(fill = gg$cMix) + \n',
      '    xlab(gene1) + ylab(gene2) + coord_fixed(ratio = 1) + \n',
      '    scale_x_continuous(breaks = c(0, nTot), label = c(\"low\", \"high\")) + \n',
      '    scale_y_continuous(breaks = c(0, nTot), label = c(\"low\", \"high\")) + \n',
      '    theme(\n',
      '      legend.box = \"vertical\",\n',
      '      axis.line = element_line(colour = \"black\"),\n',
      '      panel.background = element_rect(fill = \'white\', colour = NA),\n',
      '      axis.title = element_text(size = 24,face = \'bold\'),\n',
      '      axis.text = element_text(size = 24),\n',
      '      axis.text.x = element_text(\n',
      '        angle = 45,\n',
      '        hjust = 1,\n',
      '        vjust = 1\n',
      '      )\n',
      '    ) \n',
      '  return(ggOut) \n',
      '}} \n',
      '## coexpression table\n',
      'coexp_tab <-\n',
      '  function(tab_meta,\n',
      '           data,\n',
      '           metagroup,\n',
      '           genesets,\n',
      '           gene1,\n',
      '           gene2,\n',
      '           highlight = NULL,\n',
      '           threshold1 = 0,\n',
      '           threshold2 = 0,\n',
      '           new_group = NULL) {{\n',
      '    if (length(intersect(names(genesets), c(gene1, gene2))) < 2) {{\n',
      '      stop(\'Do not find these genes\')\n',
      '    }}\n',
      '    h5file <- H5File$new(data, mode = \"r\")\n',
      '    \n',
      '    h5data <- h5file[[\'grp\']][[\'data\']]\n',
      '    \n',
      '    tab_meta$val1 <-\n',
      '      h5data$read(args = list(genesets[gene1], quote(expr = )))\n',
      '    tab_meta$val2 <-\n',
      '      h5data$read(args = list(genesets[gene2], quote(expr = )))\n',
      '    \n',
      '    h5file$close_all()\n',
      '    \n',
      '    tab_meta[which(tab_meta$val1 <= max(tab_meta$val1) * threshold1), \'val1\'] <-\n',
      '      0\n',
      '    tab_meta[which(tab_meta$val2 <= max(tab_meta$val2) * threshold2), \'val2\'] <-\n',
      '      0\n',
      '    \n',
      '    if (is.null(highlight) |\n',
      '        length(intersect(tab_meta$sampleID, highlight)) == 0) {{\n',
      '      tab_meta <- tab_meta\n',
      '    }}else{{\n',
      '      tab_meta <- tab_meta[which(tab_meta$sampleID %in% highlight), ]\n',
      '    }}\n',
      '    \n',
      '    if (\n',
      '      length(intersect(metagroup[[\'group\']], new_group)) == 0) {{\n',
      '      df = tab_meta[, .(\n',
      '        gene1_ex = sum(val1 > 0 & val2 <= 0),\n',
      '        gene2_ex = sum(val2 > 0 & val1 <= 0),\n',
      '        both = sum(val2 > 0 & val1 > 0),\n',
      '        none = sum(val2 <= 0 & val1 <= 0)\n',
      '      ),\n',
      '      ]\n',
      '      \n',
      '      df %<>% t() %>% as.data.frame()\n',
      '      \n',
      '      colnames(df) <- \'nSpot\'\n',
      '      \n',
      '      df$expression <- rownames(df)\n',
      '      \n',
      '      df[1:2, \"expression\"] <-\n',
      '        c(paste(gene1, \'>\' , round(threshold1 * max(tab_meta$val1), 2)), paste(gene2, \'>\' , round(threshold2 *\n',
      '                                                                                                    max(tab_meta$val2), 2)))\n',
      '      \n',
      '      df %<>% mutate(pct = round(100 * nSpot / sum(nSpot), 2))\n',
      '      \n',
      '      rownames(df) <- NULL\n',
      '      \n',
      '      df <- df[, c(\'expression\', \'nSpot\', \'pct\')]\n',
      '      \n',
      '    }} else{{\n',
      '      colnames(tab_meta)[which(colnames(tab_meta) == new_group)] <-\n',
      '        \'new_group\'\n',
      '      df = tab_meta[, .(\n',
      '        gene1_ex = sum(val1 > 0 & val2 <= 0),\n',
      '        gene2_ex = sum(val2 > 0 & val1 <= 0),\n',
      '        both = sum(val2 > 0 & val1 > 0),\n',
      '        none = sum(val2 <= 0 & val1 <= 0)\n',
      '      ),\n',
      '      by = new_group]\n',
      '      \n',
      '      \n',
      '      if (length(which(is.na(df$new_group))) > 0) {{\n',
      '        df <- df[-which(is.na(df$new_group)), ]\n',
      '      }}\n',
      '      \n',
      '      df <- lapply(unique(df$new_group), function(x) {{\n',
      '        df_ <- subset(df, df$new_group == x)\n',
      '        df_ <- df_[, -1]\n',
      '        df_ %<>% t() %>% as.data.frame()\n',
      '        colnames(df_) <- \'nSpot\'\n',
      '        df_$expression <- rownames(df_)\n',
      '        df_[1:2, \"expression\"] <-\n',
      '          c(paste(gene1, \'>\' , round(threshold1 * max(\n',
      '            tab_meta$val1\n',
      '          ), 2)), paste(gene2, \'>\' , round(threshold2 * max(\n',
      '            tab_meta$val2\n',
      '          ), 2)))\n',
      '        df_ %<>% mutate(pct = round(100 * nSpot / sum(nSpot), 2))\n',
      '        df_[, new_group] <- x\n',
      '        df_\n',
      '      }})\n',
      '      \n',
      '      df <- do.call(rbind, df)\n',
      '      \n',
      '      rownames(df) <- NULL\n',
      '      \n',
      '      df <- df[, c(\'expression\', \'nSpot\', \'pct\', new_group)]\n',
      '    }}\n',
      '    \n',
      '    return(df)\n',
      '  }}\n',

      'fthighlightplot <-\n',
      '  function(plotaction,genesets,\n',
      '           meta_slice,meta,\n',
      '           input_image,\n',
      '           gene,\n',
      '           data) {{\n',
      '    if(plotaction){{\n',
      '      highcell <- meta_slice[which(!is.na(meta_slice$group)), sampleID]\n',
      '    }}else{{\n',
      '      highcell <- \'All\'\n',
      '    }}\n',
      '    spatial_feature(\n',
      '      input_image = input_image,genesets = genesets,\n',
      '      meta_slice = meta_slice,\n',
      '      gene = gene,meta_all = meta,\n',
      '      data = data,\n',
      '      highlight = highcell\n',
      '    )\n',
      '    \n',
      '  }}\n',
      'tab_exp_clu <-\n',
      '  function(data,\n',
      '           meta,\n',
      '           gene,\n',
      '           inpsplt,\n',
      '           group.by,meta_group,threshold = 0) {{\n',
      '    h5file <- H5File$new(data, mode = \"r\")\n',
      '    h5data <- h5file[[\'grp\']][[\'data\']]\n',
      '    meta$val <- h5data$read(args = list(genesets[gene], quote(expr = )))\n',
      '    h5file$close_all()\n',
      '    meta = meta[, c(\'sampleID\', group.by, \'val\'),\n',
      '                with = FALSE]\n',
      '    colnames(meta) = c(\'sampleID\', \"sub\", \'val\')\n',
      '    meta <- meta[!is.na(sub)]\n',
      '    if (meta_group[group == group.by]$info != \'TRUE\') {{\n',
      '      if (inpsplt == \"Quartile\") {{\n',
      '        nBk = 4\n',
      '      }}\n',
      '      if (inpsplt == \"Decile\") {{\n',
      '        nBk = 10\n',
      '      }}\n',
      '      meta$sub = cut(meta$sub, breaks = nBk)\n',
      '    }}\n',
      '    meta$express = FALSE\n',
      '    meta[val > max(meta$val)*threshold]$express = TRUE\n',
      '    meta1 = meta[express == TRUE, .(nExpress = .N), by = \"sub\"]\n',
      '    meta = meta[, .(nCells = .N), by = \"sub\"]\n',
      '    meta = meta1[meta, on = \"sub\"]\n',
      '    meta = meta[, c(\"sub\", \"nCells\", \"nExpress\"), with = FALSE]\n',
      '    meta[is.na(nExpress)]$nExpress = 0\n',
      '    meta$pctExpress = 100 * meta$nExpress / meta$nCells\n',
      '    meta = meta[order(sub)]\n',
      '    colnames(meta)[3] = paste0(colnames(meta)[3], \"_\", gene)\n',
      '    return(meta)\n',
      '  }}\n\n\n\n'
    )
  return(afun)
}
## server header
server_heads <- function(df_select) {
  server_head <- glue::glue(
    'server <- function(input, output, session) {{\n',
    '  # prepared data\n',
    '  ## meta: spot information, cluster, highlight\n',
    '  add_meta <- shiny::reactiveValues(meta = meta)\n',
    '  meta_group_add <- shiny::reactiveValues(meta = meta_group)\n',
    '  ## session\n',
    '  optCrt = \"{{ option_create: function(data,escape) {{return(\'<div class=\\"create\\"><strong>\' + \'</strong></div>\');}} }}\"\n',
    '  ## drawing dlclick switch \n',
    '  drawing <- shiny::reactiveVal(value = FALSE)\n',
    '  ## TRUE:on/FALSE:off\n',
    '  oe <- shiny::observeEvent(input$keys, {{\n',
    '    checkShortcut(\n',
    '      shortcut = input$keys,\n',
    '      valid = c(\"d\", \"e\"),\n',
    '      cursor_pos = cursor_pos()\n',
    '    )\n',
    '    if (input$keys == \"d\") {{\n',
    '      drawing(TRUE)\n',
    '    }}\n',
    '    else if (input$keys == \"e\") {{\n',
    '      drawing(FALSE)\n',
    '    }}\n',
    '  }})\n',
    '  h_meta <- shiny::reactiveValues(meta = meta)\n',
    '  \n',
    '  ## dl_click switch\n',
    '  oe <- shiny::observeEvent(input$h_dbl_click1, {{current_val <- drawing()\n',
    '  drawing(!current_val)\n',
    '  }})\n\n\n'
  )



  slice_data <- c()
  for (i in 1:length(df_select$slice)) {
    on_sli <- glue::glue(
      'add_meta{i} <-reactive({{subset(add_meta$meta,add_meta$meta$slice_sample == unique(add_meta$meta$slice_sample)[{i}])}})\n',
      'range_slice{i} <- shiny::reactiveValues(range = df_select$ranges[[{i}]])\n',
      'h_meta{i} <-reactive({{subset(h_meta$meta,h_meta$meta$slice_sample == unique(h_meta$meta$slice_sample)[{i}])}})\n',
      'image_slice{i} <- shiny::reactiveValues(images = image[[{i}]])\n\n'
    )
    slice_data <- paste(slice_data, on_sli, sep = '')
  }




  poly_switch_server <- c()
  for (i in 1:length(df_select$slice)) {
    if (i == 1) {
      poly <- glue::glue(
        'cursor_pos <- shiny::reactive({{\n',
        '  if (!is.null(input$h_polyg_{i}$x)) {{\n',
        '    c(input$h_polyg_{i}$x, input$h_polyg_{i}$y)\n',
        '  }} else if (!is.null(input$f_polyg_{i}$x)) {{\n',
        '    c(input$f_polyg_{i}$x, input$f_polyg_{i}$y)\n',
        '  }} else if (!is.null(input$bg_polyg_{i}$x)) {{\n',
        '   c(input$bg_polyg_{i}$x, input$bg_polyg_{i}$y)\n\n'
      )
    } else{
      poly <- glue::glue(
        ' }} else if (!is.null(input$h_polyg_{i}$x)) {{\n',
        '   c(input$h_polyg_{i}$x, input$h_polyg_{i}$y)\n',
        ' }} else if (!is.null(input$f_polyg_{i}$x)) {{\n',
        '   c(input$f_polyg_{i}$x, input$f_polyg_{i}$y)\n',
        ' }} else if (!is.null(input$bg_polyg_{i}$x)) {{\n',
        '   c(input$bg_polyg_{i}$x, input$bg_polyg_{i}$y)\n\n'
      )
    }

    if (i == length(df_select$slice)) {
      ends <- glue::glue('  }}}})\n\n\n\n')
    } else{
      ends <- ''
    }

    poly_switch_server <- paste(poly_switch_server, poly, ends)

  }

  server_head <-
    glue::glue('{server_head}\n',
               '{slice_data}\n',
               '{poly_switch_server}\n')

  return(server_head)
}
### page1
page1_server <- function(df_select) {
  page1_head_server <-
    glue::glue(
      '## page1 ############################################\n',
      '## splice highlight meta\n',
      '## cluster \n',
      '### save new cluster names\n',
      'Clusters <- shiny::reactiveVal(value = NULL)\n',
      '### reset all\n\n\n'
    )

  #########
  res_head <- glue::glue('shiny::observeEvent(input$reset1, {{\n',
                         '  Clusters <- Clusters(NULL)\n\n')

  res_all <- c()
  for (i in 1:length(df_select$slice)) {
    res_poly <- glue::glue('polygon_vals{i}$x <- NULL\n',
                           'polygon_vals{i}$y <- NULL\n\n')
    res_all <- paste(res_all, res_poly, sep = '')
  }


  res_tail <- glue::glue(
    'h_meta$meta$group <- as.character(h_meta$meta$group)\n',
    'h_meta$meta$group <- NA\n',
    '})\n\n'
  )

  res_all <- paste(res_head, res_all, res_tail)
  res_all <- glue::glue('{res_all}')
  ######


  page1_process <- glue::glue(
    'observeEvent(input$circle_select, {{\n',
    '  if (!drawing()) {{\n',
    '    if (input$cluster1 == \'\') {{\n',
    '      clu <- NULL\n',
    '    }} else{{\n',
    '      clu <- input$cluster1\n',
    '    }}\n',
    '    cluster_new <- c(Clusters(), clu)\n',
    '    Clusters(cluster_new)\n',
    '  }}}})\n',
    '### save new group \n',
    'oe <- shiny::observeEvent(input$Import_1, {{\n',
    '  meta_new <- add_meta$meta\n',
    '  group_new <- input$group1\n',
    '  new_groups <- meta_group_add$meta\n',
    '  if (!is.null(group_new) & group_new != \'\') {{\n',
    '    if (length(which(is.na(unique(Clusters())))) < length(unique(Clusters()))) {{\n',
    '      meta_new[[group_new]] <- NA\n',
    '      meta_new[[group_new]] <- h_meta$meta$group\n',
    '      meta_new[[group_new]] <-\n',
    '        factor(meta_new[[group_new]], levels = unique(Clusters()))\n',
    '      unit_n <- paste(levels(meta_new[[group_new]]), collapse = \'\\\\|\')\n',
    '      cols <- col_box[1:length(levels(meta_new[[group_new]]))]\n',
    '      cols <- paste(cols, collapse = \'|\')\n',
    '      # new_groups <- rbind(new_groups, c(group_new, unit_n, cols, TRUE, 0))\n',
    '      tmp <- data.table(group = group_new,unit = unit_n,color = cols, info=TRUE, default=0)\n',
    '      new_groups <- rbindlist(list(new_groups, tmp))\n',
    '    }}\n',
    '  }}\n',
    '  add_meta$meta <- meta_new\n',
    '  meta_group_add$meta <- new_groups\n',
    '}})\n',
    '## gene select\n',
    'updateSelectizeInput(\n',
    '  session,\n',
    '  \"gene\",\n',
    '  choices = names(genesets),\n',
    '  server = TRUE,\n',
    '  selected = df_select$genes,\n',
    '  options = list(\n',
    '    maxOptions = 7,\n',
    '    create = TRUE,\n',
    '    persist = TRUE,\n',
    '    render = I(optCrt)\n',
    '  ))\n',
    '### meta display\n',
    'output$spotsinfor <- renderDT({{\n',
    '  DT::datatable(\n',
    '    add_meta$meta[,meta_group_add$meta$group[meta_group_add$meta$info == T],with = F],\n',
    '    rownames = FALSE,\n',
    '    extensions = \"Buttons\",\n',
    '    options = list(\n',
    '      pageLength = -1,\n',
    '      dom = \"Bfrtip\",\n',
    '      searching = TRUE,\n',
    '      buttons = c(\"copy\", \"csv\", \"excel\", \'pdf\')\n',
    '    ))}})\n',
    '### gene expression\n',
    'output$statis_gene <- renderDT({{\n',
    '  DT::datatable(\n',
    '    tab_exp_clu(inpsplt = input$splt,\n',
    '                data = data,threshold = input$stat_thrd,\n',
    '                meta = add_meta$meta,\n',
    '                gene = input$gene,\n',
    '                group.by = input$meta1_select,\n',
    '                meta_group = meta_group_add$meta\n',
    '    ),\n',
    '    rownames = FALSE,\n',
    '    extensions = \"Buttons\",\n',
    '    options = list(\n',
    '      pageLength = -1,\n',
    '      dom = \"Bfrtip\",\n',
    '      searching = TRUE,\n',
    '      buttons = c(\"copy\", \"csv\", \"excel\", \'pdf\')\n',
    '    )\n',
    '  )}})\n\n\n'
  )


  ###
  slice_path <- c()

  for (i in 1:length(df_select$slice)) {
    slice <- glue::glue(
      '## slice {i}\n',
      '### clusters order\n',
      'observeEvent(input$f_click_{i}, {{\n',
      '  if (!drawing()) {{\n',
      '    if (input$cluster1 == \'\') {{\n',
      '      clu <- NULL\n',
      '    }} else{{\n',
      '      clu <- input$cluster1\n',
      '    }}\n',
      '    cluster_new <- c(Clusters(), clu)\n',
      '    Clusters(cluster_new)\n',
      '  }}\n',
      '}})\n',
      'observeEvent(input$h_click_{i}, {{\n',
      '  if (!drawing()) {{\n',
      '    if (input$cluster1 == \'\') {{\n',
      '      clu <- NULL\n',
      '    }} else{{\n',
      '      clu <- input$cluster1\n',
      '    }}\n',
      '    cluster_new <- c(Clusters(), clu)\n',
      '    Clusters(cluster_new)\n',
      '  }}\n',
      '}})\n',
      'observeEvent(input$bg_click_{i}, {{\n',
      '  if (!drawing()) {{\n',
      '    if (input$cluster1 == \'\') {{\n',
      '      clu <- NULL\n',
      '    }} else{{\n',
      '      clu <- input$cluster1\n',
      '    }}\n',
      '    cluster_new <- c(Clusters(), clu)\n',
      '    Clusters(cluster_new)\n',
      '  }}\n',
      '}})\n',
      '## highlight click spot\n',
      'observeEvent(input$h_click_{i}, {{\n',
      '  if (!drawing()) {{\n',
      '    if (!is.null(input$h_click_{i}) & input$cluster1 != \'\') {{\n',
      '      meta_h_new <- h_meta$meta\n',
      '      coord <- input$h_click_{i}\n',
      '      coord$mapping <- list(\'x\' = \'imagecol\',\n',
      '                            \'y\' = \'imagerow\')\n',
      '      state <-\n',
      '        nearPoints(\n',
      '          h_meta{i}(),\n',
      '          coord,\n',
      '          addDist = TRUE,\n',
      '          maxpoints = input$select_size / 10,\n',
      '          threshold = input$select_size\n',
      '        )\n',
      '      meta_h_new$group <- as.character(meta_h_new$group)\n',
      '      \n',
      '      if (input$p_tool == \'Pen\') {{\n',
      '        meta_h_new$group[which(meta_h_new$sampleID %in% state$sampleID)] <-\n',
      '          input$cluster1\n',
      '      }} else{{\n',
      '        meta_h_new$group[which(meta_h_new$sampleID %in% state$sampleID)] <- NA\n',
      '      }}\n',
      '      meta_h_new$group <- factor(meta_h_new$group,levels = unique(Clusters()))\n',
      '      h_meta$meta <- meta_h_new\n',
      '    }}\n',
      '  }}\n',
      '}})\n',
      '## backgroud click\n',
      'observeEvent(input$bg_click_{i}, {{\n',
      '  if (!is.null(input$bg_click_{i}) & input$cluster1 != \'\') {{\n',
      '    meta_h_new <- h_meta$meta\n',
      '    coord <- input$bg_click_{i}\n',
      '    coord$mapping <- list(\'x\' = \'imagecol\',\n',
      '                          \'y\' = \'imagerow\')\n',
      '    \n',
      '    state <-\n',
      '      nearPoints(\n',
      '        add_meta{i}(),\n',
      '        coord,\n',
      '        addDist = TRUE,\n',
      '        maxpoints = 1,\n',
      '        threshold = 10\n',
      '      )\n',
      '    if(length(which(meta_group_add$meta$group[meta_group_add$meta$info == T] == input$meta1_select)) > 0){{\n',
      '      cells <-\n',
      '        add_meta{i}()[which(add_meta{i}()[[input$meta1_select]] %in% state[[input$meta1_select]]), sampleID]\n',
      '      meta_h_new$group <- as.character(meta_h_new$group)\n',
      '      if(length(which(!is.na(meta_h_new[sampleID %in% cells,group]))) == length(cells) & length(unique(meta_h_new[sampleID %in% cells,group])) == 1){{\n',
      '        if(unique(meta_h_new$group[meta_h_new$sampleID %in% cells]) == input$cluster1){{\n',
      '          meta_h_new$group[meta_h_new$sampleID %in% cells] <- NA\n',
      '        }}else{{\n',
      '          meta_h_new$group[meta_h_new$sampleID %in% cells] <- input$cluster1\n',
      '        }}\n',
      '      }}\n',
      '      else{{\n',
      '        meta_h_new$group[meta_h_new$sampleID %in% cells] <- input$cluster1\n',
      '      }}\n',
      '    }}\n',
      '    # if(length(which(!is.na(unique(meta_h_new$group)))) < 1){{\n',
      '    #   meta_h_new$group <- NA\n',
      '    # }}\n',
      '    \n',
      '    meta_h_new$group <- factor(meta_h_new$group,levels = unique(Clusters()))\n',
      '    \n',
      '    h_meta$meta <- meta_h_new\n',
      '  }}\n',
      '}})\n',
      '### circle selected\n',
      'polygon_vals{i} <- shiny::reactiveValues(x = NULL, y = NULL)\n',
      '### polygon save\n',
      'oe <- shiny::observeEvent(input$h_polyg_{i}, {{\n',
      '  if (drawing()) {{\n',
      '    polygon_vals{i}$x <- c(polygon_vals{i}$x, input$h_polyg_{i}$x)\n',
      '    polygon_vals{i}$y <- c(polygon_vals{i}$y, input$h_polyg_{i}$y)\n',
      '  }}\n',
      '}})\n',
      'oe <- shiny::observeEvent(input$f_polyg_{i}, {{\n',
      '  if (drawing()) {{\n',
      '    polygon_vals{i}$x <- c(polygon_vals{i}$x, input$f_polyg_{i}$x)\n',
      '    polygon_vals{i}$y <- c(polygon_vals{i}$y, input$f_polyg_{i}$y)\n',
      '  }}\n',
      '}})\n',

      'oe <- shiny::observeEvent(input$bg_polyg_{i}, {{\n',
      '  if (drawing()) {{\n',
      '    polygon_vals{i}$x <- c(polygon_vals{i}$x, input$bg_polyg_{i}$x)\n',
      '    polygon_vals{i}$y <- c(polygon_vals{i}$y, input$bg_polyg_{i}$y)\n',
      '  }}\n',
      '}})\n',

      '  circle_cell{i} <- reactive({{\n',
      '    if(!is.null(polygon_vals{i}$x)){{\n',
      '      cir1 <- data.table(imagecol = polygon_vals{i}$x,  imagerow= polygon_vals{i}$y)\n',
      '      cir1\n',
      '    }}else{{\n',
      '      NULL\n',
      '    }}\n',
      '  }})\n',

      'observeEvent(input$circle_select, {{\n',
      '  if (!is.null(circle_cell{i}()) & input$cluster1 != \'\') {{\n',
      '    meta_h_new <- h_meta$meta\n',
      '    meta_h_new$group <- as.character(meta_h_new$group)\n',
      '    cells <-\n',
      '      polygon_select(meta = add_meta{i}(), polygon = circle_cell{i}())\n',
      '    meta_h_new$group[meta_h_new$sampleID %in% cells] <-\n',
      '      input$cluster1\n',
      '    meta_h_new$group <- factor(meta_h_new$group,levels = unique(Clusters()))\n',
      '    h_meta$meta <- meta_h_new\n',
      '  }}\n',
      '}})\n',
      '### backgroud plot\n',
      'output$bg_plot{i} <- renderPlot({{\n',
      '  spatial_dimplot(\n',
      '    meta_slice = add_meta{i}(),\n',
      '    meta_group = meta_group_add$meta,\n',
      '    col.by = input$meta1_select,\n',
      '    input_image = image_slice{i}$images\n',
      '  )\n',
      '}})\n',
      '### feature plot\n',
      'output$feature{i} <- renderPlot({{\n',
      '  fthighlightplot(\n',
      '    plotaction = input$plotout,meta = h_meta$meta,\n',
      '    meta_slice = h_meta{i}(),\n',
      '    input_image = image_slice{i}$images,\n',
      '    gene = input$gene,\n',
      '    data = data,genesets = genesets\n',
      '  )\n',
      '}})\n',
      '### highlight plot\n',
      'output$highlight{i} <- renderPlot({{\n',
      '  spatial_high_select(input_image = image_slice{i}$images,meta_slice = h_meta{i}(),pt.alpha = 0.7)\n',
      '}})\n',

      'output$highlight{i}_sm <- shiny::renderPlot({{\n',
      '  graphics::par(pty = \'s\',\n',
      '                mar = c(0, 0, 1, 0),\n',
      '                oma = c(0, 0, 1, 0))\n',
      '  graphics::plot(\n',
      '    x = polygon_vals{i}$x,\n',
      '    y = polygon_vals{i}$y,\n',
      '    type = \"l\",\n',
      '    xlim = unit(range_slice{i}$range[[1]], \'npc\'),\n',
      '    ylim = unit(range_slice{i}$range[[2]], \'npc\'),\n',
      '    \n',
      '    xlab = NA_character_,\n',
      '    ylab = NA_character_,\n',
      '    axes = FALSE,\n',
      '    main = base::ifelse(test = drawing(),\n',
      '                        yes = \"You are drawing\",\n',
      '                        no = \"\")\n',
      '  )\n',
      '}}, bg = \"transparent\")\n',
      '### dowload plot\n',
      'output$bg_spot{i}.pdf <- downloadHandler(\n',
      '  filename = function() {{ paste0(\"group\",\"_\",\n',
      '                                 input$meta1_select,\".pdf\") }},\n',
      '  content = function(file) {{\n',
      '    pdf(\n',
      '      file = file,\n',
      '      height = input$bg_spot{i}.h,\n',
      '      width = input$bg_spot{i}.w\n',
      '    )\n',
      '    spatial_dimplot(\n',
      '      meta_slice = add_meta{i}(),\n',
      '      meta_group = meta_group_add$meta,\n',
      '      col.by = input$meta1_select,\n',
      '      input_image = image_slice{i}$images\n',
      '    )\n',
      '    dev.off()\n',
      '  }})\n',
      'output$bg_spot{i}.png <- downloadHandler(\n',
      '  filename = function() {{\n',
      '    paste0(\"group\", \"_\",\n',
      '           input$meta1_select, \".png\")\n',
      '  }},\n',
      '  content = function(file) {{\n',
      '    png(\n',
      '      file = file\n',
      '      # ,\n',
      '      # height = unit(input$ft_spot.h, \'npc\'),\n',
      '      # width = unit(input$ft_spot.h, \'npc\')\n',
      '    )\n',
      '    spatial_dimplot(\n',
      '      meta_slice = add_meta{i}(),\n',
      '      meta_group = meta_group_add$meta,\n',
      '      col.by = input$meta1_select,\n',
      '      input_image = image_slice{i}$images\n',
      '    )\n',
      '    dev.off()\n',
      '  }}\n',
      ')\n',

      'output$ft_spot{i}.pdf <- downloadHandler(\n',
      '  filename = function() {{ paste0(\"group\",\"_\",\n',
      '                                 input$gene,\".pdf\") }},\n',
      '  content = function(file) {{\n',
      '    pdf(\n',
      '      file = file,\n',
      '      height = input$bg_spot{i}.h,\n',
      '      width = input$bg_spot{i}.w\n',
      '    )\n',
      '    fthighlightplot(\n',
      '      plotaction = input$plotout,meta = h_meta$meta,\n',
      '      meta_slice = h_meta{i}(),\n',
      '      input_image = image_slice{i}$images,\n',
      '      gene = input$gene,\n',
      '      data = data,genesets = genesets\n',
      '    )\n',
      '    dev.off()\n',
      '  }})\n',
      'output$ft_spot{i}.png <- downloadHandler(\n',
      '  filename = function() {{\n',
      '    paste0(\"group\", \"_\",\n',
      '           input$gene, \".png\")\n',
      '  }},\n',
      '  content = function(file) {{\n',
      '    png(\n',
      '      file = file\n',
      '      # ,\n',
      '      # height = unit(input$ft_spot.h, \'npc\'),\n',
      '      # width = unit(input$ft_spot.h, \'npc\')\n',
      '    )\n',
      '    fthighlightplot(\n',
      '      plotaction = input$plotout,meta = h_meta$meta,\n',
      '      meta_slice = h_meta{i}(),\n',
      '      input_image = image_slice{i}$images,\n',
      '      gene = input$gene,\n',
      '      data = data,genesets = genesets\n',
      '    )\n',
      '    dev.off()\n',
      '  }}\n',
      ')\n\n\n'
    )
    slice_path <- paste(slice_path, slice, sep = '')
  }
  slice_path <- glue::glue('{slice_path}')



  ###

  pl_val <- c()
  for (i in 1:length(df_select$slice)) {
    pl <- glue::glue('polygon_vals{i}$x <- NULL\n',
                     'polygon_vals{i}$y <- NULL\n\n',)
    pl_val <- paste(pl_val, pl, sep = '')
  }

  pl_val <-
    glue::glue('observeEvent(input$circle_select, {{\n',
               '{pl_val}',
               '}})\n')


  ###
  # page1 <- paste(page1_head_server,res_all,page1_process,slice_path,pl_val)
  return(
    glue::glue(
      '{page1_head_server}\n',
      '{res_all}\n',
      '{page1_process}\n',
      '{slice_path}\n',
      '{pl_val}\n'
    )
  )
}
### page2
page2_server <- function(df_select) {
  page2_server_head <- glue::glue(
    '## page2 #################################################\n',
    '### gene selected\n',
    'updateSelectizeInput(\n',
    '  session,\"gene_f1\",\n',
    '  choices = df_select$genes,\n',
    '  server = TRUE,\n',
    '  selected = df_select$gene1,\n',
    '  options = list(\n',
    '    maxOptions = 7,\n',
    '    create = TRUE,\n',
    '    persist = TRUE,\n',
    '    render = I(optCrt)))\n',
    'updateSelectizeInput(\n',
    '  session,\"gene_f2\",\n',
    '  choices = df_select$genes,\n',
    '  server = TRUE,\n',
    '  selected = df_select$gene2,\n',
    '  options = list(\n',
    '    maxOptions = 7,\n',
    '    create = TRUE,\n',
    '    persist = TRUE,\n',
    '    render = I(optCrt)))\n',
    'Clusters2 <- shiny::reactiveVal(value = NULL)\n',
    'observeEvent(input$circle_select2, {{if(input$cluster2 == \'\'){{\n',
    '  clu <- NULL\n',
    '}}else{{clu <- input$cluster2}}\n',
    '  cluster_new <- c(Clusters2(),clu)\n',
    '  Clusters2(cluster_new)}})\n',
    '### save new group \n',
    'oe <- shiny::observeEvent(input$Import_2, {{\n',
    '  meta_new <- add_meta$meta\n',
    '  group_new <- input$group2\n',
    '  new_groups <- meta_group_add$meta\n',
    '  if (!is.null(group_new) & group_new != \'\') {{\n',
    '    if (length(which(is.na(unique(Clusters2())))) < length(unique(Clusters2()))) {{\n',
    '      meta_new[[group_new]] <- NA\n',
    '      meta_new[[group_new]] <- h_meta$meta$group\n',
    '      meta_new[[group_new]] <-\n',
    '        factor(meta_new[[group_new]], levels = unique(Clusters2()))\n',
    '      unit_n <- paste(levels(meta_new[[group_new]]), collapse = \'\\\\|\')\n',
    '      cols <- col_box[1:length(levels(meta_new[[group_new]]))]\n',
    '      cols <- paste(cols, collapse = \'|\')\n',
    '      # new_groups <- rbind(new_groups, c(group_new, unit_n, cols, TRUE, 0))\n',
    '      tmp <- data.table(group = group_new,unit = unit_n,color = cols, info=TRUE, default=0)\n',
    '      new_groups <- rbindlist(list(new_groups, tmp))}}}}\n',
    '  add_meta$meta <- meta_new\n',
    '  meta_group_add$meta <- new_groups}})\n\n\n'
  )

  p2_cir <- c()
  for (i in 1:length(df_select$slice)) {
    cir_s_n <- glue::glue('  page2_polygon_vals{i}$x <- NULL\n',
                          '  page2_polygon_vals{i}$y <- NULL\n\n')
    p2_cir <- paste(p2_cir, cir_s_n, sep = '')
  }
  p2_cir <-
    glue::glue('observeEvent(input$circle_select2, {{',
               '{p2_cir}',
               '}})\n\n\n')
  p2_res <- c()
  for (i in 1:length(df_select$slice)) {
    res_s_n <- glue::glue('  page2_polygon_vals{i}$x <- NULL\n',
                          '  page2_polygon_vals{i}$y <- NULL\n\n')
    p2_res <- paste(p2_res, res_s_n, sep = '')
  }
  p2_res <- glue::glue(
    'shiny::observeEvent(input$reset2, {{\n',
    '  Clusters <- Clusters(NULL)\n',
    '{p2_res}',
    '  h_meta$meta$group <- NA}}\n\n\n)'
  )

  slice_path <- c()
  for (i in 1:length(df_select$slice)) {
    slice_process <- glue::glue(
      '## slice{i}\n',
      '### cluster factor\n',
      'observeEvent(input$bg_f_click_{i}, {{\n',
      '  if (input$cluster2 == \'\') {{\n',
      '    clu <- NULL\n',
      '  }} else{{\n',
      '    clu <- input$cluster2}}\n',
      '  cluster_new <- c(Clusters2(), clu)\n',
      '  Clusters2(cluster_new)\n',
      '}})\n',
      '### polygon\n',
      'page2_polygon_vals{i} <- shiny::reactiveValues(x = NULL, y = NULL)\n',
      'oe <- shiny::observeEvent(input$bg_f_polyg_{i}, {{\n',
      '  if (drawing()) {{\n',
      '    page2_polygon_vals{i}$x <- c(page2_polygon_vals{i}$x, input$bg_f_polyg_{i}$x)\n',
      '    page2_polygon_vals{i}$y <- c(page2_polygon_vals{i}$y, input$bg_f_polyg_{i}$y)\n',
      '  }}\n',
      '}})\n',
      'page2_circle_cell{i} <- reactive({{\n',
      '  if(!is.null(page2_polygon_vals{i}$x)){{\n',
      '    cir1 <- data.table(imagecol = page2_polygon_vals{i}$x, imagerow = page2_polygon_vals{i}$y)\n',
      '    # colnames(cir1) <- c(\'imagecol\', \'imagerow\')\n',
      '    cir1\n',
      '  }}else{{NULL}}}}) \n',
      'observeEvent(input$circle_select2, {{\n',
      '  if (!is.null(page2_circle_cell{i}()) & input$cluster2 != \'\') {{\n',
      '    meta_h_new <- h_meta$meta\n',
      '    meta_h_new$group <- as.character(meta_h_new$group)\n',
      '    cells <- polygon_select(meta = add_meta{i}(), polygon = page2_circle_cell{i}())\n',
      '    meta_h_new[which(meta_h_new$sampleID %in% cells), \'group\'] <- input$cluster2\n',
      '    meta_h_new$group <- factor(meta_h_new$group,levels = unique(Clusters2()))\n',
      '    h_meta$meta <- meta_h_new\n',
      '  }}}})\n',
      '### bgplot \n',
      'output$bg_plot_f{i} <- renderPlot({{\n',
      '  if (length(which(meta_group_add$meta$group == input$meta2_select)) > 0) {{\n',
      '    spatial_dimplot(\n',
      '      meta_slice = add_meta{i}(),\n',
      '      meta_group = meta_group_add$meta,\n',
      '      col.by = input$meta2_select,\n',
      '      input_image = image_slice{i}$images\n',
      '    )\n',
      '  }} else if (input$meta2_select == \'group\') {{\n',
      '    spatial_high_select(input_image = image_slice{i}$images,meta_slice = h_meta{i}(),pt.alpha = 0.7)\n',
      '  }}\n',
      '}})\n',
      'output$plot_f{i}_sm <- shiny::renderPlot({{\n',
      '  graphics::par(pty = \'s\',\n',
      '                mar = c(0, 0, 1, 0),\n',
      '                oma = c(0, 0, 1, 0))\n',
      '  graphics::plot(\n',
      '    x = page2_polygon_vals{i}$x,\n',
      '    y = page2_polygon_vals{i}$y,\n',
      '    type = \"l\",\n',
      '    xlim = unit(range_slice{i}$range[[1]], \'npc\'),\n',
      '    ylim = unit(range_slice{i}$range[[2]], \'npc\'),\n',
      '    \n',
      '    xlab = NA_character_,\n',
      '    ylab = NA_character_,\n',
      '    axes = FALSE,\n',
      '    main = base::ifelse(test = drawing(),\n',
      '                        yes = \"You are drawing\",\n',
      '                        no = \"\")\n',
      '  )\n',
      '}}, bg = \"transparent\")\n',
      '### feature plot\n',
      'output$gene_feature1_{i} <- renderPlot({{\n',
      '  fthighlightplot(\n',
      '    plotaction = input$plotout2,genesets = genesets,meta = h_meta$meta,\n',
      '    meta_slice = h_meta{i}(),\n',
      '    input_image = image_slice{i}$images,\n',
      '    gene = input$gene_f1,\n',
      '    data = data\n',
      '  )}})\n',
      'output$gene_feature2_{i} <- renderPlot({{\n',
      '  fthighlightplot(\n',
      '    plotaction = input$plotout2,genesets = genesets,meta = h_meta$meta,\n',
      '    meta_slice = h_meta{i}(),\n',
      '    input_image = image_slice{i}$images,\n',
      '    gene = input$gene_f2,\n',
      '    data = data\n',
      '  )\n',
      '}})\n',
      '### bg click\n',
      'observeEvent(input$bg_f_click_{i}, {{\n',
      '  if (!is.null(input$bg_f_click_{i}) & input$cluster2 != \'\') {{\n',
      '    meta_h_new <- h_meta$meta\n',
      '    coord <- input$bg_f_click_{i}\n',
      '    coord$mapping <- list(\'x\' = \'imagecol\',\n',
      '                          \'y\' = \'imagerow\')\n',
      '    meta_h_new$group <- as.character(meta_h_new$group)\n',
      '    if (length(which(meta_group_add$meta$group[meta_group_add$meta$info == T] == input$meta2_select)) > 0) {{\n',
      '      state <-\n',
      '        nearPoints(\n',
      '          add_meta{i}(),\n',
      '          coord,\n',
      '          addDist = TRUE,\n',
      '          maxpoints = 1,\n',
      '          threshold = 10)\n',
      '      cells <-\n',
      '        add_meta{i}()[which(add_meta{i}()[[input$meta2_select]] %in% state[[input$meta2_select]]), sampleID]\n',
      '    }}else if(input$meta2_select == \'group\'){{\n',
      '      state <-\n',
      '        nearPoints(\n',
      '          h_meta{i}(),\n',
      '          coord,\n',
      '          addDist = TRUE,\n',
      '          maxpoints = input$select_size2 / 10,\n',
      '          threshold = input$select_size2\n',
      '        )\n',
      '      cells <- state$sampleID\n',
      '    }}else{{\n',
      '      state <-\n',
      '        nearPoints(\n',
      '          add_meta{i}(),\n',
      '          coord,\n',
      '          addDist = TRUE,\n',
      '          maxpoints = 1,\n',
      '          threshold = 10\n',
      '        )\n',
      '      cells <- state$sampleID\n',
      '    }}\n',
      '    if(length(which(!is.na(meta_h_new[sampleID %in% cells,group]))) == length(cells) & length(unique(meta_h_new[sampleID %in% cells,group])) == 1){{\n',
      '      if(unique(meta_h_new$group[meta_h_new$sampleID %in% cells]) == input$cluster2){{\n',
      '        meta_h_new$group[meta_h_new$sampleID %in% cells] <- NA\n',
      '      }}else{{\n',
      '        meta_h_new$group[meta_h_new$sampleID %in% cells] <- input$cluster2\n',
      '      }}\n',
      '    }}else{{\n',
      '      \n',
      '      meta_h_new$group[meta_h_new$sampleID %in% cells] <- input$cluster2\n',
      '    }}\n',
      '    meta_h_new$group <- factor(meta_h_new$group,levels = unique(Clusters2()))\n',
      '    \n',
      '    h_meta$meta <- meta_h_new}}}})\n',

      '# dowload plot\n',
      'output$ft_g1_spot{i}.pdf <- downloadHandler(\n',
      '  filename = function() {{ paste0(\"group\",\"_\",input$gene_f1,\".pdf\") }},\n',
      '  content = function(file) {{\n',
      '    pdf(file = file,height = input$ft_g1_spot{i}.h,width = input$ft_g1_spot{i}.w)\n',
      '    fthighlightplot(\n',
      '      plotaction = input$plotout2,genesets = genesets,meta = h_meta$meta,\n',
      '      meta_slice = h_meta{i}(),\n',
      '      input_image = image_slice{i}$images,\n',
      '      gene = input$gene_f1,\n',
      '      data = data\n',
      '    )\n',
      '    dev.off()\n',
      '  }})\n',
      'output$ft_g1_spot{i}.png <- downloadHandler(\n',
      '  filename = function() {{paste0(\"group\", \"_\",input$gene_f1, \".png\")}},\n',
      '  content = function(file) {{\n',
      '    png(file = file)\n',
      '    fthighlightplot(\n',
      '      plotaction = input$plotout2,genesets = genesets,meta = h_meta$meta,\n',
      '      meta_slice = h_meta{i}(),\n',
      '      input_image = image_slice{i}$images,\n',
      '      gene = input$gene_f1,\n',
      '      data = data\n',
      '    )\n',
      '    dev.off()\n',
      '  }}\n',
      ')\n',
      'output$ft_g2_spot{i}.pdf <- downloadHandler(\n',
      '  filename = function() {{ paste0(\"group\",\"_\",input$gene_f2,\".pdf\") }},\n',
      '  content = function(file) {{\n',
      '    pdf(file = file,height = input$ft_g2_spot{i}.h,width = input$ft_g2_spot{i}.w)\n',
      '    fthighlightplot(\n',
      '      plotaction = input$plotout2,genesets = genesets,meta = h_meta$meta,\n',
      '      meta_slice = h_meta{i}(),\n',
      '      input_image = image_slice{i}$images,\n',
      '      gene = input$gene_f2,\n',
      '      data = data\n',
      '    )\n',
      '    dev.off()\n',
      '  }})\n',
      'output$ft_g2_spot{i}.png <- downloadHandler(\n',
      '  filename = function() {{paste0(\"group\", \"_\",input$gene_f2, \".png\")}},\n',
      '  content = function(file) {{\n',
      '    png(file = file)\n',
      '    fthighlightplot(\n',
      '      plotaction = input$plotout2,genesets = genesets,meta = h_meta$meta,\n',
      '      meta_slice = h_meta{i}(),\n',
      '      input_image = image_slice{i}$images,\n',
      '      gene = input$gene_f2,\n',
      '      data = data\n',
      '    )\n',
      '    dev.off()\n',
      '  }}\n',
      ')\n\n'
    )
    slice_path <- paste(slice_path, slice_process, sep = '')
  }

  slice_path <- glue::glue('{slice_path}')

  return(
    glue::glue(
      '{page2_server_head}\n',
      '{p2_cir}\n',
      '{p2_res}\n',
      '{slice_path}\n'
    )
  )

}
### page3
page3_server <- function(df_select) {
  page3_server_head <- glue::glue(
    '## page3 ####################################################################\n',
    'updateSelectizeInput(session,\n',
    '  \"vio_y\",choices = names(genesets),\n',
    '  server = TRUE,selected = df_select$genes,\n',
    '  options = list(maxOptions = 10,\n',
    '  create = TRUE,persist = TRUE,render = I(optCrt)))\n',
    'output$sc1a1sub1.ui <- renderUI({{ \n',
    '  sub = strsplit(meta_group[meta_group$group == input$meta_tog2,unit], \"\\\\|\")[[1]] \n',
    '  checkboxGroupInput(\"unit2\", \"Select which cells to show\", inline = TRUE, choices = sub, selected = sub)}})\n',
    'observeEvent(input$sc1a1sub1non, {{\n',
    '  sub = strsplit(meta_group[meta_group$group == input$meta_tog2,unit], \"\\\\|\")[[1]]\n',
    '  updateCheckboxGroupInput(session, inputId = \"unit2\", label = \"Select which cells to show\",\n',
    '                           choices = sub, selected = NULL, inline = TRUE)}})\n',
    'observeEvent(input$sc1a1sub1all, {{\n',
    '  sub = strsplit(meta_group[meta_group$group == input$meta_tog2,unit], \"\\\\|\")[[1]]\n',
    '  updateCheckboxGroupInput(session, inputId = \"unit2\", label = \"Select which cells to show\",\n',
    '                           choices = sub, selected = sub, inline = TRUE)}})\n',

    'output$vb_plot<- renderPlot({{\n',
    '  outvbplot(x = input$vio_x,y = input$vio_y,genesets = genesets,data = data,\n',
    '    meta_group = meta_group_add$meta,meta = add_meta$meta,\n',
    '    groupby = input$vio_gb,plot_type = input$plot_type,pt_p = input$point_ex,hgroup = input$meta_tog2,hcluster = input$unit2)}})\n',
    'output$vb_spot.pdf <- downloadHandler(\n',
    '  filename = function() {{ paste0(\"group\",\"_\",input$vio_x,\".pdf\") }},\n',
    '  content = function(file) {{\n',
    '    ggsave( \n',
    '    file, device = \"pdf\", height = input$vb_spot.h, width = input$vb_spot.w, \n',
    '    plot = outvbplot(x = input$vio_x,y = input$vio_y,\n',
    '      genesets = genesets,data = data,meta_group = meta_group_add$meta,\n',
    '      meta = add_meta$meta,groupby = input$vio_gb,plot_type = input$plot_type,\n',
    '      pt_p = input$point_ex,hgroup = input$meta_tog2,hcluster = input$unit2) )\n',
    '  }})\n',
    'output$vb_spot.png <- downloadHandler( \n',
    '  filename = function() {{ paste0(\"group\", \"_\", \".png\") }}, \n',
    '  content = function(file) {{ ggsave( \n',
    '    file, device = \"png\", height = input$vb_spot.h, width = input$vb_spot.w, \n',
    '    plot = outvbplot(x = input$vio_x,y = input$vio_y,\n',
    '      genesets = genesets,data = data,meta_group = meta_group_add$meta,\n',
    '      meta = add_meta$meta,groupby = input$vio_gb,plot_type = input$plot_type,\n',
    '      pt_p = input$point_ex,hgroup = input$meta_tog2,hcluster = input$unit2) ) }})\n\n\n'
  )

  slice_p3 <- c()
  for (i in 1:length(df_select$slice)) {
    slice_process <- glue::glue(
      'output$vb_bg_plot{i}<- renderPlot({{\n',
      '  spatial_dimplot(meta_slice = add_meta{i}(),\n',
      '                  meta_group = meta_group_add$meta,col.by = input$subspot,\n',
      '                  input_image = image_slice{i}$images)}})\n',
      'observeEvent(input$unit2,{{\n',
      '  output$vb_bg_plot{i}<- renderPlot({{\n',
      '    cell <- add_meta$meta[which(add_meta$meta[[input$meta_tog2]] %in% input$unit2),sampleID]\n',
      '    spatial_dimplot(meta_slice = add_meta{i}(),meta_group = meta_group_add$meta,\n',
      '                    col.by = input$subspot,input_image = image_slice{i}$images,highlight = cell)}})}})\n\n\n'
    )
    slice_p3 <- paste(slice_p3, slice_process, sep = '')
  }
  slice_p3 <- glue::glue('{slice_p3}')

  return(glue::glue('{page3_server_head}\n', '{slice_p3}\n'))
}
### page4
page4_server <- function(df_select) {
  page4_server_head <- glue::glue(
    '## page4 ############################################### \n',
    'output$spotsub1.ui <- renderUI({{ \n',
    '  sub = strsplit(meta_group[meta_group$group == input$meta_tog_por2,unit], \"\\\\|\")[[1]] \n',
    '  checkboxGroupInput(\"unitp\", \"Select which cells to show\", inline = TRUE, choices = sub, selected = sub) }})\n',
    'observeEvent(input$spotsubnon, {{\n',
    '  sub = strsplit(meta_group[meta_group$group == input$meta_tog_por2,unit], \"\\\\|\")[[1]]\n',
    '  updateCheckboxGroupInput(session, inputId = \"unitp\", label = \"Select which cells to show\",choices = sub, selected = NULL, inline = TRUE)}})\n',
    'observeEvent(input$spotsuball, {{\n',
    '  sub = strsplit(meta_group[meta_group$group == input$meta_tog_por2,unit], \"\\\\|\")[[1]]\n',
    '  updateCheckboxGroupInput(session, inputId = \"unitp\", label = \"Select which cells to show\",choices = sub, selected = sub, inline = TRUE)}})\n',

    'output$por_plot<- renderPlot({{\n',
    '  outbarplot(meta_group = meta_group_add$meta,\n',
    '    meta = add_meta$meta,groupby = input$por_group,\n',
    '    x = input$por_x,hgroup = input$meta_tog_por2,\n',
    '    hcluster = input$unitp,value = input$tab_type,xyflip = input$flipxy)}})\n',
    'output$bar_spot.pdf <- downloadHandler( \n',
    '  filename = function() {{ paste0(\"group\", \"_\",input$por_x, \".pdf\") }}, \n',
    '  content = function(file) {{ ggsave( \n',
    '    file, device = \"pdf\", height = input$bar_spot.h, width = input$bar_spot.w, \n',
    '    plot = outbarplot(meta_group = meta_group_add$meta,\n',
    '      meta = add_meta$meta,groupby = input$por_group,\n',
    '      x = input$por_x,hgroup = input$meta_tog_por2,\n',
    '      hcluster = input$unitp,value = input$tab_type,xyflip = input$flipxy) ) }})\n\n\n',
    'output$bar_spot.png <- downloadHandler( \n',
    '  filename = function() {{ paste0(\"group\", \"_\",input$por_x, \".png\") }}, \n',
    '  content = function(file) {{ ggsave( \n',
    '    file, device = \"png\", height = input$bar_spot.h, width = input$bar_spot.w, \n',
    '    plot = outbarplot(meta_group = meta_group_add$meta,\n',
    '      meta = add_meta$meta,groupby = input$por_group,\n',
    '      x = input$por_x,hgroup = input$meta_tog_por2,\n',
    '      hcluster = input$unitp,value = input$tab_type,xyflip = input$flipxy) ) }})\n\n\n'
  )

  slice_p4 <- c()
  for (i in 1:length(df_select$slice)) {
    slice_process <- glue::glue(
      'output$por_bg_plot{i}<- renderPlot({{\n',
      '  spatial_dimplot(meta_slice = add_meta{i}(),\n',
      '    meta_group = meta_group_add$meta,\n',
      '    col.by = input$subspot2,\n',
      '    input_image = image_slice{i}$images)}})\n',
      'observeEvent(input$unitp,{{\n',
      '  output$por_bg_plot{i}<- renderPlot({{\n',
      '    cell <- add_meta$meta[which(add_meta$meta[[input$meta_tog_por2]] %in% input$unitp),sampleID]\n',
      '    spatial_dimplot(meta_slice = add_meta{i}(),meta_group = meta_group_add$meta,\n',
      '        col.by = input$subspot2,input_image = image_slice{i}$images,highlight = cell)}})}})\n\n\n'
    )

    slice_p4 <- paste(slice_p4, slice_process, sep = '')
  }
  slice_p4 <- glue::glue('{slice_p4}')

  return(glue::glue('{page4_server_head}\n', '{slice_p4}\n'))
}
### page5
page5_server <- function(df_select) {
  page5_server_head <- glue::glue(
    '## page5 ###############################################   \n',
    'output$geneexpsub.ui <- renderUI({{ \n',
    '  sub = strsplit(meta_group[meta_group$group == input$meta_tog3,unit], \"\\\\|\")[[1]] \n',
    '  checkboxGroupInput(\"unitexp\", \"Select which cells to show\", inline = TRUE, choices = sub, selected = sub) }})\n',
    'observeEvent(input$geneexpsubnon, {{\n',
    '  sub = strsplit(meta_group[meta_group$group == input$meta_tog3,unit], \"\\\\|\")[[1]]\n',
    '  updateCheckboxGroupInput(session, inputId = \"unitexp\", label = \"Select which cells to show\",\n',
    '  choices = sub, selected = NULL, inline = TRUE)}})\n',
    'observeEvent(input$geneexpsuball, {{\n',
    '  sub = strsplit(meta_group[meta_group$group == input$meta_tog3,unit], \"\\\\|\")[[1]]\n',
    '  updateCheckboxGroupInput(session, inputId = \"unitexp\", label = \"Select which cells to show\",\n',
    '  choices = sub, selected = sub, inline = TRUE)}})\n',

    'output$exp_plot<- renderPlot({{\n',
    '  dot_heat_plot(genesets = genesets,genelists = input$inpgenelist,\n',
    '    groupby = input$expgroup,tab_meta = add_meta$meta,\n',
    '    plot_type = input$exp_plot_type,inpRow = input$rclust,\n',
    '    inpCol = input$cclust,data = data,scale_build = input$scl_exp,\n',
    '    meta_group = meta_group_add$meta,hgroup = input$meta_tog3,hcluster = input$unitexp)}})\n',
    'output$heat_spot.pdf <- downloadHandler( \n',
    '  filename = function() {{ paste0(\"group\", \"_\",input$expgroup, \".pdf\") }}, \n',
    '  content = function(file) {{ ggsave( file, device = \"pdf\", height = input$heat_spot.h, width = input$heat_spot.w, \n',
    '    plot = dot_heat_plot(genesets = genesets,genelists = input$inpgenelist,groupby = input$expgroup,\n',
    '      tab_meta = add_meta$meta,plot_type = input$exp_plot_type,inpRow = input$rclust,inpCol = input$cclust,data = data,\n',
    '      scale_build = input$scl_exp,meta_group = meta_group_add$meta,hgroup = input$meta_tog3,hcluster = input$unitexp) ) }})\n\n\n',
    'output$heat_spot.png <- downloadHandler( \n',
    '  filename = function() {{ paste0(\"group\", \"_\",input$expgroup, \".png\") }}, \n',
    '  content = function(file) {{ ggsave( file, device = \"png\", height = input$heat_spot.h, width = input$heat_spot.w, \n',
    '    plot = dot_heat_plot(genesets = genesets,genelists = input$inpgenelist,groupby = input$expgroup,\n',
    '      tab_meta = add_meta$meta,plot_type = input$exp_plot_type,inpRow = input$rclust,inpCol = input$cclust,data = data,\n',
    '      scale_build = input$scl_exp,meta_group = meta_group_add$meta,hgroup = input$meta_tog3,hcluster = input$unitexp) ) }})\n\n\n'
  )

  slice_p5 <- c()
  for (i in 1:length(df_select$slice)) {
    slice_process <- glue::glue(
      'output$exp_bg_plot{i}<- renderPlot({{\n',
      '  spatial_dimplot(meta_slice = add_meta{i}(),\n',
      '    meta_group = meta_group_add$meta,col.by = input$subspot3,\n',
      '    input_image = image_slice{i}$images)}})\n',
      'observeEvent(input$unitexp,{{\n',
      '  output$exp_bg_plot{i}<- renderPlot({{\n',
      '    cell <- add_meta$meta[which(add_meta$meta[[input$meta_tog3]] %in% input$unitp),sampleID]\n',
      '    spatial_dimplot(meta_slice = add_meta{i}(),meta_group = meta_group_add$meta,\n',
      '                    col.by = input$subspot3,input_image = image_slice{i}$images)}})}})\n\n\n'
    )
    slice_p5 <- paste(slice_p5, slice_process, sep = '')
  }

  slice_p5 <- glue::glue('{slice_p5}')

  return(glue::glue('{page5_server_head}\n', '{slice_p5}\n'))
}
### page6
page6_server <- function(df_select) {
  page6_server_head <- glue::glue(
    '## page6  ########################################################  \n',
    'updateSelectizeInput(session,\"coexgene1\",\n',
    '  choices = df_select$genes,server = TRUE,\n',
    '  selected = df_select$gene1,\n',
    '  options = list(maxOptions = 7,create = TRUE,\n',
    '    persist = TRUE,render = I(optCrt)))\n',

    'updateSelectizeInput(session,\"coexgene2\",\n',
    '  choices = df_select$genes,server = TRUE,\n',
    '  selected = df_select$gene2,\n',
    '  options = list(maxOptions = 7,create = TRUE,\n',
    '    persist = TRUE,render = I(optCrt)))\n',

    'highlightcell <- reactiveVal(value = NULL)\n',

    'output$coexp_leg <- renderPlot({{coexleg(gene1 = input$coexgene1,gene2 = input$coexgene2,inpcol = input$col_sel)}})\n',

    'output$coexp_table <- renderDT({{\n',
    '  if(input$group_tab == \'No\'){{\n',
    '    new_group <- NULL\n',
    '  }}else{{new_group <- input$group_tab}}\n',
    '  new_tab <- coexp_tab(tab_meta = add_meta$meta,metagroup = meta_group_add$meta,\n',
    '    data = data,genesets = genesets,gene1 = input$coexgene1,gene2 = input$coexgene2,\n',
    '    highlight = highlightcell(),threshold1 = input$thrd1,threshold2 = input$thrd2,new_group = new_group)\n',
    '  DT::datatable(new_tab,rownames = FALSE,extensions = \"Buttons\",\n',
    '    options = list(pageLength = 4,dom = \"Bfrtip\",searching = TRUE,buttons = c(\"copy\", \"csv\", \"excel\", \'pdf\')))}})\n',

    'observeEvent(input$reset_coexp,{{highlightcell(NULL)}})\n',

    '#######################################\n',

    'observeEvent(input$swi_spinfo, {{\n',
    '  new_meta <- add_meta$meta\n',
    '  new_group <- meta_group_add$meta\n',
    '  new_col <- input$new_title\n',
    '  if (!is.null(input$impspifo)) {{\n',
    '    sps <- strsplit(input$impspifo, split = \"\n\")[[1]]\n',
    '    if (!is.null(new_col)) {{\n',
    '      if (length(sps) == nrow(add_meta$meta)) {{\n',
    '        sps[which(sps == \'\')] <- NA\n',
    '        new_meta[, new_col] <- NA\n',
    '        new_meta[[new_col]] <- sps\n',
    '        new_meta[[new_col]] <- as.factor(new_meta[[new_col]])\n',
    '        unit_n <-\n',
    '          paste(levels(new_meta[[new_col]]), collapse = \'\\\\|\')\n',
    '        cols <- col_box[1:length(levels(new_meta[[new_col]]))]\n',
    '        cols <- paste(cols, collapse = \'|\')\n',
    '        tmp <- data.table(group = new_col,unit = unit_n,color = cols,info = TRUE,default = 0)\n',
    '        new_group <-rbindlist(list(new_group, tmp))}}}}}}\n',
    '  add_meta$meta <- new_meta\n',
    '  meta_group_add$meta <- new_group}})\n',
    '}}\n\n\n'
  )

  slice_p6 <- c()
  for (i in 1:length(df_select$slice)) {
    slice_process <- glue::glue(
      '## backgroud plot\n',
      'output$coexp_bg_plot{i} <- renderPlot({{\n',
      '  spatial_dimplot(meta_slice = add_meta{i}(),\n',
      '                  meta_group = meta_group_add$meta,\n',
      '                  col.by = input$meta3_select,\n',
      '                  input_image = image_slice{i}$images)}})\n',
      'observeEvent(input$coexp_click_{i},{{\n',
      '  if(length(intersect(unique(highlightcell()), add_meta$meta$sampleID)) == nrow(add_meta$meta)){{\n',
      '    highlightcell(NULL)}}}})\n',
      'observeEvent(input$coexp_click_{i}, {{\n',
      '  if (!is.null(input$coexp_click_{i})) {{\n',
      '    newcells <- highlightcell()\n',
      '    coord <- input$coexp_click_{i}\n',
      '    coord$mapping <- list(\'x\' = \'imagecol\',\'y\' = \'imagerow\')\n',
      '    if (length(which(meta_group_add$meta$group == input$meta3_select)) > 0) {{\n',
      '      state <-nearPoints(add_meta{i}(),coord,addDist = TRUE,maxpoints = 1,threshold = 10)\n',
      '      cells <- add_meta{i}()$sampleID[which(add_meta{i}()[[input$meta3_select]] %in% state[[input$meta3_select]])]\n',
      '    }} else{{cells <- NULL}}\n',
      '    newcells <- c(newcells, cells)\n',
      '    tabs <- table(newcells) %>% as.data.frame()\n',
      '    newcells <- subset(tabs,tabs$Freq == 1)$newcells %>% as.character()\n',
      '    highlightcell(newcells)}}}})\n',
      'output$coexpfeature{i} <- renderPlot({{\n',
      '  if (is.null(highlightcell()) |\n',
      '      length(intersect(highlightcell(), add_meta$meta$sampleID)) == 0) {{\n',
      '    highlight = \'All\'\n',
      '  }}else{{highlight <- intersect(highlightcell(), add_meta$meta$sampleID)}}\n',
      '  coexp_feature(meta_slice = add_meta{i}(),meta_all = add_meta$meta,\n',
      '                data = data,genesets = genesets,gene1 = input$coexgene1,\n',
      '                gene2 = input$coexgene2,input_image = image_slice{i}$images,\n',
      '                highlight = highlight,threshold1 = input$thrd1,inpcol = input$col_sel,\n',
      '                threshold2 = input$thrd2)}})\n',
      '## dowload plot\n',
      'output$coexpfeature{i}.pdf <- downloadHandler(\n',
      '  filename = function() {{ paste0(input$coexgene1,\"_\",input$coexgene2,\"_\",1,\".pdf\") }},\n',
      '  content = function(file) {{pdf(file = file,height = input$coexpfeature{i}.h,width = input$coexpfeature{i}.w)\n',
      '    if (is.null(highlightcell()) |\n',
      '        length(intersect(highlightcell(), add_meta$meta$sampleID)) == 0) {{\n',
      '      highlight = \'All\'}}else{{highlight <- intersect(highlightcell(), add_meta$meta$sampleID)}}\n',
      '    coexp_feature(meta_slice = add_meta{i}(),meta_all = add_meta$meta,\n',
      '        data = data,genesets = genesets,gene1 = input$coexgene1,gene2 = input$coexgene2,\n',
      '        input_image = image_slice{i}$images,highlight = highlight,\n',
      '        threshold1 = input$thrd1,inpcol = input$col_sel,threshold2 = input$thrd2)\n',
      '    dev.off()\n',
      '  }})\n',
      'output$coexpfeature{i}.png <- downloadHandler(\n',
      '  filename = function() {{paste0(input$coexgene1,\"_\",input$coexgene2,\"_\",1,\".png\")}},\n',
      '  content = function(file) {{\n',
      '    png(file = file)\n',
      '    if (is.null(highlightcell()) |\n',
      '        length(intersect(highlightcell(), add_meta$meta$sampleID)) == 0) {{\n',
      '      highlight = \'All\'\n',
      '    }}else{{highlight <- intersect(highlightcell(), add_meta$meta$sampleID)}}\n',
      '    coexp_feature(meta_slice = add_meta{i}(),meta_all = add_meta$meta,\n',
      '        data = data,genesets = genesets,gene1 = input$coexgene1,gene2 = input$coexgene2,\n',
      '        input_image = image_slice{i}$images,highlight = highlight,\n',
      '        threshold1 = input$thrd1,inpcol = input$col_sel,threshold2 = input$thrd2)\n',
      '    dev.off()\n',
      '  }})\n\n\n'
    )
    slice_p6 <- paste(slice_p6, slice_process, sep = '')
  }

  slice_p6 <- glue::glue('{slice_p6}')

  return(glue::glue('{slice_p6}\n', '{page6_server_head}\n'))
}
