## load package in server script
lib_server <- function() {
  lib <- glue::glue(
    'library(shiny)\n',
    'library(shinyhelper)\n',
    'library(data.table)\n',
    'library(Matrix)\n',
    'library(DT)\n',
    'library(magrittr)\n',
    'library(ggplot2)\n',
    'library(ggrepel)\n',
    'library(hdf5r)\n',
    'library(ggdendro)\n',
    'library(gridExtra)\n',
    'library(dplyr)\n',
    'library(scales)\n',
    'library(patchwork)\n',
    'library(RColorBrewer)\n',
    'library(Seurat)\n',
    'library(shinydashboard)\n',
    'library(maps)\n',
    'library(Cairo)\n',
    'library(dplyr)\n',
    'library(grid)\n',
    'library(ggtree)\n',
    'library(aplot)\n',
    'library(ggiraph)\n',
    'library(scatterpie)\n',
    'library(ggpubr)\n\n'
  )
  return(lib)
}
## plot color in server script
col_server <- function() {
  col <- glue::glue(
    'heat_col <- c(\"#0000FF\", \"#0013FF\", \"#0028FF\", \"#003CFF\", \"#0050FF\", \"#0065FF\", \"#0078FF\", \"#008DFF\", \"#00A1FF\", \"#00B5FF\",\n',
    '              \"#00CAFF\", \"#00DEFF\", \"#00F2FF\", \"#27FFD7\", \"#8CFF71\", \"#F1FF0D\", \"#FFEE00\", \"#FFDB00\", \"#FFC900\", \"#FFB700\",\n',
    '              \"#FFA500\", \"#FF9200\", \"#FF8000\", \"#FF6D00\", \"#FF5B00\", \"#FF4800\", \"#FF3600\", \"#FF2400\", \"#FF1200\", \"#FF0000\")\n',
    'col_box <-\n',
    '  c(\n',
    '    \'#ff3030\',\'#1e90ff\',\'#ffd700\',\'#ff6eb4\',\'#bf3eff\',\n',
    '    \'#c1ffc1\',\'#00ffff\',\'#ff1493\',\'#7fff00\',\'#ff0000\',\n',
    '    \'#0000ff\',\'#00ff00\',\'#ffc125\',\'#ffb5c5\',\'#9b30ff\',\n',
    '    \'#54ff9f\',\'#87ceff\',\'#ffaeb9\',\'#c0ff3e\',\'#ff4040\',\n',
    '    \'#836fff\',\'#00ff7f\',\'#ffff00\',\'#ff3e96\',\'#ff83fa\',\n',
    '    \'#9aff9a\',\'#4876ff\',\'#ff3e96\',\'#00f5ff\',\'#8b1a1a\',\n',
    '    \'#104e8b\',\'#008b00\',\'#8b7500\',\'#8b3a62\',\'#68228b\',\n',
    '    \'#698b69\',\'#008b8b\',\'#8b0a50\',\'#458b00\',\'#eedfcc\',\n',
    '    \'#76eec6\',\'#eec591\',\'#dbe9e9\',\'#8ee5ee\',\'#ee6a50\',\n',
    '    \'#eee8cd\',\'#eead0e\',\'#bcee68\',\'#ee7600\',\'#8deeee\',\n',
    '    \'#00b2ee\',\'#ee6363\',\'#eeeee0\',\'#eee685\',\'#b2dfee\',\n',
    '    \'#eedc82\',\'#ee00ee\',\'#ee30a7\',\'#006400\')\n\n'
  )
  return(col)
}
## load data in server script
data_server <- function(df_select) {
  dat <- glue::glue(
    'meta <- readRDS(\'meta.Rds\')\n',
    'meta_group <- readRDS(\'meta_group.Rds\')\n',
    'genesets <- readRDS(\'genesets.Rds\')\n',
    'df_select <- readRDS(\'df_select.Rds\')\n',
    'image <- readRDS(\'image.Rds\')\n',
    'data = \"data.h5\"\n',
    'meta$group <- NA\n\n\n'
  )
  
  if(length(df_select$cell) > 0){
    dat2 <- 'deconvolusion <- readRDS(\'deconvolusion.Rds\')\n\n\n'
  }else{
    dat2 <- '\n\n'
  }
  dat <- glue::glue(paste0(dat,dat2))
  
  return(dat)
}


data_server_web <- function(df_select,dir,tmpdir) {
  dat <- glue::glue(
    'meta <- readRDS(\'{dir}/meta.Rds\')\n',
    'meta_group <- readRDS(\'{tmpdir}/{dir}/meta_group.Rds\')\n',
    'genesets <- readRDS(\'{tmpdir}/{dir}/genesets.Rds\')\n',
    'df_select <- readRDS(\'{tmpdir}/{dir}/df_select.Rds\')\n',
    'image <- readRDS(\'{tmpdir}/{dir}/image.Rds\')\n',
    'data = \"{tmpdir}/{dir}/data.h5\"\n',
    'meta$group <- NA\n\n\n'
  )
  
  if(length(df_select$cell) > 0){
    dat2 <- 'deconvolusion <- readRDS(\'deconvolusion.Rds\')\n\n\n'
  }else{
    dat2 <- '\n\n'
  }
  dat <- glue::glue(paste0(dat,dat2))
  
  return(dat)
}
## function in server script
fun_server_web <- function() {
  afun <- glue::glue(
    '## spatialLIBD package\n',
    'geom_spatial <- function (mapping = NULL, data = NULL, stat = \"identity\", position = \"identity\", \n',
    '                          na.rm = FALSE, show.legend = NA, inherit.aes = FALSE, ...) \n',
    '{{\n',
    '  ggname <- function(prefix, grob) {{\n',
    '    grob$name <- grid::grobName(grob, prefix)\n',
    '    grob\n',
    '  }}\n',
    '  GeomCustom <- ggproto(\"GeomCustom\", Geom, setup_data = function(self, \n',
    '                                                                  data, params) {{\n',
    '    data <- ggproto_parent(Geom, self)$setup_data(data, params)\n',
    '    data\n',
    '  }}, draw_group = function(data, panel_scales, coord) {{\n',
    '    vp <- grid::viewport(x = data$x, y = data$y)\n',
    '    g <- grid::editGrob(data$grob[[1]], vp = vp)\n',
    '    ggname(\"geom_spatial\", g)\n',
    '  }}, required_aes = c(\"grob\", \"x\", \"y\"))\n',
    '  layer(geom = GeomCustom, mapping = mapping, data = data, \n',
    '        stat = stat, position = position, show.legend = show.legend, \n',
    '        inherit.aes = inherit.aes, params = list(na.rm = na.rm, \n',
    '                                                 ...))\n',
    '}}\n\n',
    'br_add <- function(height, break_add = NULL) {{\n',
    '  if (base::is.null(break_add)) {{\n',
    '    x <- base::ceiling((height - 400) / 100)\n',
    '    out <- x * 5\n',
    '  }} else {{\n',
    '    out <- break_add\n',
    '  }}\n',
    '  return(out)\n',
    '}}\n',
    'checkShortcut <- function(shortcut, valid, cursor_pos = NA) {{\n',
    '  shortcut <- shortcut[1]\n',
    '  if (!base::is.null(shortcut)) {{\n',
    '    if (!base::is.null(shortcut) && !shortcut %in% valid) {{\n',
    '      shiny::req(FALSE)\n',
    '    }}\n',
    '    if (shortcut == \"d\" && base::is.null(cursor_pos)) {{\n',
    '      confuns::give_feedback(\n',
    '        msg = \"The cursor must be inside the reactive image to use shortcut \'d\'.\",\n',
    '        fdb.fn = \"stop\",\n',
    '        in.shiny = TRUE,\n',
    '        with.time = FALSE\n',
    '      )\n',
    '    }}\n',
    '  }}}}\n',
    
    '### spatial plot\n',
    'spatial_dimplot <- function(input_image,\n',
    '                            meta_slice,\n',
    '                            meta_group,\n',
    '                            col.by = NULL,\n',
    '                            pt.alpha = 0.7,\n',
    '                            pt_size = 0.8) {{\n',
    '  if (!is.null(input_image)) {{\n',
    '    xrange <- c(25, dim(input_image)[2] - 25)\n',
    '    yrange <- c(25, dim(input_image)[1] - 25)\n',
    '  }} else{{\n',
    '    xrange <-\n',
    '      c(min(meta_slice$imagecol),\n',
    '        max(meta_slice$imagecol))\n',
    '    yrange <-\n',
    '      c(min(meta_slice$imagerow),\n',
    '        max(meta_slice$imagerow))\n',
    '  }}\n',
    '  if (!is.null(col.by)) {{\n',
    '    if (!col.by %in% meta_group$group) {{\n',
    '      stop(\"Don\'t have the feature\")\n',
    '    }}\n',
    '  }} else{{\n',
    '    if (length(which(meta_group$group == \'seurat_clusters\')) == 1) {{\n',
    '      col.by = \'seurat_clusters\'\n',
    '    }} else{{\n',
    '      stop(\"Don\'t have the meta\")\n',
    '    }}\n',
    '  }}\n',
    '  if (col.by %in% meta_group[meta_group$info == T, group]) {{\n',
    '    lev <-\n',
    '      strsplit(meta_group[group == col.by, unit], split = \'\\\\|\')[[1]]\n',
    '    cols_level <-\n',
    '      strsplit(meta_group[group == col.by, color], split = \'\\\\|\')[[1]]\n',
    '    names(cols_level) <- cols_level\n',
    '  }}\n',
    '  \n',
    '  \n',
    '  if(class(input_image) == \'array\' | class(input_image) == \'raster\'){{\n',
    '    grob <- grid::rasterGrob(input_image, width = grid::unit(1, \"npc\"),\n' ,
    '                         height = grid::unit(1, \"npc\"))\n',
    '     bg <- geom_spatial(data = tibble::tibble(grob = list(grob)), \n',
    '                  aes(grob = grob), x = 0.5, y = 0.5)\n',
    '    # bg <- ggpubr::background_image(input_image)\n',
    '  }}else{{\n',
    '    bg <- NULL\n',
    '  }}\n',
    '  \n',
    '  if (col.by %in% meta_group[meta_group$info == T, group]) {{\n',
    '    lab <- levels(meta_slice[[col.by]])\n',
    '    names(lab) <- lab\n',
    '    \n',
    '    names(cols_level) <- lab\n',
    '    \n',
    '    gg_scatter <- ggplot(\n',
    '      data = meta_slice,\n',
    '      mapping = aes_string(\n',
    '        x = \'imagecol\',\n',
    '        y = \'imagerow\',\n',
    '        color = col.by,\n',
    '        # here we add iteractive aesthetics\n',
    '        tooltip = \'tooltip\',\n',
    '        data_id = col.by\n',
    '      )\n',
    '    )+bg + xlim(xrange) + ylim(rev(yrange)) + theme_classic() + theme(\n',
    '      axis.line = element_blank(),\n',
    '      axis.text = element_blank(),\n',
    '      axis.ticks = element_blank(),\n',
    '      axis.title = element_blank(),\n',
    '      legend.position = \'top\',\n',
    '      legend.key.size = unit(2, \'mm\'),\n',
    '      legend.box.background = element_rect(fill = \'white\', colour = \'white\'),\n',
    '      legend.key = element_blank(), legend.text = element_text(size = 12)\n',
    '    ) + geom_point_interactive(size = pt_size, alpha = pt.alpha) + geom_col_interactive(\n',
    '      mapping = aes_string(\n',
    '        y = 1,\n',
    '        fill = col.by,\n',
    '        tooltip = \'tooltip\',\n',
    '        data_id = col.by\n',
    '      ),\n',
    '      linewidth = 1,\n',
    '      show.legend = FALSE\n',
    '    ) +\n',
    '      geom_text_interactive(\n',
    '        data = meta_slice,\n',
    '        aes_string(\n',
    '          x = 1994,\n',
    '          y = 9.2,\n',
    '          label = \'tooltip\',\n',
    '          data_id = col.by\n',
    '        ),\n',
    '        size = 2.5,\n',
    '        hjust = \"left\",\n',
    '        alpha = 0\n',
    '      ) + scale_color_manual_interactive(data_id = lab,\n',
    '                                         values = cols_level) + coord_fixed()\n',
    '  }} else{{\n',
    '    meta_slice$firm_lab <-\n',
    '      paste0(\'sampleID: \', meta_slice[[\'sampleID\']], \'\\n\', col.by, \': \', meta_slice[[col.by]])\n',
    '    \n',
    '    gg_scatter <- ggplot(\n',
    '      data = meta_slice,\n',
    '      mapping = aes_string(\n',
    '        x = \'imagecol\',\n',
    '        y = \'imagerow\',\n',
    '        color = col.by,\n',
    '        # here we add iteractive aesthetics\n',
    '        tooltip = \'firm_lab\',\n',
    '        data_id = \'sampleID\'\n',
    '      )\n',
    '    )+bg + xlim(xrange) + ylim(rev(yrange)) + theme_classic() + theme(\n',
    '      axis.line = element_blank(),\n',
    '      axis.text = element_blank(),\n',
    '      axis.ticks = element_blank(),\n',
    '      axis.title = element_blank(),\n',
    '      legend.position = \'top\'\n',
    '    ) + geom_point_interactive(size = pt_size, alpha = pt.alpha) + scale_color_distiller(palette = \"Spectral\") + coord_fixed()\n',
    '  }}\n',
    '  gg_scatter\n',
    '}}\n',
    '# spatial feature\n',
    'fthighlightplot <- function(input_image,\n',
    '                            meta_slice,\n',
    '                            genesets,\n',
    '                            meta_all,\n',
    '                            gene = NULL,\n',
    '                            # cols = NULL,\n',
    '                            pt.alpha = 1,\n',
    '                            highlight = NULL,\n',
    '                            data,\n',
    '                            pt_size = 1) {{\n',
    '  if (!is.null(input_image)) {{\n',
    '    xrange <- c(25, dim(input_image)[2] - 25)\n',
    '    yrange <- c(25, dim(input_image)[1] - 25)\n',
    '  }} else{{\n',
    '    xrange <-\n',
    '      c(min(meta_slice$imagecol),\n',
    '        max(meta_slice$imagecol))\n',
    '    yrange <-\n',
    '      c(min(meta_slice$imagerow),\n',
    '        max(meta_slice$imagerow))\n',
    '  }}\n',
    '  if (is.null(genesets) |\n',
    '      is.null(names(genesets)) | !is.numeric(genesets)) {{\n',
    '    stop(\'useless gene set\')\n',
    '  }}\n',
    '  if (is.null(gene) | length(which(names(genesets) == gene)) == 0) {{\n',
    '    shiny::validate(\"Wait a moment, gene ready to load or Don\'t have the gene!\")\n',
    '  }}\n',
    '  \n',
    '  meta_all$val <- data[gene,]\n',
    '  meta_slice <- meta_all[meta_all$sampleID %in% meta_slice$sampleID]\n',
    '  \n',
    '  if (class(input_image) == \'array\'| class(input_image) == \'raster\') {{\n',
    '    grob <- grid::rasterGrob(input_image, width = grid::unit(1, \"npc\"),\n' ,
    '                         height = grid::unit(1, \"npc\"))\n',
    '     bg <- geom_spatial(data = tibble::tibble(grob = list(grob)), \n',
    '                  aes(grob = grob), x = 0.5, y = 0.5)\n',
    '  }} else{{\n',
    '    bg <- NULL\n',
    '  }}\n',
    '  \n',
    '  meta_slice$firm_lab <-\n',
    '    paste0(\'sampleID: \', meta_slice[[\'sampleID\']], \'\\n\', gene, \': \', round(meta_slice[[\'val\']],4))\n',
    '  \n',
    '  \n',
    '  if(length(intersect(meta_slice$sampleID, highlight)) == 0 | length(intersect(meta_slice$sampleID, highlight)) == length(meta_slice$sampleID)){{\n',
    '    meta_slice$val\n',
    '  }}else{{\n',
    '    meta_slice$val[-which(meta_slice$sampleID %in% highlight)] <- NA\n',
    '  }}\n',
    '  \n',
    '  gg_scatter <- ggplot(\n',
    '    data = meta_slice,\n',
    '    mapping = aes_string(\n',
    '      x = \'imagecol\',\n',
    '      y = \'imagerow\',\n',
    '      color = \'val\',\n',
    '      tooltip = \'firm_lab\',\n',
    '      data_id = \'sampleID\'\n',
    '    )\n',
    '  ) + bg + xlim(xrange) + ylim(rev(yrange)) +\n',
    '    labs(colour = gene, shape = \'val\') + theme_classic() + \n',
    '    theme(\n',
    '      axis.line = element_blank(),\n',
    '      axis.text = element_blank(),\n',
    '      axis.ticks = element_blank(),\n',
    '      axis.title = element_blank(),\n',
    '      legend.position = \'top\'\n',
    '    ) + geom_point_interactive(size = pt_size, alpha = pt.alpha) + scale_color_distiller(palette = \"Spectral\") + coord_fixed()\n',
    '  \n',
    '  \n',
    '  gg_scatter\n',
    '}}\n',
    
    'inter_spatial <- function(gg_scatter,preselection=NULL,width_svg = 6,height_svg = 5,color = \'white\'){{\n',
    '  girafe(\n',
    '    ggobj = gg_scatter,width_svg = width_svg,height_svg = height_svg,\n',
    '    options = list(\n',
    '      # opts_hover_inv(css = \"opacity:0.5;\"),\n',
    '      opts_hover(css = girafe_css(\n',
    '        \"stroke-width:1.5;\"\n',
    '      )),\n',
    '      opts_hover_key(css = \"stroke:black;r:5pt;cursor:pointer;\"),\n',
    '      opts_selection_inv(css = \"opacity:0.4;\"),\n',
    '      opts_selection_key(css = \"stroke:black;r:5pt;\"),\n',
    '      opts_selection(selected = preselection,\n',
    '                     css = \"stroke-width:1.2;\",\n',
    '                     type = \'multiple\',\n',
    '                     only_shiny = F\n',
    '      ),\n',
    '      opts_tooltip(\n',
    '        opacity = 0.8,\n',
    '        use_fill = TRUE,\n',
    '        use_stroke = FALSE,\n',
    '        css = glue::glue(\"padding:5pt;font-family: Open Sans;font-size:1rem;color:{{color}}\")\n',
    '      ),\n',
    '      opts_toolbar(\n',
    '        hidden = NULL,\n',
    '        tooltips = list(\n',
    '          lasso_select = \"Mit Lasso auswählen\",\n',
    '          lasso_deselect = \"Mit Lasso abwählen\",\n',
    '          zoom_on = \"Ansicht beibehalten\",\n',
    '          zoom_off =  \"Ansicht bewegen/zoomen\",\n',
    '          zoom_rect = \"Mit Rechteckauswahl zoomen\",\n',
    '          zoom_reset = \"Ansicht wiederherstellen\",\n',
    '          saveaspng = \"Als PNG-Grafik speichern\"\n',
    '        ),position = \"top\"\n',
    '      ),\n',
    '      opts_zoom(min = .3, max = 2)\n',
    '      \n',
    '    )\n',
    '  )\n',
    '}}\n',
    
    '\n',
    '### vio/box\n',
    'outvbplot <- function(\n',
    '    x,\n',
    '    y,\n',
    '    meta_group,\n',
    '    meta,\n',
    '    data,\n',
    '    genesets,\n',
    '    groupby = \'No\',\n',
    '    plot_type = \'violin\',\n',
    '    highlight = NULL,\n',
    '    pt_p = FALSE,ynames = NULL) {{\n',
    '  if (groupby == \'No\') {{\n',
    '    groups = NULL\n',
    '    cols <-\n',
    '      strsplit(meta_group[which(meta_group$group == x), color], split = \"\\\\|\") %>% unlist()\n',
    '    clu <-\n',
    '      strsplit(meta_group[which(meta_group$group == x), unit], split = \"\\\\|\") %>% unlist()\n',
    '    \n',
    '    names(cols) <- clu\n',
    '  }} else{{\n',
    '    cols <-\n',
    '      strsplit(meta_group[which(meta_group$group == groupby), color], split = \"\\\\|\") %>% unlist()\n',
    '    clu <-\n',
    '      strsplit(meta_group[which(meta_group$group == groupby), unit], split = \"\\\\|\") %>% unlist()\n',
    '    groups = groupby\n',
    '  }}\n',
    '  \n',
    '  if (length(which(names(genesets) == y)) >= 1) {{\n',
    '    val <- data[y,]\n',
    '    meta[, y] <- val\n',
    '    h5file$close_all()\n',
    '  }}\n',
    '  \n',
    '  if(length(intersect(meta$sampleID, highlight)) == 0 | length(intersect(meta$sampleID, highlight)) == length(meta$sampleID)){{\n',
    '    meta <- meta\n',
    '  }}else{{\n',
    '    meta <- meta[which(meta$sampleID %in% highlight),]\n',
    '  }}\n',
    '  \n',
    '  tab_vb_plot(\n',
    '    tab_meta = meta,\n',
    '    x = x,\n',
    '    y = y,\n',
    '    group = groups,\n',
    '    plot = plot_type,ynames = ynames,\n',
    '    pt = pt_p\n',
    '  )\n',
    '}}\n',
    'tab_vb_plot <- function(tab_meta,\n',
    '                        x,\n',
    '                        y,\n',
    '                        group = NULL,\n',
    '                        plot = \'violin\',\n',
    '                        cols = NULL,ynames = \'gene expression\',\n',
    '                        pt = FALSE) {{\n',
    '  if (is.null(group) | length(which(x == group)) >= 1) {{\n',
    '    if (!is.factor(tab_meta[[x]])) {{\n',
    '      tab_meta[[x]] <- as.factor(tab_meta[[x]])\n',
    '    }}\n',
    '    \n',
    '    if (is.null(cols)) {{\n',
    '      cols <- col_box[1:length(levels(tab_meta[[x]]))]\n',
    '      names(cols) <- levels(tab_meta[[x]])\n',
    '    }}\n',
    '    \n',
    '    tab_meta <- tab_meta[,c(\'sampleID\',x,y),with = F]\n',
    '    colnames(tab_meta)[which(colnames(tab_meta) %in% c(\'sampleID\',x, y))] <-\n',
    '      c(\'sampleID\',\'X\', \'Y\')\n',
    '    tooltip <- tab_meta %>% group_by(X) %>% summarize(\n',
    '      mean = mean(Y),\n',
    '      median = median(Y), \n',
    '      max = max(Y),\n',
    '    ) %>% mutate(tooltip = paste0(\'mean:\',mean,\'\\n\', \'median:\',median, \'\\n\',\'max:\',max))\n',
    '    tab_meta$tooltip <- tooltip[match(tab_meta$X , tooltip$X),\'tooltip\']\n',
    '    \n',
    '    if (plot == \'violin\') {{\n',
    '      p <-\n',
    '        ggplot(tab_meta, aes(x = X, y = Y, fill = X)) +\n',
    '        geom_violin_interactive(aes(tooltip=tooltip),scale = \"width\")+\n',
    '        theme(\n',
    '          axis.text = element_text(size = 24),\n',
    '          panel.background = element_rect(fill = \"white\", colour = NA),\n',
    '          axis.title = element_text(size = 24, face = \'bold\'),title = element_text(size = 24, face = \'bold\'),\n',
    '          axis.text.x = element_text(\n',
    '            angle = 45,\n',
    '            hjust = 1,\n',
    '            vjust = 1\n',
    '          ),\n',
    '          legend.position = \'top\'\n',
    '        ) +\n',
    '        scale_fill_manual(values = cols) + NoLegend()\n',
    '    }} else{{\n',
    '      p <-\n',
    '        ggplot(tab_meta, aes(x = X, y = Y, fill = X)) +\n',
    '        geom_boxplot_interactive(aes(tooltip=tooltip)) +\n',
    '        theme(\n',
    '          axis.text = element_text(size = 24),\n',
    '          panel.background = element_rect(fill = \"white\", colour = NA),\n',
    '          axis.title = element_text(size = 24, face = \'bold\'),title = element_text(size = 24, face = \'bold\'),\n',
    '          axis.text.x = element_text(\n',
    '            angle = 45,\n',
    '            hjust = 1,\n',
    '            vjust = 1\n',
    '          ),\n',
    '          legend.position = \'top\'\n',
    '        ) +\n',
    '        scale_fill_manual(values = cols) + NoLegend()\n',
    '    }}\n',
    '    \n',
    '  }} else if (length(which(colnames(tab_meta) == group)) == 0) {{\n',
    '    stop(\'with out {{group}}\')\n',
    '  }} else{{\n',
    '    if (!is.factor(tab_meta[[group]])) {{\n',
    '      tab_meta[[group]] <- as.factor(tab_meta[[group]])\n',
    '    }}\n',
    '    \n',
    '    if (is.null(cols)) {{\n',
    '      cols <- col_box[1:length(levels(tab_meta[[group]]))]\n',
    '      names(cols) <- levels(tab_meta[[group]])\n',
    '    }}\n',
    '    \n',
    '    tab_meta <- tab_meta[,c(\'sampleID\',x, y, group),with = F]\n',
    '    colnames(tab_meta)[which(colnames(tab_meta) %in% c(\'sampleID\',x, y, group))] <-\n',
    '      c(\'sampleID\',\'X\', \'Y\', \'group\')\n',
    '    \n',
    '    tooltip <- tab_meta %>% group_by(X,group) %>% summarize(\n',
    '      mean = mean(Y),\n',
    '      median = median(Y), \n',
    '      max = max(Y),\n',
    '    ) %>% mutate(tooltip = paste0(\'group:\',group,\'\\n\',\'mean:\',mean,\'\\n\', \'median:\',median, \'\\n\',\'max:\',max))\n',
    '    \n',
    '    tab_meta <- merge(tab_meta,tooltip)\n',
    '    \n',
    '    if (plot == \'violin\') {{\n',
    '      p <-\n',
    '        ggplot(tab_meta, aes(X, Y, fill = group)) + geom_violin_interactive(aes(tooltip=tooltip),scale = \"width\") +\n',
    '        theme(\n',
    '          axis.text = element_text(size = 24),\n',
    '          panel.background = element_rect(fill = \"white\", colour = NA),\n',
    '          axis.title = element_text(size = 24, face = \'bold\'),title = element_text(size = 24, face = \'bold\'),\n',
    '          axis.text.x = element_text(\n',
    '            angle = 45,\n',
    '            hjust = 1,\n',
    '            vjust = 1\n',
    '          ),\n',
    '          legend.position = \'top\'\n',
    '        ) + scale_fill_manual(values = cols) + guides(fill = guide_legend(title = group))\n',
    '    }} else{{\n',
    '      p <-\n',
    '        ggplot(tab_meta, aes(X, Y, fill = group)) + geom_boxplot_interactive(aes(tooltip=tooltip)) +\n',
    '        theme(\n',
    '          panel.background = element_rect(fill = \"white\", colour = NA),\n',
    '          axis.text = element_text(size = 24),\n',
    '          axis.title = element_text(size = 24, face = \'bold\'),title = element_text(size = 24, face = \'bold\'),\n',
    '          axis.text.x = element_text(\n',
    '            angle = 45,\n',
    '            hjust = 1,\n',
    '            vjust = 1\n',
    '          ),\n',
    '          legend.position = \'top\'\n',
    '        ) + scale_fill_manual(values = cols) + guides(fill = guide_legend(title = group))\n',
    '    }}\n',
    '  }}\n',
    '  \n',
    '  if (pt) {{\n',
    '    if (is.null(group) | length(which(x == group)) >= 1) {{\n',
    '      p <-\n',
    '        p + geom_point(\n',
    '          shape = 16,\n',
    '          mapping = aes(x = X, y = Y),\n',
    '          position = position_jitter()\n',
    '        )\n',
    '    }} else{{\n',
    '      p <- p + geom_point(\n',
    '        shape = 16,\n',
    '        mapping = aes(x = X, y = Y),\n',
    '        position = position_jitterdodge()\n',
    '      )\n',
    '    }}\n',
    '  }}\n',
    '  p + xlab(x) + ylab(ynames) + labs(title = y)\n',
    '}}\n',
    '### barplot\n',
    'tab_bar_plot <- function(tab_meta,\n',
    '                         x,\n',
    '                         col_by,\n',
    '                         xyflip = FALSE,\n',
    '                         value = \'percentage\',\n',
    '                         cols = NULL) {{\n',
    '  tab_meta <- tab_meta[,c(\'sampleID\',x,col_by),with = F]\n',
    '  colnames(tab_meta) <- c(\'sampleID\',\'x\',\'col_by\')\n',
    '  if (!is.factor(tab_meta$col_by)) {{\n',
    '    tab_meta$col_by <- as.factor(tab_meta$col_by)\n',
    '  }}\n',
    '  if (is.null(cols)) {{\n',
    '    cols <- col_box[1:length(levels(tab_meta$col_by))]\n',
    '    names(cols) <- levels(tab_meta$col_by)\n',
    '  }}\n',
    '  \n',
    '  df <- tab_meta %>% group_by(x, col_by) %>%\n',
    '    mutate(num = n()) %>% ungroup() %>% select(x, col_by, num) %>% unique() %>%\n',
    '    group_by(x) %>% mutate(pct = 100 * num / sum(num))\n',
    '  \n',
    '  df$tooltip <- paste0(\'x:\',df$x,\'\\n\',\'col.by:\',df$col_by,\'\\n\',\'num:\',df$num,\'\\n\',\'pct:\',df$pct)\n',
    '  \n',
    '  if (value == \'percentage\') {{\n',
    '    p <- ggplot(df, mapping = aes(x = x, y = pct)) +\n',
    '      geom_col_interactive(mapping = aes(fill = col_by,tooltip = tooltip,data_id = tooltip), width = 0.8) +\n',
    '      theme(\n',
    '        panel.background = element_rect(fill = \"white\", colour = NA),\n',
    '        axis.text = element_text(size = 24),\n',
    '        axis.title = element_text(size = 24, face = \'bold\'),\n',
    '        axis.text.x = element_text(\n',
    '          angle = 45,\n',
    '          hjust = 1,\n',
    '          vjust = 1\n',
    '        ),\n',
    '        axis.line =   element_line(colour = \"black\")\n',
    '      ) + xlab(\'orig.ident\') + ylab(\'percentage(%)\') + scale_fill_manual(values = cols)\n',
    '  }} else if (value == \'number\') {{\n',
    '    p <- ggplot(df, mapping = aes(x = x, y = num)) +\n',
    '      geom_col_interactive(mapping = aes(fill = col_by,tooltip = tooltip,data_id = tooltip), width = 0.8) +\n',
    '      theme(\n',
    '        panel.background = element_rect(fill = \"white\", colour = NA),\n',
    '        axis.text = element_text(size = 24),\n',
    '        axis.title = element_text(size = 24, face = \'bold\'),\n',
    '        axis.text.x = element_text(\n',
    '          angle = 45,\n',
    '          hjust = 1,\n',
    '          vjust = 1\n',
    '        ),\n',
    '        axis.line =   element_line(colour = \"black\")\n',
    '      ) + xlab(\'orig.ident\') + ylab(\'number of cells\') + scale_fill_manual(values = cols)\n',
    '  }} else{{\n',
    '    stop(\'can not find the type\')\n',
    '  }}\n',
    '  \n',
    '  if (xyflip) {{\n',
    '    p + coord_flip()\n',
    '  }} else{{\n',
    '    p\n',
    '  }}\n',
    '}}\n',
    
    'outbarplot <- function(meta_group,\n',
    '                       meta,\n',
    '                       groupby,\n',
    '                       x,\n',
    '                       highlight = NULL,\n',
    '                       value = \'percentage\',\n',
    '                       xyflip = FALSE) {{\n',
    '  cols <-\n',
    '    strsplit(meta_group[which(meta_group$group == groupby), color], split = \"\\\\|\") %>% unlist()\n',
    '  clu <-\n',
    '    strsplit(meta_group[which(meta_group$group == groupby), unit], split = \"\\\\|\") %>% unlist()\n',
    '  names(cols) <- clu\n',
    '  \n',
    '  if(length(intersect(highlight, meta$sampleID)) > 0) {{\n',
    '    meta <- meta[which(meta$sampleID %in% highlight), ]\n',
    '  }}\n',
    '  \n',
    '  tab_bar_plot(\n',
    '    tab_meta = meta,\n',
    '    x = x,\n',
    '    col_by = groupby,\n',
    '    xyflip = xyflip,\n',
    '    cols = cols,\n',
    '    value = value\n',
    '  )\n',
    '}}\n',
    '### heatmap dotplot\n',
    'heatxlength <- function(scgroup, groupby, meta_group) {{\n',
    '  if (length(intersect(scgroup, meta_group$group[meta_group$info == T])) > 0) {{\n',
    '    if (meta_group[group == groupby]$unit != meta_group[group == scgroup]$unit) {{\n',
    '      lns <-\n',
    '        length(strsplit(meta_group[group == groupby]$unit, split = \'\\\\|\')[[1]]) *\n',
    '        length(strsplit(meta_group[group == scgroup]$unit, split = \'\\\\|\')[[1]])\n',
    '    }}else{{\n',
    '      lns <- length(strsplit(meta_group[group == groupby]$unit, split = \'\\\\|\')[[1]])\n',
    '    }}\n',
    '  }}else{{\n',
    '    lns <- length(strsplit(meta_group[group == groupby]$unit, split = \'\\\\|\')[[1]])\n',
    '  }}\n',
    '  return(lns)\n',
    '}}\n',
    
    
    'dot_heat_plot <-\n',
    '  function(genelists,\n',
    '           genesets,\n',
    '           groupby,\n',
    '           scgroup = NULL,\n',
    '           tab_meta,\n',
    '           plot_type = \'dotplot\',\n',
    '           meta_group,\n',
    '           data,\n',
    '           highlight = NULL,\n',
    '           inpRow = TRUE,\n',
    '           inpCol = FALSE,\n',
    '           scale_build = TRUE) {{\n',
    '    gene <- unique(trimws(strsplit(genelists, \",|;|\n',
    '\")[[1]]))\n',
    '    gene <- intersect(gene, names(genesets))\n',
    '    shiny::validate(need(length(gene) <= 50,\n',
    '                         \"More than 50 genes to plot! Please reduce the gene list!\"))\n',
    '    shiny::validate(need(length(gene) > 1, \"Please input at least 2 genes to plot!\"))\n',
    '    genelist <- data.table()\n',
    '    for (i in gene) {{\n',
    '      tmp <- tab_meta[, c(\"sampleID\", meta_group[group == groupby]$group), with = FALSE]\n',
    '      colnames(tmp) = c(\"sampleID\", \"sub\")\n',
    '      if(length(intersect(scgroup, meta_group$group[meta_group$info == T])) > 0){{\n',
    '        if(meta_group[group == groupby]$unit != meta_group[group == scgroup]$unit){{\n',
    '          tmp$scgroup <- tab_meta[[scgroup]]\n',
    '          tmp$scgroup <- paste(tmp$scgroup,tmp$sub,sep = \'_\')\n',
    '        }}else{{\n',
    '          tmp$scgroup <- tmp$sub\n',
    '        }}\n',
    '      }}else{{\n',
    '        tmp$scgroup <- tmp$sub\n',
    '      }}\n',
    '      tmp$geneName = i\n',
    '      tmp$exp = data[i,]\n',
    '      genelist <- rbindlist(list(genelist, tmp))}}\n',
    '    if (length(intersect(highlight, genelist$sampleID)) > 0) {{\n',
    '      genelist <- genelist[which(genelist$sampleID %in% highlight),]\n',
    '    }}\n',
    '    shiny::validate(need(\n',
    '      uniqueN(genelist$scgroup) > 1,\n',
    '      \"Only 1 group present, unable to plot!\"))\n',
    '    \n',
    '    # Aggregate\n',
    '    genelist$exp = expm1(genelist$exp)\n',
    '    genelist = genelist[, .(exp = mean(exp),prop = sum(exp > 0) / length(sampleID)),by = c(\"geneName\", \"scgroup\")]\n',
    '    genelist$exp = log1p(genelist$exp)\n',
    '    \n',
    '    # Scale if required\n',
    '    colRange = range(genelist$exp)\n',
    '    if (scale_build) {{\n',
    '      genelist[, exp := scale(exp), keyby = \"geneName\"]\n',
    '      colRange = c(-max(abs(range(genelist$exp))), max(abs(range(genelist$exp))))\n',
    '    }}\n',
    '    \n',
    '    # hclust row/col if necessary\n',
    '    Mat = dcast.data.table(genelist, geneName ~ scgroup, value.var = \"exp\")\n',
    '    tmp = Mat$geneName\n',
    '    Mat = as.matrix(Mat[, -1])\n',
    '    rownames(Mat) = tmp\n',
    '    if (inpRow) {{\n',
    '      hcRow = dendro_data(as.dendrogram(hclust(dist(Mat))))\n',
    '      ggRow = ggtree(hclust(dist(Mat)))\n',
    '      genelist$geneName = factor(genelist$geneName, levels = hcRow$labels$label)\n',
    '    }} else {{\n',
    '      genelist$geneName = factor(genelist$geneName, levels = rev(unique(gene)))\n',
    '    }}\n',
    '    if (inpCol) {{\n',
    '      hcCol = dendro_data(as.dendrogram(hclust(dist(t(\n',
    '        Mat\n',
    '      )))))\n',
    '      ggCol = ggtree(hclust(dist(t(Mat)))) + layout_dendrogram()\n',
    '      genelist$scgroup = factor(genelist$scgroup, levels = hcCol$labels$label)\n',
    '    }} else{{\n',
    '      if(!is.factor(genelist$scgroup)){{\n',
    '        genelist$scgroup = factor(genelist$scgroup, levels = rev(unique(genelist$scgroup)))\n',
    '      }}\n',
    '    }}\n',
    '    \n',
    '    genelist$tooltip <-\n',
    '      paste0(\'sub:\',genelist$sub,\n',
    '             \'\\n\',genelist$geneName,\n',
    '             \':\',round(genelist$exp, 3),\n',
    '             \'\\n\',\'pct\',\':\',\n',
    '             round(genelist$prop * 100, 3),\'%\')\n',
    '    \n',
    '    if (plot_type == \'dotplot\') {{\n',
    '      p <-\n',
    '        ggplot(genelist, aes(scgroup, geneName, size = prop,color = exp, tooltip = tooltip)) +\n',
    '        geom_point_interactive() +\n',
    '        theme_bw() +\n',
    '        scale_size_continuous(\n',
    '          \"proportion\",\n',
    '          range = c(0, 8),\n',
    '          limits = c(0, 1),\n',
    '          breaks = c(0.00, 0.25, 0.50, 0.75, 1.00)\n',
    '        ) +\n',
    '        theme(\n',
    '          legend.box.background = element_rect(fill = \'white\', colour = \'white\'),\n',
    '          legend.key = element_blank(),\n',
    '          panel.grid = element_blank(),\n',
    '          axis.title = element_blank(),\n',
    '          legend.box = \"vertical\",\n',
    '          axis.line = element_line(colour = \"black\"),\n',
    '          panel.background = element_rect(fill = \'white\', colour = NA),\n',
    '          axis.text = element_text(size = 25),\n',
    '          axis.text.x = element_text(\n',
    '            angle = 45,\n',
    '            hjust = 1,\n',
    '            vjust = 1\n',
    '          )\n',
    '        ) +\n',
    '        scale_color_gradientn(\n',
    '          colors = c(\'#0e7c99\',\"#60bde6\", \'white\', \"#e99ea4\", \'#d8394c\'),\n',
    '          \"expression\",\n',
    '          limits = colRange\n',
    '        ) +\n',
    '        labs(x = NULL, y = NULL) +\n',
    '        guides(size = guide_legend(order = 3)) + coord_cartesian(xlim = c(1, length(levels(genelist$scgroup))))\n',
    '    }} else if (plot_type == \'heatmap\') {{\n',
    '      p <- ggplot(genelist, aes(scgroup, geneName, fill = exp)) +\n',
    '        geom_tile() +\n',
    '        theme_bw() +\n',
    '        theme(\n',
    '          legend.box.background = element_rect(fill = \'white\', colour = \'white\'),\n',
    '          legend.key = element_blank(),\n',
    '          panel.grid = element_blank(),\n',
    '          axis.title = element_blank(),\n',
    '          legend.box = \"vertical\",\n',
    '          axis.line = element_line(colour = \"black\"),\n',
    '          panel.background = element_rect(fill = \'white\', colour = NA),\n',
    '          axis.text = element_text(size = 15),\n',
    '          axis.text.x = element_text(\n',
    '            angle = 30,\n',
    '            hjust = 1,\n',
    '            vjust = 1\n',
    '          )\n',
    '        ) +\n',
    '        scale_fill_gradientn(\n',
    '          colors = c(\'#0e7c99\',\"#60bde6\", \'white\', \"#e99ea4\", \'#d8394c\'),\n',
    '          \"expression\",\n',
    '          limits = colRange\n',
    '        ) +\n',
    '        labs(x = NULL, y = NULL) +\n',
    '        guides(size = guide_legend(order = 3)) + coord_cartesian(xlim = c(1, length(levels(genelist$scgroup))))\n',
    '    }}\n',
    '    \n',
    '    if (inpRow & inpCol) {{\n',
    '      ggOut <-\n',
    '        p %>% insert_top(ggCol, height = 0.2) %>% insert_left(ggRow, width = 0.2)\n',
    '    }} else if (inpRow) {{\n',
    '      ggOut <- p %>% insert_left(ggRow, width = 0.2)\n',
    '    }} else if (inpCol) {{\n',
    '      ggOut <- p %>% insert_top(ggCol, height = 0.2)\n',
    '    }} else{{\n',
    '      ggOut <- p\n',
    '    }}\n',
    '    \n',
    '    \n',
    '    return(ggOut)\n',
    '  }}\n',
    '# extract legend\n',
    'g_legend <- function(a.gplot){{  \n',
    '  tmp <- ggplot_gtable(ggplot_build(a.gplot))  \n',
    '  leg <- which(sapply(tmp$grobs, function(x) x$name) == \"guide-box\")  \n',
    '  legend <- tmp$grobs[[leg]]  \n',
    '  legend \n',
    '}}\n',
    '# linear color\n',
    'bilinear <- function(x, y, xy, Q11, Q21, Q12, Q22) {{\n',
    '  oup = (xy - x) * (xy - y) * Q11 + x * (xy - y) * Q21 + (xy - x) * y * Q12 + x *\n',
    '    y * Q22\n',
    '  oup = oup / (xy * xy)\n',
    '  return(oup)\n',
    '}}\n',
    '# coexpression spatial feature\n',
    'coexp_feature <-\n',
    '  function(meta_slice,\n',
    '           meta_all,\n',
    '           data,\n',
    '           meta_group,\n',
    '           gene1,\n',
    '           gene2,\n',
    '           input_image,\n',
    '           highlight = NULL,\n',
    '           genesets,\n',
    '           group = NULL,\n',
    '           inpcol = \'Red (Gene1); Blue (Gene2)\',\n',
    '           pt.alpha = 1,\n',
    '           pt_size = 1,\n',
    '           threshold1 = 0,\n',
    '           threshold2 = 0) {{\n',
    '    if(!is.null(input_image)){{\n',
    '      xrange <- c(25, dim(input_image)[2] - 25)\n',
    '      yrange <- c(25, dim(input_image)[1] - 25)\n',
    '    }}else{{\n',
    '      xrange <-\n',
    '        c(min(meta_slice$imagecol),\n',
    '          max(meta_slice$imagecol))\n',
    '      yrange <-\n',
    '        c(min(meta_slice$imagerow),\n',
    '          max(meta_slice$imagerow))\n',
    '    }}\n',
    '    \n',
    '    if (length(intersect(names(genesets), c(gene1, gene2))) < 2) {{\n',
    '      validate(\"Wait a moment, gene ready to load or Don\'t have the gene!\")}}\n',
    '    \n',
    '    \n',
    '    meta_all$val1 <-\n',
    '      data[gene1,]\n',
    '    meta_all$val2 <-\n',
    '      data[gene2,]\n',
    '    h5file$close_all()\n',
    '    meta_slice <-\n',
    '      meta_all[meta_all$sampleID %in% meta_slice$sampleID]\n',
    '    \n',
    '    meta_slice[which(meta_slice$val1 <= max(meta_slice$val1) * threshold1), \'val1\'] <-\n',
    '      0\n',
    '    meta_slice[which(meta_slice$val2 <= max(meta_slice$val2) * threshold2), \'val2\'] <-\n',
    '      0\n',
    '    \n',
    '    rat = (max(meta_slice$imagecol) - min(meta_slice$imagecol)) / (max(meta_slice$imagerow) - min(meta_slice$imagerow))\n',
    '    cInp = strsplit(inpcol, \"; \")[[1]]\n',
    '    if (cInp[1] == \"Red (Gene1)\") {{\n',
    '      c10 = c(255, 0, 0)\n',
    '    }} else if (cInp[1] == \"Orange (Gene1)\") {{\n',
    '      c10 = c(255, 140, 0)\n',
    '    }} else {{\n',
    '      c10 = c(0, 255, 0)\n',
    '    }}\n',
    '    if (cInp[2] == \"Green (Gene2)\") {{\n',
    '      c01 = c(0, 255, 0)\n',
    '    }} else {{\n',
    '      c01 = c(0, 0, 255)\n',
    '    }}\n',
    '    c00 = c(217, 217, 217)\n',
    '    c11 = c10 + c01\n',
    '    nGrid = 16\n',
    '    nPad = 2\n',
    '    nTot = nGrid + nPad * 2\n',
    '    gg = data.table::data.table(v1 = rep(0:nTot, nTot + 1), v2 = sort(rep(0:nTot, nTot +\n',
    '                                                                            1)))\n',
    '    gg$vv1 = gg$v1 - nPad\n',
    '    gg[vv1 < 0]$vv1 = 0\n',
    '    gg[vv1 > nGrid]$vv1 = nGrid\n',
    '    gg$vv2 = gg$v2 - nPad\n',
    '    gg[vv2 < 0]$vv2 = 0\n',
    '    gg[vv2 > nGrid]$vv2 = nGrid\n',
    '    gg$cR = bilinear(gg$vv1, gg$vv2, nGrid, c00[1], c10[1], c01[1], c11[1])\n',
    '    gg$cG = bilinear(gg$vv1, gg$vv2, nGrid, c00[2], c10[2], c01[2], c11[2])\n',
    '    gg$cB = bilinear(gg$vv1, gg$vv2, nGrid, c00[3], c10[3], c01[3], c11[3])\n',
    '    gg$cMix = rgb(gg$cR, gg$cG, gg$cB, maxColorValue = 255)\n',
    '    gg = gg[, c(\"v1\", \"v2\", \"cMix\")]\n',
    '    \n',
    '    if(length(intersect(unique(meta_slice$val1), 0)) == length(unique(meta_slice$val1))){{\n',
    '      meta_slice$v1 <- 0\n',
    '    }}else{{\n',
    '      meta_slice$v1 = round(nTot * meta_slice$val1 / max(meta_slice$val1))\n',
    '    }}\n',
    '    \n',
    '    if(length(intersect(unique(meta_slice$val2), 0)) == length(unique(meta_slice$val2))){{\n',
    '      meta_slice$v2 <- 0\n',
    '    }}else{{\n',
    '      meta_slice$v2 = round(nTot * meta_slice$val2 / max(meta_slice$val2))\n',
    '    }}\n',
    '    meta_slice$v0 = meta_slice$v1 + meta_slice$v2\n',
    '    meta_slice = gg[meta_slice, on = c(\"v1\", \"v2\")]\n',
    '    \n',
    '    if (class(input_image) == \'array\'| class(input_image) == \'raster\') {{\n',
    '    grob <- grid::rasterGrob(input_image, width = grid::unit(1, \"npc\"),\n' ,
    '                         height = grid::unit(1, \"npc\"))\n',
    '     bg <- geom_spatial(data = tibble::tibble(grob = list(grob)), \n',
    '                  aes(grob = grob), x = 0.5, y = 0.5)\n',
    '    }} else{{\n',
    '      bg <- NULL\n',
    '    }}\n',
    '    \n',
    '    \n',
    '    if(length(intersect(colnames(meta_slice), group)) > 0){{\n',
    '      meta_slice$firm_lab <-\n',
    '        paste0(\n',
    '          \'sampleID: \',\n',
    '          meta_slice[[\'sampleID\']],\n',
    '          \'\\n\',\n',
    '          group,\n',
    '          \': \',\n',
    '          meta_slice[[group]],\n',
    '          \'\\n\',\n',
    '          gene1,\n',
    '          \': \',\n',
    '          round(meta_slice[[\'val1\']], 2),\n',
    '          \'\\n\',\n',
    '          gene2,\n',
    '          \': \',\n',
    '          round(meta_slice[[\'val2\']], 2)\n',
    '        )\n',
    '    }}else{{\n',
    '      meta_slice$firm_lab <-\n',
    '        paste0(\n',
    '          \'sampleID: \',\n',
    '          meta_slice[[\'sampleID\']],\n',
    '          \'\\n\',\n',
    '          gene1,\n',
    '          \': \',\n',
    '          round(meta_slice[[\'val1\']], 2),\n',
    '          \'\\n\',\n',
    '          gene2,\n',
    '          \': \',\n',
    '          round(meta_slice[[\'val2\']], 2)\n',
    '        )\n',
    '    }}\n',
    '    \n',
    '    \n',
    '    \n',
    '    if(length(intersect(meta_slice$sampleID, highlight)) == 0 | length(intersect(meta_slice$sampleID, highlight)) == length(meta_slice$sampleID)){{\n',
    '      meta_slice$cMix <- meta_slice$cMix\n',
    '    }}else{{\n',
    '      meta_slice$cMix[-which(meta_slice$sampleID %in% highlight)] <- NA\n',
    '    }}\n',
    '    \n',
    '    ggplot(\n',
    '      data = meta_slice,\n',
    '      mapping = aes_string(\n',
    '        x = \'imagecol\',\n',
    '        y = \'imagerow\',\n',
    '        tooltip = \'firm_lab\',\n',
    '        data_id = \'sampleID\'\n',
    '      )\n',
    '    ) + bg + xlim(xrange) + ylim(rev(yrange)) +\n',
    '      theme_classic() + \n',
    '      theme(\n',
    '        axis.line = element_blank(),\n',
    '        axis.text = element_blank(),\n',
    '        axis.ticks = element_blank(),\n',
    '        axis.title = element_blank(),\n',
    '        legend.position = \'top\'\n',
    '      ) + geom_point_interactive(size = pt_size, alpha = pt.alpha, color = meta_slice$cMix) + coord_fixed()\n',
    '    \n',
    '    \n',
    '    # gg_scatter\n',
    '  }}\n',
    
    
    '### coexpression legend\n',
    'coexleg <- function(gene1, gene2, inpcol = \'Red (Gene1); Blue (Gene2)\'){{ \n',
    '  # Generate coex color palette \n',
    '  cInp = strsplit(inpcol, \"; \")[[1]] \n',
    '  if(cInp[1] == \"Red (Gene1)\"){{ \n',
    '    c10 = c(255,0,0) \n',
    '  }} else if(cInp[1] == \"Orange (Gene1)\"){{ \n',
    '    c10 = c(255,140,0) \n',
    '  }} else {{ \n',
    '    c10 = c(0,255,0) \n',
    '  }} \n',
    '  if(cInp[2] == \"Green (Gene2)\"){{ \n',
    '    c01 = c(0,255,0) \n',
    '  }} else {{ \n',
    '    c01 = c(0,0,255) \n',
    '  }} \n',
    '  c00 = c(217,217,217) ; c11 = c10 + c01 \n',
    '  nGrid = 16; nPad = 2; nTot = nGrid + nPad * 2 \n',
    '  gg = data.table(v1 = rep(0:nTot,nTot+1), v2 = sort(rep(0:nTot,nTot+1))) \n',
    '  gg$vv1 = gg$v1 - nPad ; gg[vv1 < 0]$vv1 = 0; gg[vv1 > nGrid]$vv1 = nGrid \n',
    '  gg$vv2 = gg$v2 - nPad ; gg[vv2 < 0]$vv2 = 0; gg[vv2 > nGrid]$vv2 = nGrid \n',
    '  gg$cR = bilinear(gg$vv1, gg$vv2, nGrid, c00[1], c10[1], c01[1], c11[1]) \n',
    '  gg$cG = bilinear(gg$vv1, gg$vv2, nGrid, c00[2], c10[2], c01[2], c11[2]) \n',
    '  gg$cB = bilinear(gg$vv1, gg$vv2, nGrid, c00[3], c10[3], c01[3], c11[3]) \n',
    '  gg$cMix = rgb(gg$cR, gg$cG, gg$cB, maxColorValue = 255) \n',
    '  gg = gg[, c(\"v1\", \"v2\", \"cMix\")] \n',
    '  \n',
    '  # Actual ggplot \n',
    '  ggOut = ggplot(gg, aes(v1, v2)) + \n',
    '    geom_tile(fill = gg$cMix) + \n',
    '    xlab(gene1) + ylab(gene2) + coord_fixed(ratio = 1) + \n',
    '    scale_x_continuous(breaks = c(0, nTot), label = c(\"low\", \"high\")) + \n',
    '    scale_y_continuous(breaks = c(0, nTot), label = c(\"low\", \"high\")) + \n',
    '    theme(\n',
    '      legend.box = \"vertical\",\n',
    '      axis.line = element_line(colour = \"black\"),\n',
    '      panel.background = element_rect(fill = \'white\', colour = NA),\n',
    '      axis.title = element_text(size = 24,face = \'bold\'),\n',
    '      axis.text = element_text(size = 24),\n',
    '      axis.text.x = element_text(\n',
    '        angle = 45,\n',
    '        hjust = 1,\n',
    '        vjust = 1\n',
    '      )\n',
    '    ) \n',
    '  return(ggOut) \n',
    '}} \n',
    '## coexpression table\n',
    'coexp_tab <-\n',
    '  function(tab_meta,\n',
    '           data,\n',
    '           metagroup,\n',
    '           genesets,\n',
    '           gene1,\n',
    '           gene2,\n',
    '           highlight = NULL,\n',
    '           threshold1 = 0,\n',
    '           threshold2 = 0,\n',
    '           new_group = NULL) {{\n',
    '    if (length(intersect(names(genesets), c(gene1, gene2))) < 2) {{\n',
    '      validate(\"Wait a moment, gene ready to load or Don\'t have the gene!\")}}\n',
    '    tab_meta$val1 <-\n',
    '      data[gene1,]\n',
    '    tab_meta$val2 <-\n',
    '      data[gene2,]\n',
    '    \n',
    '    tab_meta[which(tab_meta$val1 <= max(tab_meta$val1) * threshold1), \'val1\'] <- 0\n',
    '    tab_meta[which(tab_meta$val2 <= max(tab_meta$val2) * threshold2), \'val2\'] <- 0\n',
    '    \n',
    '    if (length(intersect(tab_meta$sampleID, highlight)) > 0) {{\n',
    '      tab_meta <- tab_meta[which(tab_meta$sampleID %in% highlight), ]}}\n',
    '    \n',
    '    if (length(intersect(metagroup[[\'group\']], new_group)) == 0) {{\n',
    '      df = tab_meta[, .(\n',
    '        gene1_ex = sum(val1 > 0 & val2 <= 0),\n',
    '        gene2_ex = sum(val2 > 0 & val1 <= 0),\n',
    '        both = sum(val2 > 0 & val1 > 0),\n',
    '        none = sum(val2 <= 0 & val1 <= 0)),]\n',
    '      \n',
    '      df %<>% t() %>% as.data.frame()\n',
    '      colnames(df) <- \'nSpot\'\n',
    '      df$expression <- rownames(df)\n',
    '      \n',
    '      df[1:2, \"expression\"] <-\n',
    '        c(paste(gene1, \'>\' , round(threshold1 * max(tab_meta$val1), 2)), paste(gene2, \'>\' , round(threshold2 * max(tab_meta$val2), 2)))\n',
    '      \n',
    '      df %<>% mutate(pct = round(100 * nSpot / sum(nSpot), 2))\n',
    '      rownames(df) <- NULL\n',
    '      \n',
    '      df <- df[, c(\'expression\', \'nSpot\', \'pct\')]\n',
    '    }} else{{\n',
    '      colnames(tab_meta)[which(colnames(tab_meta) == new_group)] <-\n',
    '        \'new_group\'\n',
    '      df = tab_meta[, .(\n',
    '        gene1_ex = sum(val1 > 0 & val2 <= 0),\n',
    '        gene2_ex = sum(val2 > 0 & val1 <= 0),\n',
    '        both = sum(val2 > 0 & val1 > 0),\n',
    '        none = sum(val2 <= 0 & val1 <= 0)\n',
    '      ),by = new_group]\n',
    '      \n',
    '      \n',
    '      if (length(which(is.na(df$new_group))) > 0) {{\n',
    '        df <- df[-which(is.na(df$new_group)), ]}}\n',
    '      \n',
    '      df <- lapply(unique(df$new_group), function(x) {{\n',
    '        df_ <- subset(df, df$new_group == x)\n',
    '        df_ <- df_[, -1]\n',
    '        df_ %<>% t() %>% as.data.frame()\n',
    '        colnames(df_) <- \'nSpot\'\n',
    '        df_$expression <- rownames(df_)\n',
    '        df_[1:2, \"expression\"] <-\n',
    '          c(paste(gene1, \'>\' , round(threshold1 * max(\n',
    '            tab_meta$val1\n',
    '          ), 2)), paste(gene2, \'>\' , round(threshold2 * max(\n',
    '            tab_meta$val2\n',
    '          ), 2)))\n',
    '        df_ %<>% mutate(pct = round(100 * nSpot / sum(nSpot), 2))\n',
    '        df_[, new_group] <- x\n',
    '        df_}})\n',
    '      \n',
    '      df <- do.call(rbind, df)\n',
    '      rownames(df) <- NULL\n',
    '      df <- df[, c(\'expression\', \'nSpot\', \'pct\', new_group)]\n',
    '    }}\n',
    '    return(df)\n',
    '  }}\n',
    
    'tab_exp_clu <-\n',
    '  function(data,\n',
    '           meta,\n',
    '           gene,genesets,\n',
    '           inpsplt,\n',
    '           group.by,meta_group,threshold = 0,highlight =NULL) {{\n',
    '    if (is.null(gene) | length(which(names(genesets) == gene)) == 0) {{\n',
    '      shiny::validate(\"Wait a moment, gene ready to load or Don\'t have the gene!\")\n',
    '    }}\n',
    '    meta$val <- data[gene,]\n',
    '    meta = meta[, c(\'sampleID\', group.by, \'val\'),\n',
    '                with = FALSE]\n',
    '    colnames(meta) = c(\'sampleID\', \"sub\", \'val\')\n',
    '    meta <- meta[!is.na(sub)]\n',
    '    if (meta_group[group == group.by]$info != \'TRUE\') {{\n',
    '      if (inpsplt == \"Quartile\") {{nBk = 4}}\n',
    '      if (inpsplt == \"Decile\") {{nBk = 10}}\n',
    '      meta$sub = cut(meta$sub, breaks = nBk)}}\n',
    '    \n',
    '    if(length(intersect(meta$sampleID, highlight)) > 0){{\n',
    '      meta <- meta[which(meta$sampleID %in% highlight),]}}\n',
    '    \n',
    '    meta$express = FALSE\n',
    '    meta[val > max(meta$val)*threshold]$express = TRUE\n',
    '    meta1 = meta[express == TRUE, .(nExpress = .N), by = \"sub\"]\n',
    '    meta = meta[, .(nCells = .N,Mean = mean(val)), by = \"sub\"]\n',
    '    meta = meta1[meta, on = \"sub\"]\n',
    '    meta = meta[, c(\"sub\", \"nCells\", \"nExpress\", \'Mean\'), with = FALSE]\n',
    '    meta[is.na(nExpress)]$nExpress = 0\n',
    '    meta$pctExpress = 100 * meta$nExpress / meta$nCells\n',
    '    meta = meta[order(sub)]\n',
    '    colnames(meta)[3] = paste0(colnames(meta)[3], \"_\", gene)\n',
    '    return(meta)}}\n\n',
    
    'spatialdwls <- function(input_image,deconv,pie_scale = 0.5, score = NULL,pt.alpha = 0.7,pt_size = 0.8){{\n',
    '  if (!is.null(input_image)) {{\n',
    '    xrange <- c(25, dim(input_image)[2] - 25)\n',
    '    yrange <- c(25, dim(input_image)[1] - 25)\n',
    '  }} else{{\n',
    '    xrange <-\n',
    '      c(min(meta_slice$imagecol),\n',
    '        max(meta_slice$imagecol))\n',
    '    yrange <-\n',
    '      c(min(meta_slice$imagerow),\n',
    '        max(meta_slice$imagerow))\n',
    '  }}\n',
    '  if(class(input_image) == \'array\' | class(input_image) == \'raster\'){{\n',
    '    grob <- grid::rasterGrob(input_image, width = grid::unit(1, \"npc\"),\n',
    '                             height = grid::unit(1, \"npc\"))\n',
    '    bg <- geom_spatial(data = tibble::tibble(grob = list(grob)), \n',
    '                       aes(grob = grob), x = 0.5, y = 0.5)\n',
    '    # bg <- ggpubr::background_image(input_image)\n',
    '  }}else{{\n',
    '    bg <- NULL\n',
    '  }}\n',
    '  if(!is.null(score)){{\n',
    '    \n',
    '    \n',
    '    deconv$firm_lab <-\n',
    '      paste0(\'sampleID: \', deconv[[\'sampleID\']], \'\\n\', strsplit(score,split = \'_\')[[1]][2], \': \', deconv[[score]], \'\\n\', \n',
    '             \'PCT: \', deconv[[strsplit(score,split = \'_\')[[1]][2]]])\n',
    '    \n',
    '    gg_scatter <- ggplot(\n',
    '      data = deconv,\n',
    '      mapping = aes_string(\n',
    '        x = \'imagecol\',\n',
    '        y = \'imagerow\',\n',
    '        color = score,\n',
    '        # here we add iteractive aesthetics\n',
    '        tooltip = \'firm_lab\',\n',
    '        data_id = \'sampleID\'\n',
    '      )\n',
    '    )+bg + xlim(xrange) + ylim(rev(yrange)) + theme_classic() + theme(\n',
    '      axis.line = element_blank(),\n',
    '      axis.text = element_blank(),\n',
    '      axis.ticks = element_blank(),\n',
    '      axis.title = element_blank(),\n',
    '      legend.position = \'top\'\n',
    '    ) + geom_point_interactive(size = pt_size, alpha = pt.alpha) + scale_color_distiller(palette = \"Spectral\") + coord_fixed()\n',
    '    \n',
    '  }}else{{\n',
    '    cells <- sapply(strsplit(grep(pattern = \'^score_\', colnames(deconv),value = T),split = \'_\'),\'[[\',2)\n',
    '    cells <- cells[order(cells)]',
    '    # names(cells) <- col_box[1:length(grep(pattern = \'^score_\', colnames(deconv),value = T))]\n',
    '    gg_scatter <- ggplot(\n',
    '      data = deconv,\n',
    '      mapping = aes_string(\n',
    '        x = \'imagecol\',\n',
    '        y = \'imagerow\'\n',
    '      )\n',
    '    )+bg + xlim(xrange) + ylim(rev(yrange)) + theme_classic() + theme(\n',
    '      axis.line = element_blank(),\n',
    '      axis.text = element_blank(),\n',
    '      axis.ticks = element_blank(),\n',
    '      axis.title = element_blank(),\n',
    '      legend.position = \'top\',\n',
    '      legend.key.size = unit(2, \'mm\'),\n',
    '      legend.box.background = element_rect(fill = \'white\', colour = \'white\'),\n',
    '      legend.key = element_blank(), legend.text = element_text(size = 12)\n',
    '    ) + geom_scatterpie(\n',
    '      data = deconv,\n',
    '      aes(x = imagecol, y = imagerow),\n',
    '      cols = cells,pie_scale = pie_scale,color=NA\n',
    '    ) + coord_fixed()\n',
    '  }}\n',
    '  return(gg_scatter)\n',
    '}}\n\n',
    'cellpercentage <- function(deconv, cells){{\n',
    '  cell <-\n',
    '    sapply(strsplit(grep(\n',
    '      pattern = \'^score_\', colnames(deconv), value = T\n',
    '    ), split = \'_\'), \'[[\', 2)\n',
    '  \n',
    '  if(length(intersect(cells,deconv$sampleID)) > 0){{\n',
    '    dt <- deconv[which(deconv$sampleID %in% cells), cell, with = F] %>% colSums() %>% as.data.frame()\n',
    '  }}else{{\n',
    '    dt <- deconv[,cell,with = F] %>% colSums() %>% as.data.frame()\n',
    '  }}\n',
    '  \n',
    '  colnames(dt) <- \'num\'\n',
    '  dt$cell <- rownames(dt)\n',
    '  \n',
    '  dt <- dt %>% mutate(pct = round(100 * num / sum(num), 4))\n',
    '  dt$tooltip <- paste0(dt$cell, \': \', dt$pct)\n',
    '  \n',
    '  p <- ggplot(dt,aes(x = \'\',y = pct, fill = cell)) + \n',
    '    geom_col_interactive(data = dt,mapping = aes_string(tooltip = \'tooltip\')) + coord_polar(\'y\',start = 0) + theme_classic() + theme(\n',
    '      axis.line = element_blank(),\n',
    '      axis.text = element_blank(),\n',
    '      axis.ticks = element_blank(),\n',
    '      axis.title = element_blank(),\n',
    '      legend.position = \'top\',\n',
    '      legend.key.size = unit(2, \'mm\'),\n',
    '      legend.box.background = element_rect(fill = \'white\', colour = \'white\'),\n',
    '      legend.key = element_blank(), legend.text = element_text(size = 12)\n',
    '    )\n',
    '  return(p)\n',
    '}}\n\n',
    'deconvtab <- function(deconv, value, group, highlight = NULL) {{\n',
    '  if (length(intersect(highlight, deconv$sampleID)) > 0) {{\n',
    '    deconv <- deconv[which(deconv$sampleID %in% highlight), ]\n',
    '  }}\n',
    '  \n',
    '  scores <- paste0(\'score_\', value)\n',
    '  deconv_ex = deconv[, c(\'sampleID\', group, value, scores),\n',
    '                     with = FALSE]\n',
    '  \n',
    '  colnames(deconv_ex) <- c(\'sampleID\', \'groupby\', \'PCT\', \'score\')\n',
    '  df <- deconv_ex %>% group_by(groupby) %>%\n',
    '    mutate(mean_pct = mean(PCT)) %>% mutate(mean_score = mean(score)) %>% mutate(nspots = n()) %>%\n',
    '    dplyr::select(groupby, nspots , mean_pct, mean_score) %>% unique()\n',
    '  \n',
    '  colnames(df) <-\n',
    '    c(group,\n',
    '      \'nSpots\',\n',
    '      paste0(value, \'_mean_pct\'),\n',
    '      paste0(value, \'_mean_score\'))\n',
    '  \n',
    '  return(df)\n',
    '}}\n\n',
    
    'deconvdensity <- function(deconv, value, highlight = NULL, scores = \'score\'){{\n',
    '  if (length(intersect(highlight, deconv$sampleID)) > 0) {{\n',
    '    deconv <- deconv[which(deconv$sampleID %in% highlight), ]\n',
    '  }}\n',
    '  \n',
    '  if(scores == \'score\'){{\n',
    '    play <- paste0(\'score_\', value)\n',
    '  }}else{{\n',
    '    play <- value\n',
    '  }}\n',
    '  \n',
    '  deconv_ex <- deconv[,play,with = F]\n',
    '  deconv_ex <- melt(deconv_ex, measure.vars = play,variable.name = \'cell\', value.name =  \'x\')\n',
    '  deconv_ex <- deconv_ex[,.(cell,x,tooltip = NA),]\n',
    '  \n',
    '  \n',
    '  for(i in play){{\n',
    '    su <- summary(deconv_ex$x[which(deconv_ex$cell == i)])\n',
    '    tooltip <- paste(i,\'\\n\',\'Min.\',su[\'Min.\'],\'\\n\')\n',
    '    tooltip <- paste(tooltip,\'1st Qu.\',su[\'1st Qu.\'],\'\\n\')\n',
    '    tooltip <- paste(tooltip,\'Median\',su[\'Median\'],\'\\n\')\n',
    '    tooltip <- paste(tooltip,\'3rd Qu.\',su[\'3rd Qu.\'],\'\\n\')\n',
    '    tooltip <- paste(tooltip,\'Max.\',su[\'Max.\'],\'\\n\')\n',
    '    deconv_ex$tooltip[which(deconv_ex$cell == i)] <- tooltip\n',
    '  }}\n',
    '  \n',
    '  \n',
    '  p <- ggplot(deconv_ex,aes_string(tooltip = \'tooltip\')) + theme(\n',
    '    panel.grid = element_blank(),\n',
    '    axis.title = element_blank(),\n',
    '    axis.line = element_line(colour = \"black\"),\n',
    '    panel.background = element_rect(fill = \'white\', colour = NA),\n',
    '    axis.text = element_text(size = 15),\n',
    '    axis.text.x = element_text(\n',
    '      angle = 30,\n',
    '      hjust = 1,\n',
    '      vjust = 1\n',
    '    )\n',
    '  ) + geom_density_interactive(aes(x = x, fill = cell), alpha = 0.5)\n',
    '  \n',
    '  return(p)\n',
    '}}\n\n\n\n'
  )
  
  return(afun)
}
## function in server script
fun_server <- function() {
  afun <- glue::glue(
    '## spatialLIBD package\n',
    'geom_spatial <- function (mapping = NULL, data = NULL, stat = \"identity\", position = \"identity\", \n',
    '                          na.rm = FALSE, show.legend = NA, inherit.aes = FALSE, ...) \n',
    '{{\n',
    '  ggname <- function(prefix, grob) {{\n',
    '    grob$name <- grid::grobName(grob, prefix)\n',
    '    grob\n',
    '  }}\n',
    '  GeomCustom <- ggproto(\"GeomCustom\", Geom, setup_data = function(self, \n',
    '                                                                  data, params) {{\n',
    '    data <- ggproto_parent(Geom, self)$setup_data(data, params)\n',
    '    data\n',
    '  }}, draw_group = function(data, panel_scales, coord) {{\n',
    '    vp <- grid::viewport(x = data$x, y = data$y)\n',
    '    g <- grid::editGrob(data$grob[[1]], vp = vp)\n',
    '    ggname(\"geom_spatial\", g)\n',
    '  }}, required_aes = c(\"grob\", \"x\", \"y\"))\n',
    '  layer(geom = GeomCustom, mapping = mapping, data = data, \n',
    '        stat = stat, position = position, show.legend = show.legend, \n',
    '        inherit.aes = inherit.aes, params = list(na.rm = na.rm, \n',
    '                                                 ...))\n',
    '}}\n\n',
    'br_add <- function(height, break_add = NULL) {{\n',
    '  if (base::is.null(break_add)) {{\n',
    '    x <- base::ceiling((height - 400) / 100)\n',
    '    out <- x * 5\n',
    '  }} else {{\n',
    '    out <- break_add\n',
    '  }}\n',
    '  return(out)\n',
    '}}\n',
    'checkShortcut <- function(shortcut, valid, cursor_pos = NA) {{\n',
    '  shortcut <- shortcut[1]\n',
    '  if (!base::is.null(shortcut)) {{\n',
    '    if (!base::is.null(shortcut) && !shortcut %in% valid) {{\n',
    '      shiny::req(FALSE)\n',
    '    }}\n',
    '    if (shortcut == \"d\" && base::is.null(cursor_pos)) {{\n',
    '      confuns::give_feedback(\n',
    '        msg = \"The cursor must be inside the reactive image to use shortcut \'d\'.\",\n',
    '        fdb.fn = \"stop\",\n',
    '        in.shiny = TRUE,\n',
    '        with.time = FALSE\n',
    '      )\n',
    '    }}\n',
    '  }}}}\n',
    
    '### spatial plot\n',
    'spatial_dimplot <- function(input_image,\n',
    '                            meta_slice,\n',
    '                            meta_group,\n',
    '                            col.by = NULL,\n',
    '                            pt.alpha = 0.7,\n',
    '                            pt_size = 0.8) {{\n',
    '  if (!is.null(input_image)) {{\n',
    '    xrange <- c(25, dim(input_image)[2] - 25)\n',
    '    yrange <- c(25, dim(input_image)[1] - 25)\n',
    '  }} else{{\n',
    '    xrange <-\n',
    '      c(min(meta_slice$imagecol),\n',
    '        max(meta_slice$imagecol))\n',
    '    yrange <-\n',
    '      c(min(meta_slice$imagerow),\n',
    '        max(meta_slice$imagerow))\n',
    '  }}\n',
    '  if (!is.null(col.by)) {{\n',
    '    if (!col.by %in% meta_group$group) {{\n',
    '      stop(\"Don\'t have the feature\")\n',
    '    }}\n',
    '  }} else{{\n',
    '    if (length(which(meta_group$group == \'seurat_clusters\')) == 1) {{\n',
    '      col.by = \'seurat_clusters\'\n',
    '    }} else{{\n',
    '      stop(\"Don\'t have the meta\")\n',
    '    }}\n',
    '  }}\n',
    '  if (col.by %in% meta_group[meta_group$info == T, group]) {{\n',
    '    lev <-\n',
    '      strsplit(meta_group[group == col.by, unit], split = \'\\\\|\')[[1]]\n',
    '    cols_level <-\n',
    '      strsplit(meta_group[group == col.by, color], split = \'\\\\|\')[[1]]\n',
    '    names(cols_level) <- cols_level\n',
    '  }}\n',
    '  \n',
    '  \n',
    '  if(class(input_image) == \'array\' | class(input_image) == \'raster\'){{\n',
    '    grob <- grid::rasterGrob(input_image, width = grid::unit(1, \"npc\"),\n' ,
    '                         height = grid::unit(1, \"npc\"))\n',
    '     bg <- geom_spatial(data = tibble::tibble(grob = list(grob)), \n',
    '                  aes(grob = grob), x = 0.5, y = 0.5)\n',
    '    # bg <- ggpubr::background_image(input_image)\n',
    '  }}else{{\n',
    '    bg <- NULL\n',
    '  }}\n',
    '  \n',
    '  if (col.by %in% meta_group[meta_group$info == T, group]) {{\n',
    '    lab <- levels(meta_slice[[col.by]])\n',
    '    names(lab) <- lab\n',
    '    \n',
    '    names(cols_level) <- lab\n',
    '    \n',
    '    gg_scatter <- ggplot(\n',
    '      data = meta_slice,\n',
    '      mapping = aes_string(\n',
    '        x = \'imagecol\',\n',
    '        y = \'imagerow\',\n',
    '        color = col.by,\n',
    '        # here we add iteractive aesthetics\n',
    '        tooltip = \'tooltip\',\n',
    '        data_id = col.by\n',
    '      )\n',
    '    )+bg + xlim(xrange) + ylim(rev(yrange)) + theme_classic() + theme(\n',
    '      axis.line = element_blank(),\n',
    '      axis.text = element_blank(),\n',
    '      axis.ticks = element_blank(),\n',
    '      axis.title = element_blank(),\n',
    '      legend.position = \'top\',\n',
    '      legend.key.size = unit(2, \'mm\'),\n',
    '      legend.box.background = element_rect(fill = \'white\', colour = \'white\'),\n',
    '      legend.key = element_blank(), legend.text = element_text(size = 12)\n',
    '    ) + geom_point_interactive(size = pt_size, alpha = pt.alpha) + geom_col_interactive(\n',
    '      mapping = aes_string(\n',
    '        y = 1,\n',
    '        fill = col.by,\n',
    '        tooltip = \'tooltip\',\n',
    '        data_id = col.by\n',
    '      ),\n',
    '      linewidth = 1,\n',
    '      show.legend = FALSE\n',
    '    ) +\n',
    '      geom_text_interactive(\n',
    '        data = meta_slice,\n',
    '        aes_string(\n',
    '          x = 1994,\n',
    '          y = 9.2,\n',
    '          label = \'tooltip\',\n',
    '          data_id = col.by\n',
    '        ),\n',
    '        size = 2.5,\n',
    '        hjust = \"left\",\n',
    '        alpha = 0\n',
    '      ) + scale_color_manual_interactive(data_id = lab,\n',
    '                                         values = cols_level) + coord_fixed()\n',
    '  }} else{{\n',
    '    meta_slice$firm_lab <-\n',
    '      paste0(\'sampleID: \', meta_slice[[\'sampleID\']], \'\\n\', col.by, \': \', meta_slice[[col.by]])\n',
    '    \n',
    '    gg_scatter <- ggplot(\n',
    '      data = meta_slice,\n',
    '      mapping = aes_string(\n',
    '        x = \'imagecol\',\n',
    '        y = \'imagerow\',\n',
    '        color = col.by,\n',
    '        # here we add iteractive aesthetics\n',
    '        tooltip = \'firm_lab\',\n',
    '        data_id = \'sampleID\'\n',
    '      )\n',
    '    )+bg + xlim(xrange) + ylim(rev(yrange)) + theme_classic() + theme(\n',
    '      axis.line = element_blank(),\n',
    '      axis.text = element_blank(),\n',
    '      axis.ticks = element_blank(),\n',
    '      axis.title = element_blank(),\n',
    '      legend.position = \'top\'\n',
    '    ) + geom_point_interactive(size = pt_size, alpha = pt.alpha) + scale_color_distiller(palette = \"Spectral\") + coord_fixed()\n',
    '  }}\n',
    '  gg_scatter\n',
    '}}\n',
    '# spatial feature\n',
    'fthighlightplot <- function(input_image,\n',
    '                            meta_slice,\n',
    '                            genesets,\n',
    '                            meta_all,\n',
    '                            gene = NULL,\n',
    '                            # cols = NULL,\n',
    '                            pt.alpha = 1,\n',
    '                            highlight = NULL,\n',
    '                            data,\n',
    '                            pt_size = 1) {{\n',
    '  if (!is.null(input_image)) {{\n',
    '    xrange <- c(25, dim(input_image)[2] - 25)\n',
    '    yrange <- c(25, dim(input_image)[1] - 25)\n',
    '  }} else{{\n',
    '    xrange <-\n',
    '      c(min(meta_slice$imagecol),\n',
    '        max(meta_slice$imagecol))\n',
    '    yrange <-\n',
    '      c(min(meta_slice$imagerow),\n',
    '        max(meta_slice$imagerow))\n',
    '  }}\n',
    '  if (is.null(genesets) |\n',
    '      is.null(names(genesets)) | !is.numeric(genesets)) {{\n',
    '    stop(\'useless gene set\')\n',
    '  }}\n',
    '  if (is.null(gene) | length(which(names(genesets) == gene)) == 0) {{\n',
    '    shiny::validate(\"Wait a moment, gene ready to load or Don\'t have the gene!\")\n',
    '  }}\n',
    '  \n',
    '  h5file <- H5File$new(data, mode = \"r\")\n',
    '  h5data <- h5file[[\'grp\']][[\'data\']]\n',
    '  meta_all$val <-\n',
    '    h5data$read(args = list(genesets[gene], quote(expr = )))\n',
    '  meta_slice <- meta_all[meta_all$sampleID %in% meta_slice$sampleID]\n',
    '  h5file$close_all()\n',
    '  \n',
    '  if (class(input_image) == \'array\'| class(input_image) == \'raster\') {{\n',
    '    grob <- grid::rasterGrob(input_image, width = grid::unit(1, \"npc\"),\n' ,
    '                         height = grid::unit(1, \"npc\"))\n',
    '     bg <- geom_spatial(data = tibble::tibble(grob = list(grob)), \n',
    '                  aes(grob = grob), x = 0.5, y = 0.5)\n',
    '  }} else{{\n',
    '    bg <- NULL\n',
    '  }}\n',
    '  \n',
    '  meta_slice$firm_lab <-\n',
    '    paste0(\'sampleID: \', meta_slice[[\'sampleID\']], \'\\n\', gene, \': \', round(meta_slice[[\'val\']],4))\n',
    '  \n',
    '  \n',
    '  if(length(intersect(meta_slice$sampleID, highlight)) == 0 | length(intersect(meta_slice$sampleID, highlight)) == length(meta_slice$sampleID)){{\n',
    '    meta_slice$val\n',
    '  }}else{{\n',
    '    meta_slice$val[-which(meta_slice$sampleID %in% highlight)] <- NA\n',
    '  }}\n',
    '  \n',
    '  gg_scatter <- ggplot(\n',
    '    data = meta_slice,\n',
    '    mapping = aes_string(\n',
    '      x = \'imagecol\',\n',
    '      y = \'imagerow\',\n',
    '      color = \'val\',\n',
    '      tooltip = \'firm_lab\',\n',
    '      data_id = \'sampleID\'\n',
    '    )\n',
    '  ) + bg + xlim(xrange) + ylim(rev(yrange)) +\n',
    '    labs(colour = gene, shape = \'val\') + theme_classic() + \n',
    '    theme(\n',
    '      axis.line = element_blank(),\n',
    '      axis.text = element_blank(),\n',
    '      axis.ticks = element_blank(),\n',
    '      axis.title = element_blank(),\n',
    '      legend.position = \'top\'\n',
    '    ) + geom_point_interactive(size = pt_size, alpha = pt.alpha) + scale_color_distiller(palette = \"Spectral\") + coord_fixed()\n',
    '  \n',
    '  \n',
    '  gg_scatter\n',
    '}}\n',
    
    'inter_spatial <- function(gg_scatter,preselection=NULL,width_svg = 6,height_svg = 5,color = \'white\'){{\n',
    '  girafe(\n',
    '    ggobj = gg_scatter,width_svg = width_svg,height_svg = height_svg,\n',
    '    options = list(\n',
    '      # opts_hover_inv(css = \"opacity:0.5;\"),\n',
    '      opts_hover(css = girafe_css(\n',
    '        \"stroke-width:1.5;\"\n',
    '      )),\n',
    '      opts_hover_key(css = \"stroke:black;r:5pt;cursor:pointer;\"),\n',
    '      opts_selection_inv(css = \"opacity:0.4;\"),\n',
    '      opts_selection_key(css = \"stroke:black;r:5pt;\"),\n',
    '      opts_selection(selected = preselection,\n',
    '                     css = \"stroke-width:1.2;\",\n',
    '                     type = \'multiple\',\n',
    '                     only_shiny = F\n',
    '      ),\n',
    '      opts_tooltip(\n',
    '        opacity = 0.8,\n',
    '        use_fill = TRUE,\n',
    '        use_stroke = FALSE,\n',
    '        css = glue::glue(\"padding:5pt;font-family: Open Sans;font-size:1rem;color:{{color}}\")\n',
    '      ),\n',
    '      opts_toolbar(\n',
    '        hidden = NULL,\n',
    '        tooltips = list(\n',
    '          lasso_select = \"Mit Lasso auswählen\",\n',
    '          lasso_deselect = \"Mit Lasso abwählen\",\n',
    '          zoom_on = \"Ansicht beibehalten\",\n',
    '          zoom_off =  \"Ansicht bewegen/zoomen\",\n',
    '          zoom_rect = \"Mit Rechteckauswahl zoomen\",\n',
    '          zoom_reset = \"Ansicht wiederherstellen\",\n',
    '          saveaspng = \"Als PNG-Grafik speichern\"\n',
    '        ),position = \"top\"\n',
    '      ),\n',
    '      opts_zoom(min = .3, max = 2)\n',
    '      \n',
    '    )\n',
    '  )\n',
    '}}\n',
    
    
    
    '# spatial highlight\n',
    'spatial_high_select <- function(input_image,\n',
    '                                meta_slice,\n',
    '                                pt.alpha = 1,\n',
    '                                pt_size = 1) {{\n',
    '  if (!is.null(input_image)) {{\n',
    '    xrange <- c(25, dim(input_image)[2] - 25)\n',
    '    yrange <- c(25, dim(input_image)[1] - 25)\n',
    '  }} else{{\n',
    '    xrange <-\n',
    '      c(min(meta_slice$imagecol),\n',
    '        max(meta_slice$imagecol))\n',
    '    yrange <-\n',
    '      c(min(meta_slice$imagerow),\n',
    '        max(meta_slice$imagerow))\n',
    '  }}\n',
    '  if (length(intersect(\'group\', colnames(meta_slice))) < 1) {{\n',
    '    stop(\'Do not have highlight column!\')\n',
    '  }}\n',
    '  if (length(which(!is.na(unique(meta_slice$group)))) < 1) {{\n',
    '    cols <- NA\n',
    '    if (length(levels(meta_slice$group)) > 0) {{\n',
    '      col_legend <- col_box[1:length(levels(meta_slice$group))]\n',
    '    }} else{{\n',
    '      col_legend <- NULL\n',
    '    }}\n',
    '  }} else{{\n',
    '    cols <- meta_slice$group\n',
    '    levels(cols) <- col_box[1:length(levels(cols))]\n',
    '    \n',
    '    col_legend <- levels(cols)\n',
    '  }}\n',
    '  \n',
    '  if (class(input_image) == \'array\'| class(input_image) == \'raster\') {{\n',
    '    grob <- grid::rasterGrob(input_image, width = grid::unit(1, \"npc\"),\n' ,
    '                         height = grid::unit(1, \"npc\"))\n',
    '     bg <- geom_spatial(data = tibble::tibble(grob = list(grob)), \n',
    '                  aes(grob = grob), x = 0.5, y = 0.5)\n',
    '  }} else{{\n',
    '    bg <- NULL\n',
    '  }}\n',
    '  \n',
    '  \n',
    '  \n',
    '  gg_scatter <- ggplot(\n',
    '    data = meta_slice,\n',
    '    mapping = aes_string(\n',
    '      x = \'imagecol\',\n',
    '      y = \'imagerow\',\n',
    '      # here we add iteractive aesthetics\n',
    '      tooltip = \'tooltip\',\n',
    '      data_id = \'sampleID\'\n',
    '    )\n',
    '  ) + bg + xlim(xrange) + ylim(rev(yrange)) + theme_classic() + theme(\n',
    '    axis.line = element_blank(),\n',
    '    axis.text = element_blank(),\n',
    '    axis.ticks = element_blank(),\n',
    '    axis.title = element_blank(),\n',
    '    legend.position = \'top\',\n',
    '    legend.key.size = unit(2, \'mm\'),\n',
    '    legend.box.background = element_rect(fill = \'white\', colour = \'white\'),legend.key = element_blank(),legend.text = element_text(size = 12)\n',
    '  ) + geom_col_interactive(\n',
    '    mapping = aes_string(\n',
    '      y = 1,\n',
    '      fill = \'group\',\n',
    '      tooltip = \'tooltip\',\n',
    '      data_id = \'sampleID\'\n',
    '    ),\n',
    '    linewidth = 1,\n',
    '    show.legend = FALSE\n',
    '  ) + geom_text_interactive(\n',
    '    data = meta_slice,\n',
    '    aes_string(\n',
    '      x = 1994,\n',
    '      y = 9.2,\n',
    '      label = \'tooltip\',\n',
    '      data_id = \'sampleID\'\n',
    '    ),\n',
    '    size = 2.5,\n',
    '    hjust = \"left\",\n',
    '    alpha = 0\n',
    '  ) + coord_fixed()\n',
    '  \n',
    '  \n',
    '  if (length(which(!is.na(unique(meta_slice$group)))) > 0) {{\n',
    '    cols <- col_box[1:length(levels(meta_slice$group))]\n',
    '    \n',
    '    names(cols) <- levels(meta_slice$group)\n',
    '    \n',
    '    gg_scatter <- gg_scatter + geom_point_interactive(\n',
    '      data = meta_slice,\n',
    '      aes(x = imagecol , y = imagerow, color = group),\n',
    '      size = pt_size,\n',
    '      alpha = 0.5\n',
    '    ) + scale_color_manual(values = cols, na.value = \'grey90\')\n',
    '  }} else{{\n',
    '    gg_scatter <-\n',
    '      gg_scatter + geom_point_interactive(size = pt_size,\n',
    '                                          alpha = 0.5,\n',
    '                                          color = \'grey90\')\n',
    '  }}\n',
    '  \n',
    '  gg_scatter\n',
    '  \n',
    '}}\n',
    
    'sphighlight <- function(gg_scatter,high_cols = \'red\',preselection = NULL){{\n',
    '  ggiraph::girafe(\n',
    '    ggobj = gg_scatter,\n',
    '    options = list(\n',
    '      # opts_hover_inv(css = \"opacity:0.5;\"),\n',
    '      opts_hover(css = girafe_css(\n',
    '        \"stroke-width:1.5;stroke:\'red;fill:red\"\n',
    '      )),\n',
    '      opts_hover_key(css = \"stroke:red;r:5pt;cursor:pointer;\"),\n',
    '      opts_selection_inv(css = \"opacity:1;\"),\n',
    '      opts_selection_key(css = \"stroke:black;r:5pt;\"),\n',
    '      opts_selection(selected = preselection,\n',
    '                     css = glue::glue(\"stroke-width:1.2;fill:{{high_cols}};stroke:{{high_cols}}\"),\n',
    '                     type = \'multiple\',\n',
    '                     only_shiny = F\n',
    '      ),\n',
    '      opts_tooltip(\n',
    '        opacity = 0.8,\n',
    '        use_fill = TRUE,\n',
    '        use_stroke = FALSE,\n',
    '        css = \"padding:5pt;font-family: Open Sans;font-size:1rem;color:white\"\n',
    '      ),\n',
    '      opts_toolbar(\n',
    '        hidden = NULL,\n',
    '        tooltips = list(\n',
    '          lasso_select = \"Mit Lasso auswählen\",\n',
    '          lasso_deselect = \"Mit Lasso abwählen\",\n',
    '          zoom_on = \"Ansicht beibehalten\",\n',
    '          zoom_off =  \"Ansicht bewegen/zoomen\",\n',
    '          zoom_rect = \"Mit Rechteckauswahl zoomen\",\n',
    '          zoom_reset = \"Ansicht wiederherstellen\",\n',
    '          saveaspng = \"Als PNG-Grafik speichern\"\n',
    '        ),\n',
    '        position = \"top\"\n',
    '      ),\n',
    '      opts_zoom(min = .3, max = 2)\n',
    '      \n',
    '    )\n',
    '  )\n',
    '}}\n',
    '### vio/box\n',
    'outvbplot <- function(\n',
    '    x,\n',
    '    y,\n',
    '    meta_group,\n',
    '    meta,\n',
    '    data,\n',
    '    genesets,\n',
    '    groupby = \'No\',\n',
    '    plot_type = \'violin\',\n',
    '    highlight = NULL,\n',
    '    pt_p = FALSE,ynames = NULL) {{\n',
    '  if (groupby == \'No\') {{\n',
    '    groups = NULL\n',
    '    cols <-\n',
    '      strsplit(meta_group[which(meta_group$group == x), color], split = \"\\\\|\") %>% unlist()\n',
    '    clu <-\n',
    '      strsplit(meta_group[which(meta_group$group == x), unit], split = \"\\\\|\") %>% unlist()\n',
    '    \n',
    '    names(cols) <- clu\n',
    '  }} else{{\n',
    '    cols <-\n',
    '      strsplit(meta_group[which(meta_group$group == groupby), color], split = \"\\\\|\") %>% unlist()\n',
    '    clu <-\n',
    '      strsplit(meta_group[which(meta_group$group == groupby), unit], split = \"\\\\|\") %>% unlist()\n',
    '    groups = groupby\n',
    '  }}\n',
    '  \n',
    '  if (length(which(names(genesets) == y)) >= 1) {{\n',
    '    h5file <- H5File$new(data, mode = \"r\")\n',
    '    h5data <- h5file[[\'grp\']][[\'data\']]\n',
    '    val <- h5data$read(args = list(genesets[y], quote(expr=)))\n',
    '    meta[, y] <- val\n',
    '    h5file$close_all()\n',
    '  }}\n',
    '  \n',
    '  if(length(intersect(meta$sampleID, highlight)) == 0 | length(intersect(meta$sampleID, highlight)) == length(meta$sampleID)){{\n',
    '    meta <- meta\n',
    '  }}else{{\n',
    '    meta <- meta[which(meta$sampleID %in% highlight),]\n',
    '  }}\n',
    '  \n',
    '  tab_vb_plot(\n',
    '    tab_meta = meta,\n',
    '    x = x,\n',
    '    y = y,\n',
    '    group = groups,\n',
    '    plot = plot_type,ynames = ynames,\n',
    '    pt = pt_p\n',
    '  )\n',
    '}}\n',
    'tab_vb_plot <- function(tab_meta,\n',
    '                        x,\n',
    '                        y,\n',
    '                        group = NULL,\n',
    '                        plot = \'violin\',\n',
    '                        cols = NULL,ynames = \'gene expression\',\n',
    '                        pt = FALSE) {{\n',
    '  if (is.null(group) | length(which(x == group)) >= 1) {{\n',
    '    if (!is.factor(tab_meta[[x]])) {{\n',
    '      tab_meta[[x]] <- as.factor(tab_meta[[x]])\n',
    '    }}\n',
    '    \n',
    '    if (is.null(cols)) {{\n',
    '      cols <- col_box[1:length(levels(tab_meta[[x]]))]\n',
    '      names(cols) <- levels(tab_meta[[x]])\n',
    '    }}\n',
    '    \n',
    '    tab_meta <- tab_meta[,c(\'sampleID\',x,y),with = F]\n',
    '    colnames(tab_meta)[which(colnames(tab_meta) %in% c(\'sampleID\',x, y))] <-\n',
    '      c(\'sampleID\',\'X\', \'Y\')\n',
    '    tooltip <- tab_meta %>% group_by(X) %>% summarize(\n',
    '      mean = mean(Y),\n',
    '      median = median(Y), \n',
    '      max = max(Y),\n',
    '    ) %>% mutate(tooltip = paste0(\'mean:\',mean,\'\\n\', \'median:\',median, \'\\n\',\'max:\',max))\n',
    '    tab_meta$tooltip <- tooltip[match(tab_meta$X , tooltip$X),\'tooltip\']\n',
    '    \n',
    '    if (plot == \'violin\') {{\n',
    '      p <-\n',
    '        ggplot(tab_meta, aes(x = X, y = Y, fill = X)) +\n',
    '        geom_violin_interactive(aes(tooltip=tooltip),scale = \"width\")+\n',
    '        theme(\n',
    '          axis.text = element_text(size = 24),\n',
    '          panel.background = element_rect(fill = \"white\", colour = NA),\n',
    '          axis.title = element_text(size = 24, face = \'bold\'),title = element_text(size = 24, face = \'bold\'),\n',
    '          axis.text.x = element_text(\n',
    '            angle = 45,\n',
    '            hjust = 1,\n',
    '            vjust = 1\n',
    '          ),\n',
    '          legend.position = \'top\'\n',
    '        ) +\n',
    '        scale_fill_manual(values = cols) + NoLegend()\n',
    '    }} else{{\n',
    '      p <-\n',
    '        ggplot(tab_meta, aes(x = X, y = Y, fill = X)) +\n',
    '        geom_boxplot_interactive(aes(tooltip=tooltip)) +\n',
    '        theme(\n',
    '          axis.text = element_text(size = 24),\n',
    '          panel.background = element_rect(fill = \"white\", colour = NA),\n',
    '          axis.title = element_text(size = 24, face = \'bold\'),title = element_text(size = 24, face = \'bold\'),\n',
    '          axis.text.x = element_text(\n',
    '            angle = 45,\n',
    '            hjust = 1,\n',
    '            vjust = 1\n',
    '          ),\n',
    '          legend.position = \'top\'\n',
    '        ) +\n',
    '        scale_fill_manual(values = cols) + NoLegend()\n',
    '    }}\n',
    '    \n',
    '  }} else if (length(which(colnames(tab_meta) == group)) == 0) {{\n',
    '    stop(\'with out {{group}}\')\n',
    '  }} else{{\n',
    '    if (!is.factor(tab_meta[[group]])) {{\n',
    '      tab_meta[[group]] <- as.factor(tab_meta[[group]])\n',
    '    }}\n',
    '    \n',
    '    if (is.null(cols)) {{\n',
    '      cols <- col_box[1:length(levels(tab_meta[[group]]))]\n',
    '      names(cols) <- levels(tab_meta[[group]])\n',
    '    }}\n',
    '    \n',
    '    tab_meta <- tab_meta[,c(\'sampleID\',x, y, group),with = F]\n',
    '    colnames(tab_meta)[which(colnames(tab_meta) %in% c(\'sampleID\',x, y, group))] <-\n',
    '      c(\'sampleID\',\'X\', \'Y\', \'group\')\n',
    '    \n',
    '    tooltip <- tab_meta %>% group_by(X,group) %>% summarize(\n',
    '      mean = mean(Y),\n',
    '      median = median(Y), \n',
    '      max = max(Y),\n',
    '    ) %>% mutate(tooltip = paste0(\'group:\',group,\'\\n\',\'mean:\',mean,\'\\n\', \'median:\',median, \'\\n\',\'max:\',max))\n',
    '    \n',
    '    tab_meta <- merge(tab_meta,tooltip)\n',
    '    \n',
    '    if (plot == \'violin\') {{\n',
    '      p <-\n',
    '        ggplot(tab_meta, aes(X, Y, fill = group)) + geom_violin_interactive(aes(tooltip=tooltip),scale = \"width\") +\n',
    '        theme(\n',
    '          axis.text = element_text(size = 24),\n',
    '          panel.background = element_rect(fill = \"white\", colour = NA),\n',
    '          axis.title = element_text(size = 24, face = \'bold\'),title = element_text(size = 24, face = \'bold\'),\n',
    '          axis.text.x = element_text(\n',
    '            angle = 45,\n',
    '            hjust = 1,\n',
    '            vjust = 1\n',
    '          ),\n',
    '          legend.position = \'top\'\n',
    '        ) + scale_fill_manual(values = cols) + guides(fill = guide_legend(title = group))\n',
    '    }} else{{\n',
    '      p <-\n',
    '        ggplot(tab_meta, aes(X, Y, fill = group)) + geom_boxplot_interactive(aes(tooltip=tooltip)) +\n',
    '        theme(\n',
    '          panel.background = element_rect(fill = \"white\", colour = NA),\n',
    '          axis.text = element_text(size = 24),\n',
    '          axis.title = element_text(size = 24, face = \'bold\'),title = element_text(size = 24, face = \'bold\'),\n',
    '          axis.text.x = element_text(\n',
    '            angle = 45,\n',
    '            hjust = 1,\n',
    '            vjust = 1\n',
    '          ),\n',
    '          legend.position = \'top\'\n',
    '        ) + scale_fill_manual(values = cols) + guides(fill = guide_legend(title = group))\n',
    '    }}\n',
    '  }}\n',
    '  \n',
    '  if (pt) {{\n',
    '    if (is.null(group) | length(which(x == group)) >= 1) {{\n',
    '      p <-\n',
    '        p + geom_point(\n',
    '          shape = 16,\n',
    '          mapping = aes(x = X, y = Y),\n',
    '          position = position_jitter()\n',
    '        )\n',
    '    }} else{{\n',
    '      p <- p + geom_point(\n',
    '        shape = 16,\n',
    '        mapping = aes(x = X, y = Y),\n',
    '        position = position_jitterdodge()\n',
    '      )\n',
    '    }}\n',
    '  }}\n',
    '  p + xlab(x) + ylab(ynames) + labs(title = y)\n',
    '}}\n',
    '### barplot\n',
    'tab_bar_plot <- function(tab_meta,\n',
    '                         x,\n',
    '                         col_by,\n',
    '                         xyflip = FALSE,\n',
    '                         value = \'percentage\',\n',
    '                         cols = NULL) {{\n',
    '  tab_meta <- tab_meta[,c(\'sampleID\',x,col_by),with = F]\n',
    '  colnames(tab_meta) <- c(\'sampleID\',\'x\',\'col_by\')\n',
    '  if (!is.factor(tab_meta$col_by)) {{\n',
    '    tab_meta$col_by <- as.factor(tab_meta$col_by)\n',
    '  }}\n',
    '  if (is.null(cols)) {{\n',
    '    cols <- col_box[1:length(levels(tab_meta$col_by))]\n',
    '    names(cols) <- levels(tab_meta$col_by)\n',
    '  }}\n',
    '  \n',
    '  df <- tab_meta %>% group_by(x, col_by) %>%\n',
    '    mutate(num = n()) %>% ungroup() %>% select(x, col_by, num) %>% unique() %>%\n',
    '    group_by(x) %>% mutate(pct = 100 * num / sum(num))\n',
    '  \n',
    '  df$tooltip <- paste0(\'x:\',df$x,\'\\n\',\'col.by:\',df$col_by,\'\\n\',\'num:\',df$num,\'\\n\',\'pct:\',df$pct)\n',
    '  \n',
    '  if (value == \'percentage\') {{\n',
    '    p <- ggplot(df, mapping = aes(x = x, y = pct)) +\n',
    '      geom_col_interactive(mapping = aes(fill = col_by,tooltip = tooltip,data_id = tooltip), width = 0.8) +\n',
    '      theme(\n',
    '        panel.background = element_rect(fill = \"white\", colour = NA),\n',
    '        axis.text = element_text(size = 24),\n',
    '        axis.title = element_text(size = 24, face = \'bold\'),\n',
    '        axis.text.x = element_text(\n',
    '          angle = 45,\n',
    '          hjust = 1,\n',
    '          vjust = 1\n',
    '        ),\n',
    '        axis.line =   element_line(colour = \"black\")\n',
    '      ) + xlab(\'orig.ident\') + ylab(\'percentage(%)\') + scale_fill_manual(values = cols)\n',
    '  }} else if (value == \'number\') {{\n',
    '    p <- ggplot(df, mapping = aes(x = x, y = num)) +\n',
    '      geom_col_interactive(mapping = aes(fill = col_by,tooltip = tooltip,data_id = tooltip), width = 0.8) +\n',
    '      theme(\n',
    '        panel.background = element_rect(fill = \"white\", colour = NA),\n',
    '        axis.text = element_text(size = 24),\n',
    '        axis.title = element_text(size = 24, face = \'bold\'),\n',
    '        axis.text.x = element_text(\n',
    '          angle = 45,\n',
    '          hjust = 1,\n',
    '          vjust = 1\n',
    '        ),\n',
    '        axis.line =   element_line(colour = \"black\")\n',
    '      ) + xlab(\'orig.ident\') + ylab(\'number of cells\') + scale_fill_manual(values = cols)\n',
    '  }} else{{\n',
    '    stop(\'can not find the type\')\n',
    '  }}\n',
    '  \n',
    '  if (xyflip) {{\n',
    '    p + coord_flip()\n',
    '  }} else{{\n',
    '    p\n',
    '  }}\n',
    '}}\n',
    
    'outbarplot <- function(meta_group,\n',
    '                       meta,\n',
    '                       groupby,\n',
    '                       x,\n',
    '                       highlight = NULL,\n',
    '                       value = \'percentage\',\n',
    '                       xyflip = FALSE) {{\n',
    '  cols <-\n',
    '    strsplit(meta_group[which(meta_group$group == groupby), color], split = \"\\\\|\") %>% unlist()\n',
    '  clu <-\n',
    '    strsplit(meta_group[which(meta_group$group == groupby), unit], split = \"\\\\|\") %>% unlist()\n',
    '  names(cols) <- clu\n',
    '  \n',
    '  if(length(intersect(highlight, meta$sampleID)) > 0) {{\n',
    '    meta <- meta[which(meta$sampleID %in% highlight), ]\n',
    '  }}\n',
    '  \n',
    '  tab_bar_plot(\n',
    '    tab_meta = meta,\n',
    '    x = x,\n',
    '    col_by = groupby,\n',
    '    xyflip = xyflip,\n',
    '    cols = cols,\n',
    '    value = value\n',
    '  )\n',
    '}}\n',
    '### heatmap dotplot\n',
    'heatxlength <- function(scgroup, groupby, meta_group) {{\n',
    '  if (length(intersect(scgroup, meta_group$group[meta_group$info == T])) > 0) {{\n',
    '    if (meta_group[group == groupby]$unit != meta_group[group == scgroup]$unit) {{\n',
    '      lns <-\n',
    '        length(strsplit(meta_group[group == groupby]$unit, split = \'\\\\|\')[[1]]) *\n',
    '        length(strsplit(meta_group[group == scgroup]$unit, split = \'\\\\|\')[[1]])\n',
    '    }}else{{\n',
    '      lns <- length(strsplit(meta_group[group == groupby]$unit, split = \'\\\\|\')[[1]])\n',
    '    }}\n',
    '  }}else{{\n',
    '    lns <- length(strsplit(meta_group[group == groupby]$unit, split = \'\\\\|\')[[1]])\n',
    '  }}\n',
    '  return(lns)\n',
    '}}\n',
    
    
    'dot_heat_plot <-\n',
    '  function(genelists,\n',
    '           genesets,\n',
    '           groupby,\n',
    '           scgroup = NULL,\n',
    '           tab_meta,\n',
    '           plot_type = \'dotplot\',\n',
    '           meta_group,\n',
    '           data,\n',
    '           highlight = NULL,\n',
    '           inpRow = TRUE,\n',
    '           inpCol = FALSE,\n',
    '           scale_build = TRUE) {{\n',
    '    gene <- unique(trimws(strsplit(genelists, \",|;|\n',
    '\")[[1]]))\n',
    '    gene <- intersect(gene, names(genesets))\n',
    '    shiny::validate(need(length(gene) <= 50,\n',
    '                         \"More than 50 genes to plot! Please reduce the gene list!\"))\n',
    '    shiny::validate(need(length(gene) > 1, \"Please input at least 2 genes to plot!\"))\n',
    '    h5file <- H5File$new(data, mode = \"r\")\n',
    '    h5data <- h5file[[\"grp\"]][[\"data\"]]\n',
    '    genelist <- data.table()\n',
    '    for (i in gene) {{\n',
    '      tmp <- tab_meta[, c(\"sampleID\", meta_group[group == groupby]$group), with = FALSE]\n',
    '      colnames(tmp) = c(\"sampleID\", \"sub\")\n',
    '      if(length(intersect(scgroup, meta_group$group[meta_group$info == T])) > 0){{\n',
    '        if(meta_group[group == groupby]$unit != meta_group[group == scgroup]$unit){{\n',
    '          tmp$scgroup <- tab_meta[[scgroup]]\n',
    '          tmp$scgroup <- paste(tmp$scgroup,tmp$sub,sep = \'_\')\n',
    '        }}else{{\n',
    '          tmp$scgroup <- tmp$sub\n',
    '        }}\n',
    '      }}else{{\n',
    '        tmp$scgroup <- tmp$sub\n',
    '      }}\n',
    '      tmp$geneName = i\n',
    '      tmp$exp = h5data$read(args = list(genesets[i], quote(expr = )))\n',
    '      genelist <- rbindlist(list(genelist, tmp))}}\n',
    '    h5file$close_all()\n',
    '    if (length(intersect(highlight, genelist$sampleID)) > 0) {{\n',
    '      genelist <- genelist[which(genelist$sampleID %in% highlight),]\n',
    '    }}\n',
    '    shiny::validate(need(\n',
    '      uniqueN(genelist$scgroup) > 1,\n',
    '      \"Only 1 group present, unable to plot!\"))\n',
    '    \n',
    '    # Aggregate\n',
    '    genelist$exp = expm1(genelist$exp)\n',
    '    genelist = genelist[, .(exp = mean(exp),prop = sum(exp > 0) / length(sampleID)),by = c(\"geneName\", \"scgroup\")]\n',
    '    genelist$exp = log1p(genelist$exp)\n',
    '    \n',
    '    # Scale if required\n',
    '    colRange = range(genelist$exp)\n',
    '    if (scale_build) {{\n',
    '      genelist[, exp := scale(exp), keyby = \"geneName\"]\n',
    '      colRange = c(-max(abs(range(genelist$exp))), max(abs(range(genelist$exp))))\n',
    '    }}\n',
    '    \n',
    '    # hclust row/col if necessary\n',
    '    Mat = dcast.data.table(genelist, geneName ~ scgroup, value.var = \"exp\")\n',
    '    tmp = Mat$geneName\n',
    '    Mat = as.matrix(Mat[, -1])\n',
    '    rownames(Mat) = tmp\n',
    '    if (inpRow) {{\n',
    '      hcRow = dendro_data(as.dendrogram(hclust(dist(Mat))))\n',
    '      ggRow = ggtree(hclust(dist(Mat)))\n',
    '      genelist$geneName = factor(genelist$geneName, levels = hcRow$labels$label)\n',
    '    }} else {{\n',
    '      genelist$geneName = factor(genelist$geneName, levels = rev(unique(gene)))\n',
    '    }}\n',
    '    if (inpCol) {{\n',
    '      hcCol = dendro_data(as.dendrogram(hclust(dist(t(\n',
    '        Mat\n',
    '      )))))\n',
    '      ggCol = ggtree(hclust(dist(t(Mat)))) + layout_dendrogram()\n',
    '      genelist$scgroup = factor(genelist$scgroup, levels = hcCol$labels$label)\n',
    '    }} else{{\n',
    '      if(!is.factor(genelist$scgroup)){{\n',
    '        genelist$scgroup = factor(genelist$scgroup, levels = rev(unique(genelist$scgroup)))\n',
    '      }}\n',
    '    }}\n',
    '    \n',
    '    genelist$tooltip <-\n',
    '      paste0(\'sub:\',genelist$sub,\n',
    '             \'\\n\',genelist$geneName,\n',
    '             \':\',round(genelist$exp, 3),\n',
    '             \'\\n\',\'pct\',\':\',\n',
    '             round(genelist$prop * 100, 3),\'%\')\n',
    '    \n',
    '    if (plot_type == \'dotplot\') {{\n',
    '      p <-\n',
    '        ggplot(genelist, aes(scgroup, geneName, size = prop,color = exp, tooltip = tooltip)) +\n',
    '        geom_point_interactive() +\n',
    '        theme_bw() +\n',
    '        scale_size_continuous(\n',
    '          \"proportion\",\n',
    '          range = c(0, 8),\n',
    '          limits = c(0, 1),\n',
    '          breaks = c(0.00, 0.25, 0.50, 0.75, 1.00)\n',
    '        ) +\n',
    '        theme(\n',
    '          legend.box.background = element_rect(fill = \'white\', colour = \'white\'),\n',
    '          legend.key = element_blank(),\n',
    '          panel.grid = element_blank(),\n',
    '          axis.title = element_blank(),\n',
    '          legend.box = \"vertical\",\n',
    '          axis.line = element_line(colour = \"black\"),\n',
    '          panel.background = element_rect(fill = \'white\', colour = NA),\n',
    '          axis.text = element_text(size = 25),\n',
    '          axis.text.x = element_text(\n',
    '            angle = 45,\n',
    '            hjust = 1,\n',
    '            vjust = 1\n',
    '          )\n',
    '        ) +\n',
    '        scale_color_gradientn(\n',
    '          colors = c(\'#0e7c99\',\"#60bde6\", \'white\', \"#e99ea4\", \'#d8394c\'),\n',
    '          \"expression\",\n',
    '          limits = colRange\n',
    '        ) +\n',
    '        labs(x = NULL, y = NULL) +\n',
    '        guides(size = guide_legend(order = 3)) + coord_cartesian(xlim = c(1, length(levels(genelist$scgroup))))\n',
    '    }} else if (plot_type == \'heatmap\') {{\n',
    '      p <- ggplot(genelist, aes(scgroup, geneName, fill = exp)) +\n',
    '        geom_tile() +\n',
    '        theme_bw() +\n',
    '        theme(\n',
    '          legend.box.background = element_rect(fill = \'white\', colour = \'white\'),\n',
    '          legend.key = element_blank(),\n',
    '          panel.grid = element_blank(),\n',
    '          axis.title = element_blank(),\n',
    '          legend.box = \"vertical\",\n',
    '          axis.line = element_line(colour = \"black\"),\n',
    '          panel.background = element_rect(fill = \'white\', colour = NA),\n',
    '          axis.text = element_text(size = 15),\n',
    '          axis.text.x = element_text(\n',
    '            angle = 30,\n',
    '            hjust = 1,\n',
    '            vjust = 1\n',
    '          )\n',
    '        ) +\n',
    '        scale_fill_gradientn(\n',
    '          colors = c(\'#0e7c99\',\"#60bde6\", \'white\', \"#e99ea4\", \'#d8394c\'),\n',
    '          \"expression\",\n',
    '          limits = colRange\n',
    '        ) +\n',
    '        labs(x = NULL, y = NULL) +\n',
    '        guides(size = guide_legend(order = 3)) + coord_cartesian(xlim = c(1, length(levels(genelist$scgroup))))\n',
    '    }}\n',
    '    \n',
    '    if (inpRow & inpCol) {{\n',
    '      ggOut <-\n',
    '        p %>% insert_top(ggCol, height = 0.2) %>% insert_left(ggRow, width = 0.2)\n',
    '    }} else if (inpRow) {{\n',
    '      ggOut <- p %>% insert_left(ggRow, width = 0.2)\n',
    '    }} else if (inpCol) {{\n',
    '      ggOut <- p %>% insert_top(ggCol, height = 0.2)\n',
    '    }} else{{\n',
    '      ggOut <- p\n',
    '    }}\n',
    '    \n',
    '    \n',
    '    return(ggOut)\n',
    '  }}\n',
    '# extract legend\n',
    'g_legend <- function(a.gplot){{  \n',
    '  tmp <- ggplot_gtable(ggplot_build(a.gplot))  \n',
    '  leg <- which(sapply(tmp$grobs, function(x) x$name) == \"guide-box\")  \n',
    '  legend <- tmp$grobs[[leg]]  \n',
    '  legend \n',
    '}}\n',
    '# linear color\n',
    'bilinear <- function(x, y, xy, Q11, Q21, Q12, Q22) {{\n',
    '  oup = (xy - x) * (xy - y) * Q11 + x * (xy - y) * Q21 + (xy - x) * y * Q12 + x *\n',
    '    y * Q22\n',
    '  oup = oup / (xy * xy)\n',
    '  return(oup)\n',
    '}}\n',
    '# coexpression spatial feature\n',
    'coexp_feature <-\n',
    '  function(meta_slice,\n',
    '           meta_all,\n',
    '           data,\n',
    '           meta_group,\n',
    '           gene1,\n',
    '           gene2,\n',
    '           input_image,\n',
    '           highlight = NULL,\n',
    '           genesets,\n',
    '           group = NULL,\n',
    '           inpcol = \'Red (Gene1); Blue (Gene2)\',\n',
    '           pt.alpha = 1,\n',
    '           pt_size = 1,\n',
    '           threshold1 = 0,\n',
    '           threshold2 = 0) {{\n',
    '    if(!is.null(input_image)){{\n',
    '      xrange <- c(25, dim(input_image)[2] - 25)\n',
    '      yrange <- c(25, dim(input_image)[1] - 25)\n',
    '    }}else{{\n',
    '      xrange <-\n',
    '        c(min(meta_slice$imagecol),\n',
    '          max(meta_slice$imagecol))\n',
    '      yrange <-\n',
    '        c(min(meta_slice$imagerow),\n',
    '          max(meta_slice$imagerow))\n',
    '    }}\n',
    '    \n',
    '    if (length(intersect(names(genesets), c(gene1, gene2))) < 2) {{\n',
    '      validate(\"Wait a moment, gene ready to load or Don\'t have the gene!\")}}\n',
    '    \n',
    '    \n',
    '    h5file <- H5File$new(data, mode = \"r\")\n',
    '    h5data <- h5file[[\'grp\']][[\'data\']]\n',
    '    meta_all$val1 <-\n',
    '      h5data$read(args = list(genesets[gene1], quote(expr = )))\n',
    '    meta_all$val2 <-\n',
    '      h5data$read(args = list(genesets[gene2], quote(expr = )))\n',
    '    h5file$close_all()\n',
    '    meta_slice <-\n',
    '      meta_all[meta_all$sampleID %in% meta_slice$sampleID]\n',
    '    \n',
    '    meta_slice[which(meta_slice$val1 <= max(meta_slice$val1) * threshold1), \'val1\'] <-\n',
    '      0\n',
    '    meta_slice[which(meta_slice$val2 <= max(meta_slice$val2) * threshold2), \'val2\'] <-\n',
    '      0\n',
    '    \n',
    '    rat = (max(meta_slice$imagecol) - min(meta_slice$imagecol)) / (max(meta_slice$imagerow) - min(meta_slice$imagerow))\n',
    '    cInp = strsplit(inpcol, \"; \")[[1]]\n',
    '    if (cInp[1] == \"Red (Gene1)\") {{\n',
    '      c10 = c(255, 0, 0)\n',
    '    }} else if (cInp[1] == \"Orange (Gene1)\") {{\n',
    '      c10 = c(255, 140, 0)\n',
    '    }} else {{\n',
    '      c10 = c(0, 255, 0)\n',
    '    }}\n',
    '    if (cInp[2] == \"Green (Gene2)\") {{\n',
    '      c01 = c(0, 255, 0)\n',
    '    }} else {{\n',
    '      c01 = c(0, 0, 255)\n',
    '    }}\n',
    '    c00 = c(217, 217, 217)\n',
    '    c11 = c10 + c01\n',
    '    nGrid = 16\n',
    '    nPad = 2\n',
    '    nTot = nGrid + nPad * 2\n',
    '    gg = data.table::data.table(v1 = rep(0:nTot, nTot + 1), v2 = sort(rep(0:nTot, nTot +\n',
    '                                                                            1)))\n',
    '    gg$vv1 = gg$v1 - nPad\n',
    '    gg[vv1 < 0]$vv1 = 0\n',
    '    gg[vv1 > nGrid]$vv1 = nGrid\n',
    '    gg$vv2 = gg$v2 - nPad\n',
    '    gg[vv2 < 0]$vv2 = 0\n',
    '    gg[vv2 > nGrid]$vv2 = nGrid\n',
    '    gg$cR = bilinear(gg$vv1, gg$vv2, nGrid, c00[1], c10[1], c01[1], c11[1])\n',
    '    gg$cG = bilinear(gg$vv1, gg$vv2, nGrid, c00[2], c10[2], c01[2], c11[2])\n',
    '    gg$cB = bilinear(gg$vv1, gg$vv2, nGrid, c00[3], c10[3], c01[3], c11[3])\n',
    '    gg$cMix = rgb(gg$cR, gg$cG, gg$cB, maxColorValue = 255)\n',
    '    gg = gg[, c(\"v1\", \"v2\", \"cMix\")]\n',
    '    \n',
    '    if(length(intersect(unique(meta_slice$val1), 0)) == length(unique(meta_slice$val1))){{\n',
    '      meta_slice$v1 <- 0\n',
    '    }}else{{\n',
    '      meta_slice$v1 = round(nTot * meta_slice$val1 / max(meta_slice$val1))\n',
    '    }}\n',
    '    \n',
    '    if(length(intersect(unique(meta_slice$val2), 0)) == length(unique(meta_slice$val2))){{\n',
    '      meta_slice$v2 <- 0\n',
    '    }}else{{\n',
    '      meta_slice$v2 = round(nTot * meta_slice$val2 / max(meta_slice$val2))\n',
    '    }}\n',
    '    meta_slice$v0 = meta_slice$v1 + meta_slice$v2\n',
    '    meta_slice = gg[meta_slice, on = c(\"v1\", \"v2\")]\n',
    '    \n',
    '    if (class(input_image) == \'array\'| class(input_image) == \'raster\') {{\n',
    '    grob <- grid::rasterGrob(input_image, width = grid::unit(1, \"npc\"),\n' ,
    '                         height = grid::unit(1, \"npc\"))\n',
    '     bg <- geom_spatial(data = tibble::tibble(grob = list(grob)), \n',
    '                  aes(grob = grob), x = 0.5, y = 0.5)\n',
    '    }} else{{\n',
    '      bg <- NULL\n',
    '    }}\n',
    '    \n',
    '    \n',
    '    if(length(intersect(colnames(meta_slice), group)) > 0){{\n',
    '      meta_slice$firm_lab <-\n',
    '        paste0(\n',
    '          \'sampleID: \',\n',
    '          meta_slice[[\'sampleID\']],\n',
    '          \'\\n\',\n',
    '          group,\n',
    '          \': \',\n',
    '          meta_slice[[group]],\n',
    '          \'\\n\',\n',
    '          gene1,\n',
    '          \': \',\n',
    '          round(meta_slice[[\'val1\']], 2),\n',
    '          \'\\n\',\n',
    '          gene2,\n',
    '          \': \',\n',
    '          round(meta_slice[[\'val2\']], 2)\n',
    '        )\n',
    '    }}else{{\n',
    '      meta_slice$firm_lab <-\n',
    '        paste0(\n',
    '          \'sampleID: \',\n',
    '          meta_slice[[\'sampleID\']],\n',
    '          \'\\n\',\n',
    '          gene1,\n',
    '          \': \',\n',
    '          round(meta_slice[[\'val1\']], 2),\n',
    '          \'\\n\',\n',
    '          gene2,\n',
    '          \': \',\n',
    '          round(meta_slice[[\'val2\']], 2)\n',
    '        )\n',
    '    }}\n',
    '    \n',
    '    \n',
    '    \n',
    '    if(length(intersect(meta_slice$sampleID, highlight)) == 0 | length(intersect(meta_slice$sampleID, highlight)) == length(meta_slice$sampleID)){{\n',
    '      meta_slice$cMix <- meta_slice$cMix\n',
    '    }}else{{\n',
    '      meta_slice$cMix[-which(meta_slice$sampleID %in% highlight)] <- NA\n',
    '    }}\n',
    '    \n',
    '    ggplot(\n',
    '      data = meta_slice,\n',
    '      mapping = aes_string(\n',
    '        x = \'imagecol\',\n',
    '        y = \'imagerow\',\n',
    '        tooltip = \'firm_lab\',\n',
    '        data_id = \'sampleID\'\n',
    '      )\n',
    '    ) + bg + xlim(xrange) + ylim(rev(yrange)) +\n',
    '      theme_classic() + \n',
    '      theme(\n',
    '        axis.line = element_blank(),\n',
    '        axis.text = element_blank(),\n',
    '        axis.ticks = element_blank(),\n',
    '        axis.title = element_blank(),\n',
    '        legend.position = \'top\'\n',
    '      ) + geom_point_interactive(size = pt_size, alpha = pt.alpha, color = meta_slice$cMix) + coord_fixed()\n',
    '    \n',
    '    \n',
    '    # gg_scatter\n',
    '  }}\n',
    
    
    '### coexpression legend\n',
    'coexleg <- function(gene1, gene2, inpcol = \'Red (Gene1); Blue (Gene2)\'){{ \n',
    '  # Generate coex color palette \n',
    '  cInp = strsplit(inpcol, \"; \")[[1]] \n',
    '  if(cInp[1] == \"Red (Gene1)\"){{ \n',
    '    c10 = c(255,0,0) \n',
    '  }} else if(cInp[1] == \"Orange (Gene1)\"){{ \n',
    '    c10 = c(255,140,0) \n',
    '  }} else {{ \n',
    '    c10 = c(0,255,0) \n',
    '  }} \n',
    '  if(cInp[2] == \"Green (Gene2)\"){{ \n',
    '    c01 = c(0,255,0) \n',
    '  }} else {{ \n',
    '    c01 = c(0,0,255) \n',
    '  }} \n',
    '  c00 = c(217,217,217) ; c11 = c10 + c01 \n',
    '  nGrid = 16; nPad = 2; nTot = nGrid + nPad * 2 \n',
    '  gg = data.table(v1 = rep(0:nTot,nTot+1), v2 = sort(rep(0:nTot,nTot+1))) \n',
    '  gg$vv1 = gg$v1 - nPad ; gg[vv1 < 0]$vv1 = 0; gg[vv1 > nGrid]$vv1 = nGrid \n',
    '  gg$vv2 = gg$v2 - nPad ; gg[vv2 < 0]$vv2 = 0; gg[vv2 > nGrid]$vv2 = nGrid \n',
    '  gg$cR = bilinear(gg$vv1, gg$vv2, nGrid, c00[1], c10[1], c01[1], c11[1]) \n',
    '  gg$cG = bilinear(gg$vv1, gg$vv2, nGrid, c00[2], c10[2], c01[2], c11[2]) \n',
    '  gg$cB = bilinear(gg$vv1, gg$vv2, nGrid, c00[3], c10[3], c01[3], c11[3]) \n',
    '  gg$cMix = rgb(gg$cR, gg$cG, gg$cB, maxColorValue = 255) \n',
    '  gg = gg[, c(\"v1\", \"v2\", \"cMix\")] \n',
    '  \n',
    '  # Actual ggplot \n',
    '  ggOut = ggplot(gg, aes(v1, v2)) + \n',
    '    geom_tile(fill = gg$cMix) + \n',
    '    xlab(gene1) + ylab(gene2) + coord_fixed(ratio = 1) + \n',
    '    scale_x_continuous(breaks = c(0, nTot), label = c(\"low\", \"high\")) + \n',
    '    scale_y_continuous(breaks = c(0, nTot), label = c(\"low\", \"high\")) + \n',
    '    theme(\n',
    '      legend.box = \"vertical\",\n',
    '      axis.line = element_line(colour = \"black\"),\n',
    '      panel.background = element_rect(fill = \'white\', colour = NA),\n',
    '      axis.title = element_text(size = 24,face = \'bold\'),\n',
    '      axis.text = element_text(size = 24),\n',
    '      axis.text.x = element_text(\n',
    '        angle = 45,\n',
    '        hjust = 1,\n',
    '        vjust = 1\n',
    '      )\n',
    '    ) \n',
    '  return(ggOut) \n',
    '}} \n',
    '## coexpression table\n',
    'coexp_tab <-\n',
    '  function(tab_meta,\n',
    '           data,\n',
    '           metagroup,\n',
    '           genesets,\n',
    '           gene1,\n',
    '           gene2,\n',
    '           highlight = NULL,\n',
    '           threshold1 = 0,\n',
    '           threshold2 = 0,\n',
    '           new_group = NULL) {{\n',
    '    if (length(intersect(names(genesets), c(gene1, gene2))) < 2) {{\n',
    '      validate(\"Wait a moment, gene ready to load or Don\'t have the gene!\")}}\n',
    '    h5file <- H5File$new(data, mode = \"r\")\n',
    '    h5data <- h5file[[\'grp\']][[\'data\']]\n',
    '    tab_meta$val1 <-\n',
    '      h5data$read(args = list(genesets[gene1], quote(expr = )))\n',
    '    tab_meta$val2 <-\n',
    '      h5data$read(args = list(genesets[gene2], quote(expr = )))\n',
    '    h5file$close_all()\n',
    '    \n',
    '    tab_meta[which(tab_meta$val1 <= max(tab_meta$val1) * threshold1), \'val1\'] <- 0\n',
    '    tab_meta[which(tab_meta$val2 <= max(tab_meta$val2) * threshold2), \'val2\'] <- 0\n',
    '    \n',
    '    if (length(intersect(tab_meta$sampleID, highlight)) > 0) {{\n',
    '      tab_meta <- tab_meta[which(tab_meta$sampleID %in% highlight), ]}}\n',
    '    \n',
    '    if (length(intersect(metagroup[[\'group\']], new_group)) == 0) {{\n',
    '      df = tab_meta[, .(\n',
    '        gene1_ex = sum(val1 > 0 & val2 <= 0),\n',
    '        gene2_ex = sum(val2 > 0 & val1 <= 0),\n',
    '        both = sum(val2 > 0 & val1 > 0),\n',
    '        none = sum(val2 <= 0 & val1 <= 0)),]\n',
    '      \n',
    '      df %<>% t() %>% as.data.frame()\n',
    '      colnames(df) <- \'nSpot\'\n',
    '      df$expression <- rownames(df)\n',
    '      \n',
    '      df[1:2, \"expression\"] <-\n',
    '        c(paste(gene1, \'>\' , round(threshold1 * max(tab_meta$val1), 2)), paste(gene2, \'>\' , round(threshold2 * max(tab_meta$val2), 2)))\n',
    '      \n',
    '      df %<>% mutate(pct = round(100 * nSpot / sum(nSpot), 2))\n',
    '      rownames(df) <- NULL\n',
    '      \n',
    '      df <- df[, c(\'expression\', \'nSpot\', \'pct\')]\n',
    '    }} else{{\n',
    '      colnames(tab_meta)[which(colnames(tab_meta) == new_group)] <-\n',
    '        \'new_group\'\n',
    '      df = tab_meta[, .(\n',
    '        gene1_ex = sum(val1 > 0 & val2 <= 0),\n',
    '        gene2_ex = sum(val2 > 0 & val1 <= 0),\n',
    '        both = sum(val2 > 0 & val1 > 0),\n',
    '        none = sum(val2 <= 0 & val1 <= 0)\n',
    '      ),by = new_group]\n',
    '      \n',
    '      \n',
    '      if (length(which(is.na(df$new_group))) > 0) {{\n',
    '        df <- df[-which(is.na(df$new_group)), ]}}\n',
    '      \n',
    '      df <- lapply(unique(df$new_group), function(x) {{\n',
    '        df_ <- subset(df, df$new_group == x)\n',
    '        df_ <- df_[, -1]\n',
    '        df_ %<>% t() %>% as.data.frame()\n',
    '        colnames(df_) <- \'nSpot\'\n',
    '        df_$expression <- rownames(df_)\n',
    '        df_[1:2, \"expression\"] <-\n',
    '          c(paste(gene1, \'>\' , round(threshold1 * max(\n',
    '            tab_meta$val1\n',
    '          ), 2)), paste(gene2, \'>\' , round(threshold2 * max(\n',
    '            tab_meta$val2\n',
    '          ), 2)))\n',
    '        df_ %<>% mutate(pct = round(100 * nSpot / sum(nSpot), 2))\n',
    '        df_[, new_group] <- x\n',
    '        df_}})\n',
    '      \n',
    '      df <- do.call(rbind, df)\n',
    '      rownames(df) <- NULL\n',
    '      df <- df[, c(\'expression\', \'nSpot\', \'pct\', new_group)]\n',
    '    }}\n',
    '    return(df)\n',
    '  }}\n',
    
    'tab_exp_clu <-\n',
    '  function(data,\n',
    '           meta,\n',
    '           gene,genesets,\n',
    '           inpsplt,\n',
    '           group.by,meta_group,threshold = 0,highlight =NULL) {{\n',
    '    if (is.null(gene) | length(which(names(genesets) == gene)) == 0) {{\n',
    '      shiny::validate(\"Wait a moment, gene ready to load or Don\'t have the gene!\")\n',
    '    }}\n',
    '    h5file <- H5File$new(data, mode = \"r\")\n',
    '    h5data <- h5file[[\'grp\']][[\'data\']]\n',
    '    meta$val <- h5data$read(args = list(genesets[gene], quote(expr = )))\n',
    '    h5file$close_all()\n',
    '    meta = meta[, c(\'sampleID\', group.by, \'val\'),\n',
    '                with = FALSE]\n',
    '    colnames(meta) = c(\'sampleID\', \"sub\", \'val\')\n',
    '    meta <- meta[!is.na(sub)]\n',
    '    if (meta_group[group == group.by]$info != \'TRUE\') {{\n',
    '      if (inpsplt == \"Quartile\") {{nBk = 4}}\n',
    '      if (inpsplt == \"Decile\") {{nBk = 10}}\n',
    '      meta$sub = cut(meta$sub, breaks = nBk)}}\n',
    '    \n',
    '    if(length(intersect(meta$sampleID, highlight)) > 0){{\n',
    '      meta <- meta[which(meta$sampleID %in% highlight),]}}\n',
    '    \n',
    '    meta$express = FALSE\n',
    '    meta[val > max(meta$val)*threshold]$express = TRUE\n',
    '    meta1 = meta[express == TRUE, .(nExpress = .N), by = \"sub\"]\n',
    '    meta = meta[, .(nCells = .N,Mean = mean(val)), by = \"sub\"]\n',
    '    meta = meta1[meta, on = \"sub\"]\n',
    '    meta = meta[, c(\"sub\", \"nCells\", \"nExpress\", \'Mean\'), with = FALSE]\n',
    '    meta[is.na(nExpress)]$nExpress = 0\n',
    '    meta$pctExpress = 100 * meta$nExpress / meta$nCells\n',
    '    meta = meta[order(sub)]\n',
    '    colnames(meta)[3] = paste0(colnames(meta)[3], \"_\", gene)\n',
    '    return(meta)}}\n\n',
    
    'spatialdwls <- function(input_image,deconv,pie_scale = 0.5, score = NULL,pt.alpha = 0.7,pt_size = 0.8){{\n',
    '  if (!is.null(input_image)) {{\n',
    '    xrange <- c(25, dim(input_image)[2] - 25)\n',
    '    yrange <- c(25, dim(input_image)[1] - 25)\n',
    '  }} else{{\n',
    '    xrange <-\n',
    '      c(min(meta_slice$imagecol),\n',
    '        max(meta_slice$imagecol))\n',
    '    yrange <-\n',
    '      c(min(meta_slice$imagerow),\n',
    '        max(meta_slice$imagerow))\n',
    '  }}\n',
    '  if(class(input_image) == \'array\' | class(input_image) == \'raster\'){{\n',
    '    grob <- grid::rasterGrob(input_image, width = grid::unit(1, \"npc\"),\n',
    '                             height = grid::unit(1, \"npc\"))\n',
    '    bg <- geom_spatial(data = tibble::tibble(grob = list(grob)), \n',
    '                       aes(grob = grob), x = 0.5, y = 0.5)\n',
    '    # bg <- ggpubr::background_image(input_image)\n',
    '  }}else{{\n',
    '    bg <- NULL\n',
    '  }}\n',
    '  if(!is.null(score)){{\n',
    '    \n',
    '    \n',
    '    deconv$firm_lab <-\n',
    '      paste0(\'sampleID: \', deconv[[\'sampleID\']], \'\\n\', strsplit(score,split = \'_\')[[1]][2], \': \', deconv[[score]], \'\\n\', \n',
    '             \'PCT: \', deconv[[strsplit(score,split = \'_\')[[1]][2]]])\n',
    '    \n',
    '    gg_scatter <- ggplot(\n',
    '      data = deconv,\n',
    '      mapping = aes_string(\n',
    '        x = \'imagecol\',\n',
    '        y = \'imagerow\',\n',
    '        color = score,\n',
    '        # here we add iteractive aesthetics\n',
    '        tooltip = \'firm_lab\',\n',
    '        data_id = \'sampleID\'\n',
    '      )\n',
    '    )+bg + xlim(xrange) + ylim(rev(yrange)) + theme_classic() + theme(\n',
    '      axis.line = element_blank(),\n',
    '      axis.text = element_blank(),\n',
    '      axis.ticks = element_blank(),\n',
    '      axis.title = element_blank(),\n',
    '      legend.position = \'top\'\n',
    '    ) + geom_point_interactive(size = pt_size, alpha = pt.alpha) + scale_color_distiller(palette = \"Spectral\") + coord_fixed()\n',
    '    \n',
    '  }}else{{\n',
    '    cells <- sapply(strsplit(grep(pattern = \'^score_\', colnames(deconv),value = T),split = \'_\'),\'[[\',2)\n',
    '    cells <- cells[order(cells)]',
    '    # names(cells) <- col_box[1:length(grep(pattern = \'^score_\', colnames(deconv),value = T))]\n',
    '    gg_scatter <- ggplot(\n',
    '      data = deconv,\n',
    '      mapping = aes_string(\n',
    '        x = \'imagecol\',\n',
    '        y = \'imagerow\'\n',
    '      )\n',
    '    )+bg + xlim(xrange) + ylim(rev(yrange)) + theme_classic() + theme(\n',
    '      axis.line = element_blank(),\n',
    '      axis.text = element_blank(),\n',
    '      axis.ticks = element_blank(),\n',
    '      axis.title = element_blank(),\n',
    '      legend.position = \'top\',\n',
    '      legend.key.size = unit(2, \'mm\'),\n',
    '      legend.box.background = element_rect(fill = \'white\', colour = \'white\'),\n',
    '      legend.key = element_blank(), legend.text = element_text(size = 12)\n',
    '    ) + geom_scatterpie(\n',
    '      data = deconv,\n',
    '      aes(x = imagecol, y = imagerow),\n',
    '      cols = cells,pie_scale = pie_scale,color=NA\n',
    '    ) + coord_fixed()\n',
    '  }}\n',
    '  return(gg_scatter)\n',
    '}}\n\n',
    'cellpercentage <- function(deconv, cells){{\n',
    '  cell <-\n',
    '    sapply(strsplit(grep(\n',
    '      pattern = \'^score_\', colnames(deconv), value = T\n',
    '    ), split = \'_\'), \'[[\', 2)\n',
    '  \n',
    '  if(length(intersect(cells,deconv$sampleID)) > 0){{\n',
    '    dt <- deconv[which(deconv$sampleID %in% cells), cell, with = F] %>% colSums() %>% as.data.frame()\n',
    '  }}else{{\n',
    '    dt <- deconv[,cell,with = F] %>% colSums() %>% as.data.frame()\n',
    '  }}\n',
    '  \n',
    '  colnames(dt) <- \'num\'\n',
    '  dt$cell <- rownames(dt)\n',
    '  \n',
    '  dt <- dt %>% mutate(pct = round(100 * num / sum(num), 4))\n',
    '  dt$tooltip <- paste0(dt$cell, \': \', dt$pct)\n',
    '  \n',
    '  p <- ggplot(dt,aes(x = \'\',y = pct, fill = cell)) + \n',
    '    geom_col_interactive(data = dt,mapping = aes_string(tooltip = \'tooltip\')) + coord_polar(\'y\',start = 0) + theme_classic() + theme(\n',
    '      axis.line = element_blank(),\n',
    '      axis.text = element_blank(),\n',
    '      axis.ticks = element_blank(),\n',
    '      axis.title = element_blank(),\n',
    '      legend.position = \'top\',\n',
    '      legend.key.size = unit(2, \'mm\'),\n',
    '      legend.box.background = element_rect(fill = \'white\', colour = \'white\'),\n',
    '      legend.key = element_blank(), legend.text = element_text(size = 12)\n',
    '    )\n',
    '  return(p)\n',
    '}}\n\n',
    'deconvtab <- function(deconv, value, group, highlight = NULL) {{\n',
    '  if (length(intersect(highlight, deconv$sampleID)) > 0) {{\n',
    '    deconv <- deconv[which(deconv$sampleID %in% highlight), ]\n',
    '  }}\n',
    '  \n',
    '  scores <- paste0(\'score_\', value)\n',
    '  deconv_ex = deconv[, c(\'sampleID\', group, value, scores),\n',
    '                     with = FALSE]\n',
    '  \n',
    '  colnames(deconv_ex) <- c(\'sampleID\', \'groupby\', \'PCT\', \'score\')\n',
    '  df <- deconv_ex %>% group_by(groupby) %>%\n',
    '    mutate(mean_pct = mean(PCT)) %>% mutate(mean_score = mean(score)) %>% mutate(nspots = n()) %>%\n',
    '    dplyr::select(groupby, nspots , mean_pct, mean_score) %>% unique()\n',
    '  \n',
    '  colnames(df) <-\n',
    '    c(group,\n',
    '      \'nSpots\',\n',
    '      paste0(value, \'_mean_pct\'),\n',
    '      paste0(value, \'_mean_score\'))\n',
    '  \n',
    '  return(df)\n',
    '}}\n\n',
    
    'deconvdensity <- function(deconv, value, highlight = NULL, scores = \'score\'){{\n',
    '  if (length(intersect(highlight, deconv$sampleID)) > 0) {{\n',
    '    deconv <- deconv[which(deconv$sampleID %in% highlight), ]\n',
    '  }}\n',
    '  \n',
    '  if(scores == \'score\'){{\n',
    '    play <- paste0(\'score_\', value)\n',
    '  }}else{{\n',
    '    play <- value\n',
    '  }}\n',
    '  \n',
    '  deconv_ex <- deconv[,play,with = F]\n',
    '  deconv_ex <- melt(deconv_ex, measure.vars = play,variable.name = \'cell\', value.name =  \'x\')\n',
    '  deconv_ex <- deconv_ex[,.(cell,x,tooltip = NA),]\n',
    '  \n',
    '  \n',
    '  for(i in play){{\n',
    '    su <- summary(deconv_ex$x[which(deconv_ex$cell == i)])\n',
    '    tooltip <- paste(i,\'\\n\',\'Min.\',su[\'Min.\'],\'\\n\')\n',
    '    tooltip <- paste(tooltip,\'1st Qu.\',su[\'1st Qu.\'],\'\\n\')\n',
    '    tooltip <- paste(tooltip,\'Median\',su[\'Median\'],\'\\n\')\n',
    '    tooltip <- paste(tooltip,\'3rd Qu.\',su[\'3rd Qu.\'],\'\\n\')\n',
    '    tooltip <- paste(tooltip,\'Max.\',su[\'Max.\'],\'\\n\')\n',
    '    deconv_ex$tooltip[which(deconv_ex$cell == i)] <- tooltip\n',
    '  }}\n',
    '  \n',
    '  \n',
    '  p <- ggplot(deconv_ex,aes_string(tooltip = \'tooltip\')) + theme(\n',
    '    panel.grid = element_blank(),\n',
    '    axis.title = element_blank(),\n',
    '    axis.line = element_line(colour = \"black\"),\n',
    '    panel.background = element_rect(fill = \'white\', colour = NA),\n',
    '    axis.text = element_text(size = 15),\n',
    '    axis.text.x = element_text(\n',
    '      angle = 30,\n',
    '      hjust = 1,\n',
    '      vjust = 1\n',
    '    )\n',
    '  ) + geom_density_interactive(aes(x = x, fill = cell), alpha = 0.5)\n',
    '  \n',
    '  return(p)\n',
    '}}\n\n\n\n'
  )
  
  return(afun)
}

## server header
server_heads <- function(df_select) {
  server_head <- c(
    'server <- function(input, output, session) {\n',
    '  # prepared data\n',
    '  ## meta: spot information, cluster, highlight\n',
    '  add_meta <- shiny::reactiveValues(meta = meta)\n',
    '  meta_group_add <- shiny::reactiveValues(meta = meta_group)\n',
    '  ## session\n',
    '  optCrt = \"{ option_create: function(data,escape) {return(\'<div class=\\"create\\"><strong>\' + \'</strong></div>\');} }\"\n')
  server_head <- paste(server_head,collapse = '')
  
  if(length(df_select$cell) > 0){
    desc <- '  deconv <- shiny::reactiveValues(meta = deconvolusion)\n\n'
  }else{
    desc <- '  \n\n'
  }
  
  server_head <- paste0(server_head, '\n',desc)
  server_head <- glue::glue('{server_head}')
  
  
  slice_data <- c()
  for (i in 1:length(df_select$slice)) {
    on_sli <- glue::glue(
      'add_meta{i} <-reactive({{subset(add_meta$meta,add_meta$meta$slice_sample == unique(add_meta$meta$slice_sample)[{i}])}})\n',
      'range_slice{i} <- shiny::reactiveValues(range = df_select$ranges[[{i}]])\n',
      'image_slice{i} <- shiny::reactiveValues(images = image[[{i}]])\n\n'
    )
    slice_data <- paste(slice_data, on_sli, sep = '')
  }
  
  server_head <- paste('\n',server_head,'\n',slice_data,'\n\n')
  return(server_head)
}


## page1
sp_server_p1 <- function(df_select){
  sg <- c('## page1\n',
          '## gene select\n',
          'updateSelectizeInput(\n',
          '  session,\"gene\",choices = df_select$genes,\n',
          '  server = TRUE,selected = df_select$gene1,\n',
          '  options = list(maxOptions = 7,\n',
          '                 create = TRUE,persist = TRUE,\n',
          '                 render = I(optCrt)))\n\n')
  sg <- paste(sg,collapse = '')
  
  loadsp <- lapply(1:length(df_select$slice), function(x) {
    glue::glue(
      'sps{x} <-\n',
      '  add_meta$meta$sampleID[which(\n',
      '    add_meta$meta[[input$meta1_select]] %in% unique(c(input$bg_plot{x}_selected)) &\n',
      '      add_meta$meta[[\'slice_sample\']] %in% strsplit(meta_group_add$meta$unit[which(meta_group_add$meta$group == \'slice_sample\')], split = \'\\\\|\')[[1]][{x}]\n',
      '  )]\n\n'
    )
  })
  loadedsp <-
    loadsp %>% unlist() %>% paste0(collapse = '') %>% glue::glue()
  slsp <- paste('sps', 1:length(loadsp), sep = '', collapse = ',')
  bgsp <- lapply(1:length(df_select$slice), function(x){
    glue::glue("input$bg_plot{x}_selected")
  }) %>% unlist() %>% paste(collapse = ',')
  ftsp <- lapply(1:length(df_select$slice), function(x){
    glue::glue("input$feature{x}_selected")
  }) %>% unlist() %>% paste(collapse = ',')
  
  p1_gtab <- glue::glue(
    '### gene expression\n',
    'output$statis_gene <- renderDT({{\n',
    '  if (input$meta1_select %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '    {loadedsp}\n\n',
    '    sps <- c({slsp})\n',
    '  }} else {{sps <- unique(c({bgsp}))}}\n',
    '  DT::datatable(tab_exp_clu(inpsplt = input$splt,\n',
    '                            data = data,threshold = input$stat_thrd,\n',
    '                            meta = add_meta$meta,highlight = unique(c(sps,{ftsp})),\n',
    '                            gene = input$gene,\n',
    '                            group.by = input$meta1_select,genesets = genesets,\n',
    '                            meta_group = meta_group_add$meta),\n',
    '                rownames = FALSE,extensions = \"Buttons\",\n',
    '                options = list(dom = \"Bfrtip\",\n',
    '                               pageLength = 5,searching = TRUE,\n',
    '                               buttons = c(\"copy\", \"csv\", \"excel\", \'pdf\')))})\n'
  )
  
  p1slice <- lapply(1:length(df_select$slice), function(x){
    glue::glue(
      '  ## slice {x}\n',
      '  ### clusters order\n',
      '  shiny::observeEvent(input$reset1, {{\n',
      '    session$sendCustomMessage(type = \'bg_plot{x}_set\', message = character(0))\n',
      '    session$sendCustomMessage(type = \'feature{x}_set\', message = character(0))}})\n',
      '  ### backgroud plot\n',
      '  output$bg_plot{x} <- ggiraph::renderGirafe({{\n',
      '    sp <- spatial_dimplot(\n',
      '      meta_slice = add_meta{x}(),pt_size = input$point_size,\n',
      '      meta_group = meta_group_add$meta,\n',
      '      col.by = input$meta1_select,\n',
      '      input_image = image_slice{x}$images)\n',
      '    inter_spatial(gg_scatter = sp)}})\n',
      '  ### feature plot\n',
      '  output$feature{x} <- ggiraph::renderGirafe({{\n',
      '    sp <- fthighlightplot(meta_all = add_meta$meta,pt_size = input$point_size,\n',
      '      meta_slice = add_meta{x}(),\n',
      '      input_image = image_slice{x}$images,\n',
      '      gene = input$gene,\n',
      '      data = data,genesets = genesets)\n',
      '    inter_spatial(gg_scatter = sp)}})\n',
      '  \n',
      '  \n',
      '  ### dowload plot\n',
      '  output$bg_spot{x}.pdf <- downloadHandler(\n',
      '    filename = function() {{ paste0(\"group\",\"_\",input$meta1_select,\".pdf\") }},\n',
      '    content = function(file) {{\n',
      '     ggsave(file,device = \"pdf\",\n',
      '      height = input$bg_spot{x}.h,\n',
      '      width = input$bg_spot{x}.w,\n',
      '      plot = spatial_dimplot(\n',
      '        meta_slice = add_meta{x}(),\n',
      '        pt_size = input$point_size,\n',
      '        meta_group = meta_group_add$meta,\n',
      '        col.by = input$meta1_select,\n',
      '        input_image = image_slice{x}$images))}})\n',
      '  output$bg_spot{x}.png <- downloadHandler(\n',
      '    filename = function() {{paste0(\"group\", \"_\",input$meta1_select, \".png\")}},\n',
      '    content = function(file) {{\n',
      '      ggsave(file,device = \"png\",\n',
      '        height = input$bg_spot{x}.h,\n',
      '        width = input$bg_spot{x}.w,\n',
      '        plot = spatial_dimplot(\n',
      '          meta_slice = add_meta{x}(),\n',
      '          pt_size = input$point_size,\n',
      '          meta_group = meta_group_add$meta,\n',
      '          col.by = input$meta1_select,\n',
      '          input_image = image_slice{x}$images))}})\n',
      
      '  output$ft_spot{x}.pdf <- downloadHandler(\n',
      '    filename = function() {{paste0(input$meta1_select, \"_\",input$gene, {x},\".pdf\")}},\n',
      '    content = function(file) {{\n',
      '      if (input$meta1_select %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
      '        {loadedsp}\n\n',
      '        sps <- c({slsp})\n',
      '      }} else{{sps <- unique({bgsp})}}\n',
      '      \n',
      '      ggsave(file, device = \"pdf\", height = input$ft_spot{x}.h, width = input$ft_spot{x}.w, \n',
      '             plot = fthighlightplot(meta_all = add_meta$meta,pt_size = input$point_size,\n',
      '                                    meta_slice = add_meta{x}(),highlight = unique(c(sps,{bgsp})),\n',
      '                                    input_image = image_slice{x}$images,gene = input$gene,data = data,genesets = genesets))}})\n',
      '  output$ft_spot{x}.png <- downloadHandler(\n',
      '    filename = function() {{paste0(input$meta1_select, \"_\",input$gene, {x},\".png\")}},\n',
      '    content = function(file) {{\n',
      '      if (input$meta1_select %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
      '        {loadedsp}\n\n',
      '        sps <- c({slsp})\n',
      '      }} else{{sps <- unique({bgsp})}}\n',
      '      \n',
      '      ggsave(file, device = \"png\", height = input$ft_spot{x}.h, width = input$ft_spot{x}.w, \n',
      '             plot = fthighlightplot(meta_all = add_meta$meta,pt_size = input$point_size,\n',
      '                                    meta_slice = add_meta{x}(),highlight = unique(c(sps,{bgsp})),\n',
      '                                    input_image = image_slice{x}$images,gene = input$gene,data = data,genesets = genesets))}})\n\n'
      
    )
  }) %>% unlist() %>% paste(collapse = '\n')
  
  server_p1 <- glue::glue('\n','{sg}','{p1_gtab}','{p1slice}','\n\n')
  return(server_p1)
}


## page2
sp_server_p2 <- function(df_select){
  p2_gs <- c(
    '## page2 ############################################\n',
    'updateSelectizeInput(\n',
    '  session,\"gene_f1\",\n',
    '  choices = df_select$genes,\n',
    '  server = TRUE,\n',
    '  selected = df_select$gene1,\n',
    '  options = list(\n',
    '    maxOptions = 7,\n',
    '    create = TRUE,\n',
    '    persist = TRUE,\n',
    '    render = I(optCrt)))\n',
    'updateSelectizeInput(\n',
    '  session,\"gene_f2\",\n',
    '  choices = df_select$genes,\n',
    '  server = TRUE,\n',
    '  selected = df_select$gene2,\n',
    '  options = list(\n',
    '    maxOptions = 7,\n',
    '    create = TRUE,\n',
    '    persist = TRUE,\n',
    '    render = I(optCrt)))\n'
  )
  p2_gs <- paste(p2_gs,collapse = '')
  
  loadsp <- lapply(1:length(df_select$slice), function(x) {
    glue::glue(
      ' sps{x} <-\n',
      '   add_meta$meta$sampleID[which(\n',
      '     add_meta$meta[[input$meta2_select]] %in% unique(c(input$bg_plot_f{x}_selected)) &\n',
      '       add_meta$meta[[\'slice_sample\']] %in% strsplit(meta_group_add$meta$unit[which(meta_group_add$meta$group == \'slice_sample\')], split = \'\\\\|\')[[1]][{x}]\n',
      '   )]\n\n'
    )
  })
  loadedsp <-
    loadsp %>% unlist() %>% paste0(collapse = '') %>% glue::glue()
  slsp <- paste('sps', 1:length(loadsp), sep = '', collapse = ',')
  bgsp <- lapply(1:length(df_select$slice), function(x){
    glue::glue("input$bg_plot_f{x}_selected")
  }) %>% unlist() %>% paste(collapse = ',')
  cosp <- lapply(1:length(df_select$slice), function(x){
    glue::glue("input$coexpfeature{x}_selected")
  }) %>% unlist() %>% paste(collapse = ',')
  p2_gtab <- glue::glue(
    'output$coexp_leg <- renderPlot({{coexleg(gene1 = input$gene_f1,gene2 = input$gene_f2,inpcol = input$col_sel)}},height = 250)\n',
    'output$coexp_table <- renderDT({{\n',
    '  if (input$meta2_select %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '     {loadedsp}\n\n ',
    '    sps <- c({slsp})\n',
    '  }} else{{sps <- unique(c({bgsp}))}}\n',
    '  \n',
    '  \n',
    '  if(input$group_tab == \'No\'){{new_group <- NULL}}else{{new_group <- input$group_tab}}\n',
    '  new_tab <-coexp_tab(\n',
    '    tab_meta = add_meta$meta,\n',
    '    metagroup = meta_group_add$meta,\n',
    '    highlight = unique(c(sps,{cosp})),\n',
    '    data = data,\n',
    '    genesets = genesets,\n',
    '    gene1 = input$gene_f1,\n',
    '    gene2 = input$gene_f2,\n',
    '    threshold1 = input$thrd1,\n',
    '    threshold2 = input$thrd2,\n',
    '    new_group = new_group)\n',
    '  DT::datatable(new_tab,rownames = FALSE,extensions = \"Buttons\",\n',
    '                options = list(pageLength = 4,dom = \"Bfrtip\",searching = TRUE,buttons = c(\"copy\", \"csv\", \"excel\", \'pdf\')))}})\n'
  )
  
  p2slice <- lapply(1:length(df_select$slice), function(x){
    glue::glue(
      '## slice {x}\n',
      '### clusters order\n',
      'shiny::observeEvent(input$reset2, {{\n',
      '  session$sendCustomMessage(type = \'bg_plot_f{x}_set\', message = character(0))\n',
      '  session$sendCustomMessage(type = \'coexpfeature{x}_set\', message = character(0))}})\n',
      
      '### backgroud plot\n',
      'output$bg_plot_f{x} <- ggiraph::renderGirafe({{\n',
      '  sp <- spatial_dimplot(\n',
      '    meta_slice = add_meta{x}(),pt_size = input$point_size,\n',
      '    meta_group = meta_group_add$meta,\n',
      '    col.by = input$meta2_select,\n',
      '    input_image = image_slice{x}$images)\n',
      '  inter_spatial(gg_scatter = sp)}})\n',
      '### feature plot\n',
      'output$coexpfeature{x} <- ggiraph::renderGirafe({{\n',
      '  sp <- coexp_feature(\n',
      '    meta_slice = add_meta{x}(),\n',
      '    meta_all = add_meta$meta,\n',
      '    data = data,\n',
      '    gene1 = input$gene_f1,\n',
      '    gene2 = input$gene_f2,\n',
      '    input_image = image_slice{x}$images,pt_size = input$point_size,\n',
      '    genesets = genesets,threshold1 = input$thrd1,inpcol = input$col_sel,\n',
      '    threshold2 = input$thrd2)\n',
      '  inter_spatial(gg_scatter = sp)}})\n',
      '## dowload plot\n',
      'output$coexpfeature{x}.pdf <- downloadHandler(\n',
      '  filename = function() {{ paste0(input$gene_f1,\"_\",input$gene_f2,\"_\",{x},\".pdf\") }},\n',
      '  content = function(file) {{\n',
      '    if (input$meta2_select %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
      '        {loadedsp}\n\n',
      '      sps <- c({slsp})\n',
      '    }} else{{sps <- unique(c({bgsp}))}}\n',
      '    \n',
      '    ggsave(file, device = \"pdf\", height = input$coexpfeature{x}.h, width = input$coexpfeature{x}.w, \n',
      '           plot = coexp_feature(\n',
      '             meta_slice = add_meta{x}(),meta_all = add_meta$meta,\n',
      '             data = data,gene1 = input$gene_f1,highlight = c(sps,{bgsp}),\n',
      '             gene2 = input$gene_f2,input_image = image_slice{x}$images,pt_size = input$point_size,\n',
      '             genesets = genesets,threshold1 = input$thrd1,inpcol = input$col_sel,threshold2 = input$thrd2))}})\n',
      'output$coexpfeature{x}.png <- downloadHandler(\n',
      '  filename = function() {{paste0(input$gene_f1,\"_\",input$gene_f2,\"_\",{x},\".png\")}},\n',
      '  content = function(file) {{\n',
      '    if (input$meta2_select %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
      '        {loadedsp}\n\n',
      '      sps <- c({slsp})\n',
      '    }} else{{sps <- unique(c({bgsp}))}}\n',
      '    \n',
      '    ggsave(file, device = \"png\", height = input$coexpfeature{x}.h, width = input$coexpfeature{x}.w, \n',
      '           plot = coexp_feature(\n',
      '             meta_slice = add_meta{x}(),meta_all = add_meta$meta,\n',
      '             data = data,gene1 = input$gene_f1,highlight = c(sps,{bgsp}),\n',
      '             gene2 = input$gene_f2,input_image = image_slice{x}$images,pt_size = input$point_size,\n',
      '             genesets = genesets,threshold1 = input$thrd1,inpcol = input$col_sel,threshold2 = input$thrd2))}})\n'
    )
  }) %>% unlist() %>% paste(collapse = '\n')
  
  server_p2 <- glue::glue('\n','{p2_gs}','{p2_gtab}','{p2slice}','\n\n')
  return(server_p2)
}




## page3
sp_server_p3 <- function(df_select){
  p3_gs <- c(
    '## page3 ############################################\n',
    'updateSelectizeInput(\n',
    '  session,\"vio_y\",choices = names(genesets),\n',
    '  server = TRUE,selected = df_select$gene1,\n',
    '  options = list(maxOptions = 10,\n',
    '  create = TRUE,persist = TRUE,render = I(optCrt)))\n'
  )
  p3_gs <- paste(p3_gs,collapse = '')
  
  loadsp <- lapply(1:length(df_select$slice), function(x) {
    glue::glue(
      ' sps{x} <-\n',
      '   add_meta$meta$sampleID[which(\n',
      '     add_meta$meta[[input$subspot]] %in% unique(c(input$vb_bg_plot{x}_selected)) &\n',
      '       add_meta$meta[[\'slice_sample\']] %in% strsplit(meta_group_add$meta$unit[which(meta_group_add$meta$group == \'slice_sample\')], split = \'\\\\|\')[[1]][{x}]\n',
      '   )]\n\n'
    )
  })
  loadedsp <-
    loadsp %>% unlist() %>% paste0(collapse = '') %>% glue::glue()
  slsp <- paste('sps', 1:length(loadsp), sep = '', collapse = ',')
  bgsp <- lapply(1:length(df_select$slice), function(x){
    glue::glue("input$vb_bg_plot{x}_selected")
  }) %>% unlist() %>% paste(collapse = ',')
  
  p3_gtab <- glue::glue(
    'output$vb_plot <- ggiraph::renderGirafe({{\n',
    '  if (input$subspot %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '   {loadedsp}\n\n',
    '    sps <- c({slsp})\n',
    '  }} else{{sps <- unique(c({bgsp}))}}\n',
    '  \n',
    '  p <-\n',
    '    outvbplot(\n',
    '      x = input$vio_x,\n',
    '      y = input$vio_y,\n',
    '      genesets = genesets,\n',
    '      data = data,\n',
    '      meta_group = meta_group_add$meta,\n',
    '      meta = add_meta$meta,\n',
    '      groupby = input$vio_gb,\n',
    '      plot_type = input$plot_type,\n',
    '      pt_p = input$point_ex,\n',
    '      highlight = sps\n',
    '    )\n',
    '  inter_spatial(p)}})\n',
    '   output$vb_spot.pdf <- downloadHandler(\n',
    '     filename = function() {{ paste0(\"group\",\"_\",input$vio_x,\".pdf\") }},\n',
    '     content = function(file) {{\n',
    '       if (input$subspot %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '         {loadedsp}\n\n',
    '         sps <- c({slsp})\n',
    '       }} else{{sps <- unique(c({bgsp}))}}\n',
    '       ggsave( \n',
    '         file, device = \"pdf\", height = input$vb_spot.h, width = input$vb_spot.w, \n',
    '         plot = outvbplot(x = input$vio_x,y = input$vio_y,genesets = genesets,data = data,\n',
    '                          meta_group = meta_group_add$meta,meta = add_meta$meta,\n',
    '                          groupby = input$vio_gb,plot_type = input$plot_type,pt_p = input$point_ex,highlight = sps) )}})\n',
    
    '   output$vb_spot.png <- downloadHandler( \n',
    '     filename = function() {{ paste0(\"group\", \"_\", \".png\") }}, \n',
    '     content = function(file) {{ \n',
    '       if (input$subspot %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '         {loadedsp}\n\n',
    '         sps <- c({slsp})\n',
    '       }} else{{sps <- unique(c({bgsp}))}}\n',
    '       ggsave( \n',
    '         file, device = \"png\", height = input$vb_spot.h, width = input$vb_spot.w, \n',
    '         plot = outvbplot(x = input$vio_x,y = input$vio_y,genesets = genesets,data = data,\n',
    '                          meta_group = meta_group_add$meta,meta = add_meta$meta,\n',
    '                          groupby = input$vio_gb,plot_type = input$plot_type,pt_p = input$point_ex,highlight = sps) ) }})\n\n'
  )
  
  p3slice <- lapply(1:length(df_select$slice), function(x){
    glue::glue(
      ' ## slice {x}\n',
      ' ### clusters order\n',
      ' shiny::observeEvent(input$reset3, {{\n',
      '   session$sendCustomMessage(type = \'vb_bg_plot{x}_set\', message = character(0))})\n',
      ' \n',
      ' output$vb_bg_plot{x} <- ggiraph::renderGirafe({{\n',
      '   sp <- spatial_dimplot(\n',
      '     meta_slice = add_meta{x}(),pt_size = input$point_size,\n',
      '     meta_group = meta_group_add$meta,\n',
      '     col.by = input$subspot,\n',
      '     input_image = image_slice{x}$images\n',
      '   )\n',
      '   inter_spatial(gg_scatter = sp)}})\n'
    )
  }) %>% unlist() %>% paste(collapse = '\n')
  
  server_p3 <- glue::glue('\n','{p3_gs}','{p3_gtab}','{p3slice}','\n\n')
  return(server_p3)  
}

## page4
sp_server_p4 <- function(df_select){
  loadsp <- lapply(1:length(df_select$slice), function(x) {
    glue::glue(
      ' sps{x} <-\n',
      '   add_meta$meta$sampleID[which(\n',
      '     add_meta$meta[[input$subspot2]] %in% unique(c(input$por_bg_plot{x}_selected)) &\n',
      '       add_meta$meta[[\'slice_sample\']] %in% strsplit(meta_group_add$meta$unit[which(meta_group_add$meta$group == \'slice_sample\')], split = \'\\\\|\')[[1]][{x}]\n',
      '   )]\n\n'
    )
  })
  loadedsp <-
    loadsp %>% unlist() %>% paste0(collapse = '') %>% glue::glue()
  slsp <- paste('sps', 1:length(loadsp), sep = '', collapse = ',')
  bgsp <- lapply(1:length(df_select$slice), function(x){
    glue::glue("input$por_bg_plot{x}_selected")
  }) %>% unlist() %>% paste(collapse = ',')
  
  p4_gtab <- glue::glue(
    '  ## page4 ############################################\n',
    '  output$por_plot<- ggiraph::renderGirafe({{\n',
    '    if (input$subspot2 %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '       {loadedsp}\n\n',
    '      sps <- c({slsp})\n',
    '    }} else{{sps <- unique(c({bgsp}))}}\n',
    '    \n',
    '    \n',
    '    p <- outbarplot(meta_group = meta_group_add$meta,\n',
    '               meta = add_meta$meta,groupby = input$por_group,\n',
    '               x = input$por_x,highlight = sps,\n',
    '                 value = input$tab_type,xyflip = input$flipxy)\n',
    '         inter_spatial(p)}})\n',
    '  \n',
    '  output$bar_spot.pdf <- downloadHandler( \n',
    '    filename = function() {{ paste0(\"group\", \"_\",input$por_x, \".pdf\") }}, \n',
    '    content = function(file) {{ \n',
    '      if (input$subspot2 %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '        {loadedsp}\n\n',
    '        sps <- c({slsp})\n',
    '      }} else{{sps <- unique(c({bgsp}))}}\n',
    '      \n',
    '      ggsave( file, device = \"pdf\", height = input$bar_spot.h, width = input$bar_spot.w, \n',
    '      plot = outbarplot(meta_group = meta_group_add$meta,\n',
    '       meta = add_meta$meta,groupby = input$por_group,\n',
    '       x = input$por_x,highlight = sps,\n',
    '       value = input$tab_type,xyflip = input$flipxy) ) }})\n',
    '  output$bar_spot.png <- downloadHandler( \n',
    '    filename = function() {{ paste0(\"group\", \"_\",input$por_x, \".png\") }}, \n',
    '    content = function(file) {{\n',
    '      if (input$subspot2 %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '        {loadedsp}\n\n',
    '        sps <- c({slsp})\n',
    '      }} else{{sps <- unique(c({bgsp}))}}\n',
    '      \n',
    '      ggsave( file, device = \"png\", height = input$bar_spot.h, width = input$bar_spot.w, \n',
    '      plot = outbarplot(meta_group = meta_group_add$meta,\n',
    '       meta = add_meta$meta,groupby = input$por_group,\n',
    '       x = input$por_x,highlight = sps,\n',
    '       value = input$tab_type,xyflip = input$flipxy) ) }})\n\n'
    
  )
  
  p4slice <- lapply(1:length(df_select$slice), function(x){
    glue::glue(
      ' ## slice {x}\n',
      ' ### clusters order\n',
      ' shiny::observeEvent(input$reset4, {{\n',
      '   session$sendCustomMessage(type = \'por_bg_plot{x}_set\', message = character(0))})\n',
      ' \n',
      ' output$por_bg_plot{x} <- ggiraph::renderGirafe({{\n',
      '   sp <- spatial_dimplot(\n',
      '     meta_slice = add_meta{x}(),pt_size = input$point_size,\n',
      '     meta_group = meta_group_add$meta,\n',
      '     col.by = input$subspot2,\n',
      '     input_image = image_slice{x}$images\n',
      '   )\n',
      '   inter_spatial(gg_scatter = sp)}})\n'
    )
  }) %>% unlist() %>% paste(collapse = '\n')
  
  server_p4 <- glue::glue('\n','{p4_gtab}','{p4slice}','\n\n')
  return(server_p4)  
}

## page5
sp_server_p5 <- function(df_select){
  loadsp <- lapply(1:length(df_select$slice), function(x) {
    glue::glue(
      ' sps{x} <-\n',
      '   add_meta$meta$sampleID[which(\n',
      '     add_meta$meta[[input$subspot3]] %in% unique(c(input$exp_bg_plot{x}_selected)) &\n',
      '       add_meta$meta[[\'slice_sample\']] %in% strsplit(meta_group_add$meta$unit[which(meta_group_add$meta$group == \'slice_sample\')], split = \'\\\\|\')[[1]][{x}]\n',
      '   )]\n\n'
    )
  })
  loadedsp <-
    loadsp %>% unlist() %>% paste0(collapse = '') %>% glue::glue()
  slsp <- paste('sps', 1:length(loadsp), sep = '', collapse = ',')
  bgsp <- lapply(1:length(df_select$slice), function(x){
    glue::glue("input$exp_bg_plot{x}_selected")
  }) %>% unlist() %>% paste(collapse = ',')
  
  p5_gtab <- glue::glue(
    '## page5 ############################################\n',
    'output$exp_plot <- renderPlot({{\n',
    '  if (input$subspot3 %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '    {loadedsp}\n\n',
    '    sps <- c({slsp})\n',
    '  }} else{{sps <- unique(c({bgsp}))}}\n',
    '  dot_heat_plot(\n',
    '    genelists = input$inpgenelist,\n',
    '    genesets = genesets,\n',
    '    groupby = input$expgroup,scgroup = input$scgroup,\n',
    '    tab_meta = add_meta$meta,\n',
    '    plot_type = input$exp_plot_type,\n',
    '    inpRow = input$rclust,\n',
    '    inpCol = input$cclust,\n',
    '    data = data,scale_build = input$scl_exp,meta_group = meta_group_add$meta,highlight = sps\n',
    '  )\n',
    '}})\n',
    
    'output$heat_spot.pdf <- downloadHandler(\n',
    '  filename = function() {{paste0(\"group\", \"_\", input$expgroup, \".pdf\")}},\n',
    '  content = function(file) {{\n',
    '    if (input$subspot3 %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '      {loadedsp}\n\n',
    '      sps <- c({slsp})\n',
    '    }} else{{sps <- unique(c({bgsp}))}}\n',
    '    ggsave(file,device = \"pdf\",\n',
    '           height = input$heat_spot.h,\n',
    '           width = input$heat_spot.w,\n',
    '           plot = dot_heat_plot(\n',
    '             genelists = input$inpgenelist,\n',
    '             genesets = genesets,\n',
    '             groupby = input$expgroup,scgroup = input$scgroup,\n',
    '             tab_meta = add_meta$meta,\n',
    '             plot_type = input$exp_plot_type,\n',
    '             inpRow = input$rclust,\n',
    '             inpCol = input$cclust,\n',
    '             data = data,scale_build = input$scl_exp,meta_group = meta_group_add$meta,highlight = sps\n',
    '           ))}})\n',
    
    'output$heat_spot.png <- downloadHandler(\n',
    '  filename = function() {{paste0(\"group\", \"_\", input$expgroup, \".png\")}},\n',
    '  content = function(file) {{\n',
    '    if (input$subspot3 %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '      {loadedsp}\n\n',
    '      sps <- c({slsp})\n',
    '    }} else{{sps <- unique(c({bgsp}))}}\n',
    '    ggsave(file,device = \"png\",\n',
    '           height = input$heat_spot.h,\n',
    '           width = input$heat_spot.w,\n',
    '           plot = dot_heat_plot(\n',
    '             genelists = input$inpgenelist,\n',
    '             genesets = genesets,\n',
    '             groupby = input$expgroup,scgroup = input$scgroup,\n',
    '             tab_meta = add_meta$meta,\n',
    '             plot_type = input$exp_plot_type,\n',
    '             inpRow = input$rclust,\n',
    '             inpCol = input$cclust,\n',
    '             data = data,scale_build = input$scl_exp,meta_group = meta_group_add$meta,highlight = sps\n',
    '           ))}})\n\n'
  )
  
  p5slice <- lapply(1:length(df_select$slice), function(x){
    glue::glue(
      '## slice {x}\n',
      'shiny::observeEvent(input$reset5, {{\n',
      '  session$sendCustomMessage(type = \'exp_bg_plot{x}_set\', message = character(0))\n',
      '}})\n',
      'output$exp_bg_plot{x} <- ggiraph::renderGirafe({{\n',
      '  sp <- spatial_dimplot(\n',
      '    meta_slice = add_meta{x}(),\n',
      '    meta_group = meta_group_add$meta,\n',
      '    col.by = input$subspot3,\n',
      '    pt_size = input$point_size,\n',
      '    input_image = image_slice{x}$images\n',
      '  )\n',
      '  inter_spatial(sp)\n',
      '})\n'
      
    )
  }) %>% unlist() %>% paste(collapse = '\n')
  
  impinfo <- c(
    
    'observeEvent(input$swi_spinfo, {{\n',
    '  new_meta <- add_meta$meta\n',
    '  new_group <- meta_group_add$meta\n',
    '  new_col <- input$new_title\n',
    '  if (!is.null(input$impspifo)) {{\n',
    '    sps <- strsplit(input$impspifo, split = \"\n',
    '\")[[1]]\n',
    '    if (!is.null(new_col)) {{\n',
    '      if (length(sps) == nrow(add_meta$meta)) {{\n',
    '        sps[which(sps == \'\')] <- NA\n',
    '        new_meta[, new_col] <- NA\n',
    '        new_meta[[new_col]] <- sps\n',
    '        new_meta[[new_col]] <- as.factor(new_meta[[new_col]])\n',
    '        unit_n <-\n',
    '          paste(levels(new_meta[[new_col]]), collapse = \'\\\\|\')\n',
    '        cols <- col_box[1:length(levels(new_meta[[new_col]]))]\n',
    '        cols <- paste(cols, collapse = \'|\')\n',
    '        tmp <- data.table(group = new_col,unit = unit_n,color = cols,info = TRUE,default = 0)\n',
    '        new_group <-rbindlist(list(new_group, tmp))}}}}}}\n',
    '  add_meta$meta <- new_meta\n',
    '  meta_group_add$meta <- new_group}})\n\n'
    
  )
  
  impinfo <- paste(impinfo,collapse = '')
  
  server_p5 <- glue::glue('\n','{p5_gtab}','{p5slice}','\n','{impinfo}','\n\n')
  return(server_p5)
  
}


## page6
sp_server_p6 <- function(df_select){
  p6load <- lapply(1:length(df_select$slice), function(x){
    glue::glue('deconv{x} <- reactive({{subset(deconv$meta,deconv$meta$slice_sample == unique(deconv$meta$slice_sample)[{x}])}})\n')
  }) %>% unlist() %>% paste(collapse = '\n\n')  
  p6load <- paste('\n\n','## page6','\n\n',p6load,'\n\n')
  
  
  loadsp <- lapply(1:length(df_select$slice), function(x) {
    glue::glue(
      ' sps{x} <- deconv$meta$sampleID[which(\n',
      '    deconv$meta[[input$de_bg]] %in% unique(c(input$de_bg_spot{x}_selected)) &\n',
      '      deconv$meta[[\'slice_sample\']] %in% strsplit(meta_group_add$meta$unit[which(meta_group_add$meta$group == \'slice_sample\')], split = \'\\\\|\')[[1]][{x}]\n',
      '  )]\n\n'
    )
  })
  
  
  loadedsp <-
    loadsp %>% unlist() %>% paste0(collapse = '') %>% glue::glue()
  
  
  slsp <- paste('sps', 1:length(loadsp), sep = '', collapse = ',')
  bgsp <- lapply(1:length(df_select$slice), function(x){
    glue::glue("input$de_bg_spot{x}_selected")
  }) %>% unlist() %>% paste(collapse = ',')
  
  scsp <- lapply(1:length(df_select$slice), function(x){
    glue::glue("input$de_sco_spot{x}_selected")
  }) %>% unlist() %>% paste(collapse = ',')
  
  
  p6_tab <- glue::glue(
    'output$statis_deconv <- renderDT({{\n',
    '  if (input$de_bg %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '    {loadedsp}\n',
    '    sps <- c({slsp})\n',
    '  }} else{{\n',
    '    sps <-\n',
    '      unique(c({bgsp}))\n',
    '  }}\n',
    '  \n',
    '  cells <- unique(c(sps, {scsp}))\n',
    '  new_tab <- deconvtab(\n',
    '    deconv = deconv$meta,\n',
    '    value = input$celltyps,\n',
    '    group = input$de_bg,\n',
    '    highlight = cells)\n',
    '  DT::datatable(\n',
    '    new_tab,\n',
    '    rownames = FALSE,\n',
    '    extensions = \"Buttons\",\n',
    '    options = list(\n',
    '      pageLength = 4,\n',
    '      dom = \"Bfrtip\",\n',
    '      searching = TRUE,\n',
    '      buttons = c(\"copy\", \"csv\", \"excel\", \'pdf\')))\n',
    '}})\n\n'
  )
  
  
  p6_pie <- glue::glue(
    'output$de_pie_plot <- ggiraph::renderGirafe({{\n',
    '  if (input$de_bg %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '    {loadedsp}\n',
    '    sps <- c({slsp})\n',
    '  }} else{{\n',
    '    sps <-\n',
    '      unique(c({bgsp}))\n',
    '  }}\n',
    '  cells <- unique(c(sps, {scsp}))\n',
    '  p <- cellpercentage(deconv = deconv$meta,cells = cells)\n',
    '  inter_spatial(p)\n',
    '}})\n',
    'output$de_pie_plot.pdf <- downloadHandler(\n',
    '  filename = function() {{ paste0(\"group\",\"_\",input$de_bg,\".pdf\") }},\n',
    '  content = function(file) {{\n',
    '    if (input$de_bg %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '      {loadedsp}\n',
    '      sps <- c({slsp})\n',
    '    }} else{{\n',
    '      sps <-\n',
    '        unique(c({bgsp}))\n',
    '    }}\n',
    '    cells <- unique(c(sps, {scsp}))\n',
    '    ggsave(file,device = \"pdf\",\n',
    '           height = input$de_pie_plot.h,\n',
    '           width = input$de_pie_plot.w,\n',
    '           plot = cellpercentage(deconv = deconv$meta,cells = cells)\n',
    '    )}})\n',
    'output$de_pie_plot.png <- downloadHandler(\n',
    '  filename = function() {{paste0(\"group\", \"_\",input$de_bg, \".png\")}},\n',
    '  content = function(file) {{\n',
    '    if (input$de_bg %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '      {loadedsp}\n',
    '      sps <- c({slsp})\n',
    '    }} else{{\n',
    '      sps <-\n',
    '        unique(c({bgsp}))\n',
    '    }}\n',
    '    cells <- unique(c(sps, {scsp}))\n',
    '    \n',
    '    ggsave(file,device = \"png\",\n',
    '           height = input$de_pie_plot.h,\n',
    '           width = input$de_pie_plot.w,\n',
    '           plot = cellpercentage(deconv = deconv$meta,cells = cells)\n',
    '    )}})\n\n'
  )
  
  
  p6_vln <- glue::glue(
    '  output$de_vln_plot <- ggiraph::renderGirafe({{\n',
    '    if (input$de_bg %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '      {loadedsp}\n',
    '      sps <- c({slsp})\n',
    '    }} else{{\n',
    '      sps <-\n',
    '        unique(c({bgsp}))\n',
    '    }}\n',
    '    cells <- unique(c(sps, {scsp}))\n',
    '    p <- outvbplot(\n',
    '      x = input$de_bg,\n',
    '      y = input$celltyps,\n',
    '      ynames = \'cell score\',\n',
    '      meta_group = meta_group_add$meta,\n',
    '      meta = deconv$meta,\n',
    '      data = data,\n',
    '      genesets = genesets,highlight = cells\n',
    '    )\n',
    '    inter_spatial(p)\n',
    '  }})\n',
    '  output$de_vln_plot.pdf <- downloadHandler(\n',
    '    filename = function() {{ paste0(\"group\",\"_\",input$de_bg,\".pdf\") }},\n',
    '    content = function(file) {{\n',
    '      if (input$de_bg %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '        {loadedsp}\n',
    '        sps <- c({slsp})\n',
    '      }} else{{\n',
    '        sps <-\n',
    '          unique(c({bgsp}))\n',
    '      }}\n',
    '      cells <- unique(c(sps, {scsp}))\n',
    '      ggsave(file,device = \"pdf\",\n',
    '             height = input$de_vln_plot.h,\n',
    '             width = input$de_vln_plot.w,\n',
    '             plot = outvbplot(\n',
    '               x = input$de_bg,\n',
    '               y = input$celltyps,\n',
    '               ynames = \'cell score\',\n',
    '               meta_group = meta_group_add$meta,\n',
    '               meta = deconv$meta,\n',
    '               data = data,\n',
    '               genesets = genesets,highlight = cells\n',
    '             )\n',
    '      )}})\n',
    '  output$de_vln_plot.png <- downloadHandler(\n',
    '    filename = function() {{paste0(\"group\", \"_\",input$de_bg, \".png\")}},\n',
    '    content = function(file) {{\n',
    '      if (input$de_bg %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '        {loadedsp}\n',
    '        sps <- c({slsp})\n',
    '      }} else{{\n',
    '        sps <-\n',
    '          unique(c({bgsp}))\n',
    '      }}\n',
    '      cells <- unique(c(sps, {scsp}))\n',
    '      ggsave(file,device = \"png\",\n',
    '             height = input$de_vln_plot.h,\n',
    '             width = input$de_vln_plot.w,\n',
    '             plot = outvbplot(\n',
    '               x = input$de_bg,\n',
    '               y = input$celltyps,\n',
    '               ynames = \'cell score\',\n',
    '               meta_group = meta_group_add$meta,\n',
    '               meta = deconv$meta,\n',
    '               data = data,\n',
    '               genesets = genesets,highlight = cells\n',
    '             )\n',
    '      )}})\n\n'
  )
  
  
  p6_den <- glue::glue(
    '  output$de_den_plot <- ggiraph::renderGirafe({{\n',
    '    if (input$de_bg %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '      {loadedsp}\n',
    '      sps <- c({slsp})\n',
    '    }} else{{\n',
    '      sps <-\n',
    '        unique(c(bgsp))\n',
    '    }}\n',
    '    cells <- unique(c(sps, {scsp}))\n',
    '    p <- deconvdensity(deconv = deconv$meta,value = input$celltyps, highlight = cells)\n',
    '    inter_spatial(p)\n',
    '  }})\n',
    '  output$de_den_plot.pdf <- downloadHandler(\n',
    '    filename = function() {{ paste0(\"group\",\"_\",input$meta1_select,\".pdf\") }},\n',
    '    content = function(file) {{\n',
    '      if (input$de_bg %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '        {loadedsp}\n',
    '        sps <- c({slsp})\n',
    '      }} else{{\n',
    '        sps <-\n',
    '          unique(c(bgsp))\n',
    '      }}\n',
    '      cells <- unique(c(sps, {scsp}))\n',
    '      \n',
    '      ggsave(file,device = \"pdf\",\n',
    '             height = input$de_den_plot.h,\n',
    '             width = input$de_den_plot.w,\n',
    '             plot = deconvdensity(deconv = deconv$meta,value = input$celltyps, highlight = cells)\n',
    '      )}})\n',
    '  output$de_den_plot.png <- downloadHandler(\n',
    '    filename = function() {{paste0(\"group\", \"_\",input$meta1_select, \".png\")}},\n',
    '    content = function(file) {{\n',
    '      if (input$de_bg %in% meta_group_add$meta[meta_group_add$meta$info == T, group]) {{\n',
    '        {loadedsp}\n',
    '        sps <- c({slsp})\n',
    '      }} else{{\n',
    '        sps <-\n',
    '          unique(c(bgsp))\n',
    '      }}\n',
    '      cells <- unique(c(sps, {scsp}))\n',
    '      \n',
    '      ggsave(file,device = \"png\",\n',
    '             height = input$de_den_plot.h,\n',
    '             width = input$de_den_plot.w,\n',
    '             plot = deconvdensity(deconv = deconv$meta,value = input$celltyps, highlight = cells)\n',
    '      )}})\n\n'
  )
  
  
  p6slice <- lapply(1:length(df_select$slice), function(k){
    glue::glue(
      '## slice {k}\n',
      'shiny::observeEvent(input$reset6, {{\n',
      '  session$sendCustomMessage(type = \'de_sco_spot{k}_set\', message = character(0))\n',
      '  session$sendCustomMessage(type = \'de_bg_spot{k}_set\', message = character(0))}})\n',
      
      'output$de_bg_spot{k} <- ggiraph::renderGirafe({{\n',
      '  sp <- spatial_dimplot(\n',
      '    meta_slice = add_meta{k}(),pt_size = input$point_size,\n',
      '    meta_group = meta_group_add$meta,\n',
      '    col.by = input$de_bg,\n',
      '    input_image = image_slice{k}$images)\n',
      '  inter_spatial(gg_scatter = sp)\n',
      '}})\n',
      
      'output$de_pct_spot{k} <- renderPlot({{\n',
      '  spatialdwls(input_image = image_slice{k}$images, deconv = deconv{k}(), pie_scale = 0.5)\n',
      '}})\n',
      'output$de_pct_spot{k}.pdf <- downloadHandler(\n',
      '  filename = function() {{ paste0(\"cellcomponent{k}\",\".pdf\") }},\n',
      '  content = function(file) {{\n',
      '    ggsave(file,device = \"pdf\",\n',
      '           height = input$de_pct_spot{k}.h,\n',
      '           width = input$de_pct_spot{k}.w,\n',
      '           plot = spatialdwls(input_image = image_slice{k}$images, deconv = deconv{k}(), pie_scale = 0.5)\n',
      '    )}})\n',
      'output$de_pct_spot{k}.png <- downloadHandler(\n',
      '  filename = function() {{paste0(\"cellcomponent{k}\",\".png\")}},\n',
      '  content = function(file) {{\n',
      '    ggsave(file,device = \"png\",\n',
      '           height = input$de_pct_spot{k}.h,\n',
      '           width = input$de_pct_spot{k}.w,\n',
      '           plot = spatialdwls(input_image = image_slice{k}$images, deconv = deconv{k}(), pie_scale = 0.5)\n',
      '    )}})\n',
      'output$de_sco_spot{k} <- ggiraph::renderGirafe({{\n',
      '  p <- spatialdwls(input_image = image_slice{k}$images, deconv = deconv{k}(),score = input$celltyps,pt_size = input$point_size)\n',
      '  inter_spatial(p)\n',
      '}})\n',
      'output$de_sco_spot{k}.pdf <- downloadHandler(\n',
      '  filename = function() {{ paste0(\"group\",\"_\",input$celltyps,\".pdf\") }},\n',
      '  content = function(file) {{\n',
      '    ggsave(file,device = \"pdf\",\n',
      '           height = input$de_sco_spot{k}.h,\n',
      '           width = input$de_sco_spot{k}.w,\n',
      '           plot = spatialdwls(input_image = image_slice{k}$images, deconv = deconv{k}(),score = input$celltyps,pt_size = input$point_size)\n',
      '    )}})\n',
      'output$de_sco_spot{k}.png <- downloadHandler(\n',
      '  filename = function() {{paste0(\"group\", \"_\",input$celltyps, \".png\")}},\n',
      '  content = function(file) {{\n',
      '    ggsave(file,device = \"png\",\n',
      '           height = input$de_sco_spot{k}.h,\n',
      '           width = input$de_sco_spot{k}.w,\n',
      '           plot = spatialdwls(input_image = image_slice{k}$images, deconv = deconv{k}(),score = input$celltyps,pt_size = input$point_size)\n',
      '    )}})\n\n\n'
    )
  }) %>% unlist() %>% paste(collapse = '\n')
  
  
  
  server_p6 <- glue::glue('\n','{p6load}','{p6_tab}','{p6_pie}','{p6_vln}','{p6_den}','{p6slice}','}','\n\n')
  return(server_p6)
}

